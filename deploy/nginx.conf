# /etc/nginx/conf.d/default.conf

gzip on;
gzip_types text/css application/javascript application/json text/plain;

# Docker DNS für Service-Namen
resolver 127.0.0.11 ipv6=off valid=10s;
resolver_timeout 5s;

server {
    listen 80;
    server_name _;

    # Dein Backend-Container (Service-Name "web" → Port 5000)
    set $backend http://web:5000;

    # Optional: größere Uploads erlauben
    client_max_body_size 25m;

    # Healthcheck
    location = /healthz {
        default_type text/plain;
        return 200 "ok\n";
    }

    # Statische Dateien (falls vom Backend bedient)
    location /static/ {
        proxy_pass $backend;
        expires 7d;
        add_header Cache-Control "public";
    }

    location / {
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host               $host;
        proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto  $scheme;

        # Timeouts etwas großzügiger
        proxy_read_timeout 300s;
        proxy_send_timeout 300s;

        # Security-Header (für HTTP ok; HSTS nur auf 443 setzen)
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-Frame-Options "DENY" always;
        add_header X-XSS-Protection "1; mode=block" always;

        proxy_pass $backend;
    }

    # 502-Seite (optional)
    error_page 502 /502.html;
    location = /502.html { return 502 "Bad Gateway\n"; }
}
