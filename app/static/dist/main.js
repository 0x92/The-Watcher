function Ee(){const e=window.cytoscape;if(!e){console.warn("Cytoscape not available � skipping graph init");return}const n=document.getElementById("graph-filters"),u=document.getElementById("graph"),s=document.querySelector("#graph-summary .status-message"),v=document.querySelector("#graph-summary .graph-stats"),g=document.getElementById("graph-refresh"),m=document.getElementById("graph-reload"),l=document.getElementById("graph-export-png"),b=document.getElementById("graph-export-json");if(!n||!u||!s||!v)return;let w=d(u),i=null,x=null,S=!1;function d(f){return e({container:f,wheelSensitivity:.2,maxZoom:3,minZoom:.2,style:[{selector:"node",style:{label:"data(label)","text-valign":"center","text-halign":"center","font-size":"12px","text-wrap":"wrap","text-max-width":"120px",color:"#0f172a","background-color":"#2563eb",width:"mapData(value, 0, 50, 24, 96)",height:"mapData(value, 0, 50, 24, 96)","border-width":2,"border-color":"#1e293b"}},{selector:"node[kind = 'tag']",style:{"background-color":"#22c55e","border-color":"#166534"}},{selector:"node[kind = 'alert']",style:{"background-color":"#f97316","border-color":"#c2410c"}},{selector:"node:selected",style:{"border-width":4,"border-color":"#0ea5e9","shadow-blur":16,"shadow-color":"#38bdf8","shadow-opacity":.6}},{selector:"edge",style:{width:"mapData(weight, 0, 20, 1, 6)","line-color":"#94a3b8","curve-style":"bezier","target-arrow-shape":"triangle","target-arrow-color":"#94a3b8",opacity:.8}},{selector:"edge[kind = 'source_tag']",style:{"line-color":"#38bdf8","target-arrow-color":"#38bdf8"}},{selector:"edge[kind = 'source_alert']",style:{"line-color":"#facc15","target-arrow-color":"#facc15"}}]})}function h(){const f=new FormData(n),y=[];n.querySelectorAll("input[name='role']").forEach(E=>{E.checked&&y.push(E.value)});const k=Math.max(1,Math.min(Number(f.get("limit"))||50,200));return{window:f.get("window")||"24h",limit:k,roles:y,refresh:Number(f.get("refresh"))||0}}function N(f){const y=new URLSearchParams;return f.window&&y.set("window",f.window),y.set("limit",String(f.limit)),f.roles.forEach(k=>y.append("role",k)),y.toString()}function q(f,y){s.dataset.state=f,s.textContent=y}function T(f){const y=new Date,k={nodes:f.nodes.length,edges:f.edges.length,sources:f.nodes.filter(E=>E.kind==="source").length,tags:f.nodes.filter(E=>E.kind==="tag").length,alerts:f.nodes.filter(E=>E.kind==="alert").length};v.innerHTML=`
      <div><strong>Knoten:</strong> ${k.nodes}</div>
      <div><strong>Kanten:</strong> ${k.edges}</div>
      <div><strong>Quellen:</strong> ${k.sources}</div>
      <div><strong>Tags:</strong> ${k.tags}</div>
      <div><strong>Alerts:</strong> ${k.alerts}</div>
      <div><small>Stand: ${y.toLocaleTimeString()}</small></div>
    `}async function _(){if(S)return;const f=h();q("loading","Lade Graph..."),S=!0;try{const y=N(f),k=await fetch(`/api/graph?${y}`,{cache:"no-store",headers:{Accept:"application/json"}});if(!k.ok)throw new Error(`Server antwortete mit ${k.status}`);const E=await k.json();x=E,A(E),T(E),q("idle","Aktualisiert.")}catch(y){console.error("Graph fetch failed",y),q("error",y&&y.message?y.message:"Unbekannter Fehler")}finally{S=!1}}function A(f){const y=[];f.nodes.forEach(E=>{y.push({data:{id:E.id,label:E.label,kind:E.kind,value:E.value,meta:E.meta||{}}})}),f.edges.forEach(E=>{y.push({data:{id:`${E.source}->${E.target}:${E.kind}`,source:E.source,target:E.target,weight:E.weight,kind:E.kind,meta:E.meta||{}}})}),w.elements().remove(),w.add(y),w.layout({name:"cose",animate:!1,padding:30,fit:!0,randomize:y.length>150}).run()}function I(f){i&&(clearInterval(i),i=null),f>0&&(i=setInterval(()=>{document.hidden||_()},f*1e3))}function j(){const f=h();I(f.refresh)}function a(f,y){const k=document.createElement("a");k.href=y,k.download=f,document.body.appendChild(k),k.click(),document.body.removeChild(k)}function p(){if(!w)return;const f=w.png({scale:2,bg:"#ffffff"});a(`graph-${Date.now()}.png`,f)}function D(){if(!x){q("error","Keine Daten zum Exportieren verfuegbar.");return}const f=new Blob([JSON.stringify(x,null,2)],{type:"application/json"}),y=URL.createObjectURL(f);a(`graph-${Date.now()}.json`,y),setTimeout(()=>URL.revokeObjectURL(y),1e3)}function L(){n.addEventListener("change",f=>{const y=f.target;(y.matches("input[name='role']")||y.matches("select[name='window']")||y.matches("input[name='limit']"))&&_(),y===g&&j()}),m==null||m.addEventListener("click",()=>{_()}),l==null||l.addEventListener("click",()=>{p()}),b==null||b.addEventListener("click",()=>{D()}),w.on("tap","node",f=>{const y=f.target.data(),k=`${y.label} (${y.kind}) - Wert ${y.value}`;q("info",k)}),document.addEventListener("visibilitychange",()=>{document.hidden?i&&(clearInterval(i),i=null):(j(),_())})}L(),j(),_()}function Ae(){const e=document.getElementById("patterns-filters"),n=document.getElementById("patterns-list"),u=document.querySelector("#patterns-container .status-message"),s=document.getElementById("patterns-reload");if(!e||!n||!u||!s)return;function v(w,i){u.dataset.state=w,u.textContent=i}function g(){const w=new FormData(e),i=w.get("window")||"24h",x=Math.max(1,Math.min(Number(w.get("limit"))||10,50));return{window:i,limit:x}}function m(w){const i=new URLSearchParams;return i.set("window",w.window),i.set("limit",String(w.limit)),i.toString()}function l(w){if(n.innerHTML="",!w.length){const i=document.createElement("p");i.className="empty-state",i.textContent="Keine Muster gefunden.",n.appendChild(i);return}w.forEach(i=>{var _,A,I;const x=document.createElement("article");x.className="pattern-card";const S=document.createElement("h2");S.textContent=i.label||"Unbenanntes Muster",x.appendChild(S);const d=document.createElement("p");d.className="pattern-meta";const h=new Date(i.created_at),N=typeof i.anomaly_score=="number"?i.anomaly_score.toFixed(3):"-",q=((_=i.meta)==null?void 0:_.size)??((A=i.item_ids)==null?void 0:A.length)??0;d.textContent=`Anomalie-Score: ${N} � Gr��e: ${q} � ${h.toLocaleString()}`,x.appendChild(d);const T=document.createElement("ul");if(T.className="pattern-terms",(i.top_terms||[]).forEach(j=>{const a=document.createElement("li");a.textContent=j,T.appendChild(a)}),x.appendChild(T),(I=i.item_ids)!=null&&I.length){const j=document.createElement("p");j.className="pattern-items",j.textContent=`Beobachtete Items: ${i.item_ids.join(", ")}`,x.appendChild(j)}n.appendChild(x)})}async function b(){var i,x;const w=g();v("loading","Lade Muster...");try{const S=m(w),d=await fetch(`/api/patterns/latest?${S}`,{cache:"no-store",headers:{Accept:"application/json"}});if(!d.ok)throw new Error(`Server antwortete mit ${d.status}`);const h=await d.json();l(h.patterns||[]);const N=((i=h.meta)==null?void 0:i.count)??((x=h.patterns)==null?void 0:x.length)??0;v("idle",`Aktualisiert (${N}).`)}catch(S){console.error("Pattern fetch failed",S),v("error",S&&S.message?S.message:"Unbekannter Fehler")}}e.addEventListener("change",w=>{(w.target.matches("select[name='window']")||w.target.matches("input[name='limit']"))&&b()}),s.addEventListener("click",()=>{b()}),b()}function Le(){var I,j;const e=document.getElementById("heatmap-filters"),n=document.getElementById("heatmap-chart"),u=document.getElementById("timeline-chart"),s=document.querySelector("#heatmap-dashboard .status-message"),v=document.querySelector("#heatmap-meta .heatmap-stats"),g=document.getElementById("heatmap-reload");if(!e||!n||!u||!s||!v||!g)return;const m=(I=window.echarts)==null?void 0:I.init(n),l=(j=window.echarts)==null?void 0:j.init(u);if(!m||!l){console.warn("ECharts not available � skipping heatmap init");return}let b=null;function w(a,p){s.dataset.state=a,s.textContent=p}function i(){const a=new FormData(e),p=a.get("interval")||"24h",D=Math.max(0,Number(a.get("value_min"))||0),L=Number(a.get("refresh"))||0,f=(a.get("sources")||"").split(",").map(y=>y.trim()).filter(Boolean);return{interval:p,valueMin:D,refresh:L,sources:f}}function x(a){const p=new URLSearchParams;return p.set("interval",a.interval),p.set("value_min",String(a.valueMin)),a.sources.length&&p.set("sources",a.sources.join(",")),p}function S(a){const p=[["Buckets",a.bucket_count??"-"],["Bucket-Minuten",a.bucket_minutes??"-"],["Items",a.item_count??0],["Alerts",a.event_count??0]];a.source_totals&&Object.entries(a.source_totals).slice(0,8).forEach(([D,L])=>p.push([D,L])),v.innerHTML=p.map(([D,L])=>`<dt>${D}</dt><dd>${L}</dd>`).join("")}function d(a){const p=a.buckets||[],D=a.series?a.series.map(k=>k.source):[];if(!p.length||!D.length){m.clear(),m.setOption({title:{text:"Keine Daten im ausgew�hlten Zeitraum",left:"center",textStyle:{color:"#64748b"}}});return}const L=p.map(k=>new Date(k).toLocaleString()),f=[];let y=0;a.series.forEach((k,E)=>{k.counts.forEach((W,Y)=>{f.push([Y,E,W]),W>y&&(y=W)})}),m.setOption({tooltip:{position:"top",formatter:k=>{const E=k.data[2];return E?`${D[k.data[1]]}<br>${L[k.data[0]]}<br>Events: ${E}`:"Keine Ereignisse"}},grid:{left:90,right:20,top:20,bottom:60},xAxis:{type:"category",data:L,axisLabel:{rotate:-45,color:"#475569"}},yAxis:{type:"category",data:D,axisLabel:{color:"#475569"}},visualMap:{min:0,max:Math.max(1,y),calculable:!0,orient:"horizontal",left:"center",bottom:10},series:[{name:"Events",type:"heatmap",data:f,label:{show:!0,color:"#0f172a",formatter:k=>k.data[2]?String(k.data[2]):""},emphasis:{itemStyle:{shadowBlur:10,shadowColor:"rgba(0, 0, 0, 0.5)"}}}]})}function h(a){const p=(a.timeline||[]).map(L=>({value:[L.at,L.severity||0],alert:L.alert,severity:L.severity||0}));if(!p.length){l.clear(),l.setOption({title:{text:"Keine Alerts",left:"center",textStyle:{color:"#64748b"}}});return}const D=Math.max(...p.map(L=>L.severity),1);l.setOption({tooltip:{trigger:"item",formatter:L=>{const f=new Date(L.value[0]);return`${L.data.alert}<br>${f.toLocaleString()}<br>Severity: ${L.data.severity}`}},xAxis:{type:"time",axisLabel:{color:"#475569"}},yAxis:{type:"value",min:0,max:Math.max(D,1),axisLabel:{show:!1},splitLine:{show:!1}},series:[{type:"scatter",data:p,symbolSize:L=>10+(L[1]||0)*4,itemStyle:{color:"#f97316"}}]})}function N(a){var p;d(a),h(a),S(a.meta||{}),w("idle",`Aktualisiert (${((p=a.meta)==null?void 0:p.item_count)??0} Items)`)}async function q(){const a=i(),p=x(a);w("loading","Lade Daten...");const D=await fetch(`/api/analytics/heatmap?${p.toString()}`,{cache:"no-store",headers:{Accept:"application/json"}});if(!D.ok)throw new Error(`Server antwortete mit ${D.status}`);const L=await D.json();return N(L),a}function T(){b&&(b.close(),b=null)}function _(a){if(T(),!a.refresh)return;const p=x(a);p.set("refresh",String(a.refresh)),b=new EventSource(`/stream/analytics/heatmap?${p.toString()}`),b.onmessage=D=>{try{const L=JSON.parse(D.data);if(L.error){w("error",L.error);return}N(L)}catch(L){console.error("SSE parse failed",L)}},b.onerror=()=>{w("error","Stream unterbrochen"),T()}}function A(){q().then(a=>{_(a)}).catch(a=>{console.error("Heatmap fetch failed",a),w("error",a.message||"Unbekannter Fehler")})}e.addEventListener("change",a=>{(a.target.matches("select[name='interval']")||a.target.matches("input[name='value_min']")||a.target.matches("select[name='refresh']")||a.target.matches("input[name='sources']"))&&A()}),g.addEventListener("click",()=>{A()}),window.addEventListener("beforeunload",()=>{T()}),A()}function Ne(){const e=document.querySelector("[data-overview-status]"),n=document.querySelector("[data-overview]");if(!e||!n)return;const u=S=>n.querySelector(`[data-metric="${S}"]`),s=document.querySelector("[data-overview-alerts]"),v=document.querySelector("[data-overview-patterns]");function g(S,d){e.dataset.state=S,e.textContent=d}async function m(S){const d=await fetch(S,{cache:"no-store",headers:{Accept:"application/json"}});if(!d.ok)throw new Error(`Request ${S} fehlgeschlagen (${d.status})`);return d.json()}function l(S,d){const h=u(S);h&&(h.textContent=d)}function b(S){if(s){if(!S.length){s.innerHTML="<li>Keine Alerts im Zeitraum.</li>";return}s.innerHTML=S.slice(-5).reverse().map(d=>{const h=new Date(d.at).toLocaleString(),N=d.severity!=null?`<span class="badge">S${d.severity}</span>`:"";return`<li><div>${d.alert} ${N}</div><small>${h}</small></li>`}).join("")}}function w(S){if(v){if(!S.length){v.innerHTML="<li>Keine Muster gefunden.</li>";return}v.innerHTML=S.slice(0,5).map(d=>{const h=d.anomaly_score!=null?d.anomaly_score.toFixed(3):"-";return`<li><div>${d.label||"Muster"}</div><small>Score ${h}</small></li>`}).join("")}}async function i(){var S,d;try{g("loading","Aktualisiere �bersicht...");const[h,N,q]=await Promise.all([m("/api/graph?limit=100&window=24h"),m("/api/analytics/heatmap?interval=24h&value_min=0"),m("/api/patterns/latest?window=24h&limit=10")]),T=new Set((h.nodes||[]).filter(A=>A.kind==="source").map(A=>A.id)).size;l("sources",T||0),l("items",((S=N.meta)==null?void 0:S.item_count)??0),l("alerts",((d=N.meta)==null?void 0:d.event_count)??0);const _=(q.patterns||[])[0];l("pattern-score",_&&_.anomaly_score!=null?_.anomaly_score.toFixed(3):"-"),b(N.timeline||[]),w(q.patterns||[]),g("idle","Live-Daten synchronisiert.")}catch(h){console.error("overview load failed",h),g("error",h.message||"�bersicht konnte nicht geladen werden.")}}i();const x=setInterval(i,6e4);window.addEventListener("beforeunload",()=>clearInterval(x))}const ce="/api/admin/worker-settings",de="/api/admin/gematria-settings",ue="/api/admin/workers",Z="/api/admin/sources";function C(e,n,u="idle"){e&&(e.textContent=n,e.dataset.state=u,e.hidden=!n)}function re(e){const n=Number.parseInt(e,10);return Number.isNaN(n)?void 0:n}function M(e){return e==null?"":String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function se(e){if(!e)return"Stand: –";const n=new Date(e);return Number.isNaN(n.getTime())?"Stand: –":`Stand: ${n.toLocaleString()}`}function V(e){if(!e)return"–";const n=new Date(e);return Number.isNaN(n.getTime())?"–":n.toLocaleString()}function me(e,n){if(!Array.isArray(n)||n.length===0)return`<div class="worker-task-group"><h3>${e}</h3><p class="worker-task-empty">Keine Einträge.</p></div>`;const u=n.map(s=>{const v=M(s.name||"Unbekannte Aufgabe"),g=s.id?` <span class="worker-task-id">#${M(s.id)}</span>`:"",m=[];s.eta&&m.push(`ETA ${M(s.eta)}`),s.queue&&m.push(`Queue ${M(s.queue)}`),typeof s.runtime=="number"&&!Number.isNaN(s.runtime)&&m.push(`${s.runtime.toFixed(1)}s`);const l=m.length?`<div class="worker-task-meta">${m.join(" • ")}</div>`:"",b=[];s.args&&b.push(`<code>${M(s.args)}</code>`),s.kwargs&&s.kwargs!=="{}"&&b.push(`<code>${M(s.kwargs)}</code>`);const w=b.length?`<div class="worker-task-payload">${b.join(" ")}</div>`:"";return`<li><div class="worker-task-head">${v}${g}</div>${l}${w}</li>`}).join("");return`<div class="worker-task-group"><h3>${e}</h3><ul class="worker-task-list">${u}</ul></div>`}function Ce(){const e=document.querySelector("[data-worker-form]"),n=document.querySelector("[data-worker-status]"),u=document.querySelector("[data-worker-overview-status]"),s=document.querySelector("[data-workers-list]"),v=document.querySelector("[data-worker-updated]"),g=document.querySelector("[data-worker-refresh]"),m=document.querySelector("[data-source-form]"),l=document.querySelector("[data-source-status]"),b=document.querySelector("[data-sources-list]"),w=document.querySelector("[data-source-stats]"),i=document.querySelector("[data-source-filter-form]"),x=document.querySelector("[data-source-filter-reset]"),S=document.querySelector("[data-source-refresh]"),d=document.querySelector("[data-gematria-form]"),h=document.querySelector("[data-gematria-status]"),N=document.querySelector("[data-gematria-list]"),q=document.querySelector("[data-gematria-select-all]"),T=document.querySelector("[data-gematria-reset]");if(!e&&!m&&!b&&!s&&!i&&!w&&!d)return;let _=[],A=[],I={updatedAt:null,status:"idle",message:""},j={meta:{},filters:{}},a={query:"",type:"all",status:"all"},p={available:[],enabled:[],defaults:{enabled:[],ignore_pattern:""}};async function D(){if(e){C(n,"Lade Einstellungen…","loading");try{const r=await fetch(ce,{credentials:"same-origin"});if(!r.ok)throw new Error(`Serverfehler (${r.status})`);const c=await r.json();e.elements.scrape_enabled.checked=!!c.scrape_enabled,e.elements.default_interval_minutes.value=c.default_interval_minutes??15,e.elements.max_sources_per_cycle.value=c.max_sources_per_cycle??0,m&&m.elements.interval_minutes.value===""&&(m.elements.interval_minutes.placeholder=c.default_interval_minutes??""),C(n,"","idle")}catch(r){C(n,r.message||"Einstellungen konnten nicht geladen werden","error")}}}async function L(r){if(r.preventDefault(),!e)return;C(n,"Speichere…","loading");const c={scrape_enabled:e.elements.scrape_enabled.checked,default_interval_minutes:re(e.elements.default_interval_minutes.value),max_sources_per_cycle:re(e.elements.max_sources_per_cycle.value)};try{const t=await fetch(ce,{method:"PUT",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify(c)});if(!t.ok)throw new Error(`Serverfehler (${t.status})`);await t.json(),C(n,"Einstellungen gespeichert","success")}catch(t){C(n,t.message||"Speichern fehlgeschlagen","error")}}function f(r,c){if(!N)return;if(N.innerHTML="",!Array.isArray(r)||r.length===0){N.innerHTML='<p class="scheme-empty">Keine Ciphers verfügbar.</p>';return}const t=new Set(Array.isArray(c)?c:[]);r.forEach(o=>{const $=document.createElement("label");$.className="scheme-option",$.dataset.schemeKey=o.key;const P=document.createElement("input");P.type="checkbox",P.name="enabled_schemes",P.value=o.key,P.checked=t.has(o.key);const F=document.createElement("div");F.className="scheme-option__body";const R=document.createElement("span");R.className="scheme-option__title",R.textContent=o.label||o.key;const G=document.createElement("span");if(G.className="scheme-option__meta",G.textContent=o.key,F.appendChild(R),F.appendChild(G),o.description){const U=document.createElement("p");U.className="scheme-option__description",U.textContent=o.description,F.appendChild(U)}$.appendChild(P),$.appendChild(F),N.appendChild($)})}function y(r){if(!d)return;const c=new Set(Array.isArray(r)?r:[]);d.querySelectorAll("input[name='enabled_schemes']").forEach(o=>{o.checked=c.has(o.value)})}async function k(){var r,c;if(d){C(h,"Lade Gematria…","loading");try{const t=await fetch(de,{credentials:"same-origin"});if(!t.ok)throw new Error(`Serverfehler (${t.status})`);const o=await t.json();p={available:Array.isArray(o.available)?o.available:[],enabled:Array.isArray(o.enabled)?o.enabled:[],defaults:{enabled:Array.isArray((r=o==null?void 0:o.defaults)==null?void 0:r.enabled)?o.defaults.enabled:[],ignore_pattern:typeof((c=o==null?void 0:o.defaults)==null?void 0:c.ignore_pattern)=="string"?o.defaults.ignore_pattern:""}},f(p.available,p.enabled),d.elements.ignore_pattern&&(d.elements.ignore_pattern.value=o.ignore_pattern||"",d.elements.ignore_pattern.placeholder=p.defaults.ignore_pattern||"[^A-Z]"),C(h,"","idle")}catch(t){C(h,t.message||"Gematria-Einstellungen konnten nicht geladen werden","error")}}}async function E(r){if(r.preventDefault(),!d)return;C(h,"Speichere…","loading");const t={enabled:new FormData(d).getAll("enabled_schemes"),ignore_pattern:d.elements.ignore_pattern.value.trim()};try{const o=await fetch(de,{method:"PUT",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}),$=await o.json();if(!o.ok)throw new Error($.error||`Serverfehler (${o.status})`);p.available=Array.isArray($.available)?$.available:p.available,p.enabled=Array.isArray($.enabled)?$.enabled:[],$.defaults&&(p.defaults={enabled:Array.isArray($.defaults.enabled)?$.defaults.enabled:[],ignore_pattern:typeof $.defaults.ignore_pattern=="string"?$.defaults.ignore_pattern:p.defaults.ignore_pattern}),f(p.available,p.enabled),d.elements.ignore_pattern&&(d.elements.ignore_pattern.value=$.ignore_pattern||"",d.elements.ignore_pattern.placeholder=p.defaults.ignore_pattern||"[^A-Z]"),C(h,"Einstellungen gespeichert","success")}catch(o){C(h,o.message||"Speichern fehlgeschlagen","error")}}function W(){const r=p.available.map(c=>c.key);y(r)}function Y(){y(p.defaults.enabled||[]),d&&d.elements.ignore_pattern&&(d.elements.ignore_pattern.value=p.defaults.ignore_pattern||"",d.elements.ignore_pattern.placeholder=p.defaults.ignore_pattern||"[^A-Z]")}async function ee(){if(s){C(u,"Lade Worker…","loading");try{const r=await fetch(ue,{credentials:"same-origin"});if(!r.ok)throw new Error(`Serverfehler (${r.status})`);const c=await r.json();A=Array.isArray(c.workers)?c.workers:[],I={updatedAt:c.updated_at||null,status:c.status||"ok",message:c.message||""},ie(),v&&(v.textContent=se(I.updatedAt));const t=I.status==="ok"?"idle":"error";C(u,I.message||"",t)}catch(r){C(u,r.message||"Worker konnten nicht geladen werden","error"),v&&(v.textContent=se(null)),A=[],ie()}}}function ie(){if(!s)return;if(!A.length){s.innerHTML='<p class="workers-empty">Keine Worker gefunden.</p>';return}const c=[...A].sort((t,o)=>{const $=String(t.name||t.id||""),P=String(o.name||o.id||"");return $.localeCompare(P,"de-DE")}).map(t=>{const o=t.name||t.id||"Unbekannter Worker",$=t.online?"Online":"Offline",P=t.online?"worker-status worker-status--online":"worker-status worker-status--offline",F=Number.isFinite(t.active_processes)?t.active_processes:0,R=Number.isFinite(t.configured_processes)?t.configured_processes:null,G=R!==null?`${F} / ${R}`:`${F}`,U=Array.isArray(t.queues)&&t.queues.length?t.queues.map($e=>M($e)).join(", "):"–",O=Array.isArray(t.active_tasks)?t.active_tasks.length:0,H=Array.isArray(t.reserved_tasks)?t.reserved_tasks.length:0,K=Array.isArray(t.scheduled_tasks)?t.scheduled_tasks.length:0,Q=!!t.online,ne=!Q||(R!==null?F>=R:F>0),ae=!Q||F<=0,Se=!Q,le=Number.isFinite(t.total_tasks)?t.total_tasks:null,J=[];t.pid&&J.push(`PID ${M(t.pid)}`),le!==null&&J.push(`${le} Aufgaben insgesamt`);const ke=J.length?`<span>${J.join(" • ")}</span>`:"";return`
          <article class="worker-card" data-worker-card data-worker-name="${M(t.id||o)}">
            <header class="worker-card__header">
              <div>
                <h3>${M(o)}</h3>
                <p class="worker-card__meta">
                  <span class="${P}">${$}</span>
                  ${ke}
                </p>
              </div>
              <div class="worker-card__actions">
                <button type="button" class="button" data-worker-command="start" ${ne?"disabled":""}>Starten</button>
                <button type="button" class="button" data-worker-command="restart" ${Se?"disabled":""}>Neustarten</button>
                <button type="button" class="button" data-worker-command="stop" ${ae?"disabled":""}>Stoppen</button>
              </div>
            </header>
            <dl class="worker-card__stats">
              <div><dt>Status</dt><dd>${$}</dd></div>
              <div><dt>Prozesse</dt><dd>${M(G)}</dd></div>
              <div><dt>Queues</dt><dd>${U}</dd></div>
              <div><dt>Aktiv</dt><dd>${O}</dd></div>
              <div><dt>Reserviert</dt><dd>${H}</dd></div>
              <div><dt>Geplant</dt><dd>${K}</dd></div>
            </dl>
            ${me("Aktive Tasks",t.active_tasks)}
            ${me("Geplante Tasks",t.scheduled_tasks)}
          </article>
        `}).join("");s.innerHTML=c}async function he(r,c,t){if(!(!r||!c)){t&&(t.disabled=!0),C(u,`Sende ${c}…`,"loading");try{const o=await fetch(`${ue}/${encodeURIComponent(r)}/control`,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:c})}),$=await o.json();if(!o.ok)throw new Error($.error||`Serverfehler (${o.status})`);await ee(),C(u,$.message||"Befehl ausgeführt","success")}catch(o){C(u,o.message||"Befehl fehlgeschlagen","error")}finally{t&&(t.disabled=!1)}}}function ge(){const r=new URLSearchParams;return a.query&&r.set("q",a.query),a.type&&a.type!=="all"&&r.set("type",a.type),a.status&&a.status!=="all"&&r.set("enabled",a.status==="active"?"true":"false"),r.toString()}function te(){i&&(i.elements.query&&(i.elements.query.value=a.query||""),i.elements.type&&(i.elements.type.value=a.type||"all"),i.elements.status&&(i.elements.status.value=a.status||"all"))}async function z(){if(b){C(l,"Lade Quellen…","loading");try{const r=ge(),c=r?`${Z}?${r}`:Z,t=await fetch(c,{credentials:"same-origin"});if(!t.ok)throw new Error(`Serverfehler (${t.status})`);const o=await t.json();_=Array.isArray(o.sources)?o.sources:[],j={meta:o.meta||{},filters:o.filters||{}},o.filters&&(a={query:o.filters.query||"",type:Array.isArray(o.filters.types)&&o.filters.types.length?o.filters.types[0]:"all",status:o.filters.enabled===!0?"active":o.filters.enabled===!1?"inactive":"all"},te()),ye(),ve();const $=j.meta||{};$.filters_applied&&!_.length&&($.total_sources_all||0)>0?C(l,`Keine Quellen für die aktuellen Filter gefunden (Gesamt: ${$.total_sources_all}).`,"idle"):C(l,"","idle")}catch(r){C(l,r.message||"Quellen konnten nicht geladen werden","error")}}}function ye(){if(!b)return;const r=j.meta||{};if(!_.length){const t=r.total_sources_all||0,o=r.filters_applied&&t>0?"Keine Quellen passend zu den aktuellen Filtern.":"Noch keine Quellen hinterlegt.";b.innerHTML=`<p class="sources-empty">${o}</p>`;return}const c=_.map(t=>{const o=t.enabled?"Aktiv":"Deaktiviert",$=t.enabled?"source-status source-status--active":"source-status source-status--inactive",P=t.enabled?"Deaktivieren":"Aktivieren",F=t.interval_minutes??0,R=F>0?`${F} min`:"Standard",G=t.stats||{},U=Number.isFinite(G.total_items)?G.total_items:0,O=G.latest_item||{},H=O.title?M(O.title):"–",K=O.url?`<a href="${M(O.url)}" target="_blank" rel="noopener">${H}</a>`:H,Q=[];O.published_at?Q.push(`Publiziert ${M(V(O.published_at))}`):O.fetched_at&&Q.push(`Gefunden ${M(V(O.fetched_at))}`);const ne=Q.length?`<span class="source-latest__meta">${Q.join(" • ")}</span>`:"",ae=V(t.last_run_at);return`
          <tr data-source-id="${t.id}">
            <td>
              <div class="source-name">${M(t.name)}</div>
              <div class="source-meta">
                <span class="${$}">${o}</span>
                <span class="source-type">${M(t.type.toUpperCase())}</span>
              </div>
            </td>
            <td class="source-url"><a href="${M(t.endpoint)}" target="_blank" rel="noopener">${M(t.endpoint)}</a></td>
            <td>${R}</td>
            <td>${U}</td>
            <td class="source-latest">
              <span class="source-latest__title">${K}</span>
              ${ne}
            </td>
            <td>${ae}</td>
            <td class="actions">
              <button type="button" class="button" data-action="toggle" data-id="${t.id}">${P}</button>
              <button type="button" class="button" data-action="delete" data-id="${t.id}">Entfernen</button>
            </td>
          </tr>
        `}).join("");b.innerHTML=`
      <div class="table-wrapper">
        <table class="sources-table">
          <thead>
            <tr>
              <th>Quelle</th>
              <th>Feed</th>
              <th>Intervall</th>
              <th>Items</th>
              <th>Letzter Artikel</th>
              <th>Zuletzt ausgeführt</th>
              <th>Aktionen</th>
            </tr>
          </thead>
          <tbody>${c}</tbody>
        </table>
      </div>
    `}function ve(){if(!w)return;const r=j.meta||{},c=Number.isFinite(r.total_sources)?r.total_sources:_.length,t=Number.isFinite(r.active_sources)?r.active_sources:_.filter(O=>O.enabled).length,o=Number.isFinite(r.inactive_sources)?r.inactive_sources:c-t,$=Number.isFinite(r.total_sources_all)?r.total_sources_all:c,P=Number.isFinite(r.total_items)?r.total_items:_.reduce((O,H)=>{var K;return O+(((K=H.stats)==null?void 0:K.total_items)??0)},0),F=r.type_breakdown||{},R=r.last_run_at?V(r.last_run_at):"–",G=Object.keys(F).length?`<ul class="source-type-list">${Object.entries(F).map(([O,H])=>`<li><span>${M(String(O).toUpperCase())}</span><strong>${H}</strong></li>`).join("")}</ul>`:'<p class="source-type-empty">Keine Typen gefunden.</p>',U=$>c?` • Gesamt: ${$}`:"";w.innerHTML=`
      <article class="stat-card">
        <h3>Gesamtquellen</h3>
        <p class="stat-card__value">${c}</p>
        <p class="stat-card__meta">Aktiv: ${t} • Inaktiv: ${o}${U}</p>
      </article>
      <article class="stat-card">
        <h3>Gesamt-Items</h3>
        <p class="stat-card__value">${P}</p>
        <p class="stat-card__meta">Letzter Lauf: ${R}</p>
      </article>
      <article class="stat-card stat-card--types">
        <h3>Quellen-Typen</h3>
        ${G}
      </article>
    `}async function be(r){if(r.preventDefault(),!m)return;C(l,"Speichere Quelle…","loading");const c={name:m.elements.name.value,type:m.elements.type.value,endpoint:m.elements.endpoint.value,enabled:m.elements.enabled.checked},t=re(m.elements.interval_minutes.value);t!==void 0&&(c.interval_minutes=t);try{const o=await fetch(Z,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify(c)});if(!o.ok)throw new Error(`Serverfehler (${o.status})`);await o.json(),m.reset(),C(l,"Quelle gespeichert","success"),await z()}catch(o){C(l,o.message||"Quelle konnte nicht gespeichert werden","error")}}async function we(r){const c=_.find(t=>t.id===r);if(c){C(l,"Aktualisiere Quelle…","loading");try{const t=await fetch(`${Z}/${r}`,{method:"PUT",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify({enabled:!c.enabled})});if(!t.ok)throw new Error(`Serverfehler (${t.status})`);await t.json(),C(l,"Quelle aktualisiert","success"),await z()}catch(t){C(l,t.message||"Aktualisierung fehlgeschlagen","error")}}}async function _e(r){C(l,"Lösche Quelle…","loading");try{const c=await fetch(`${Z}/${r}`,{method:"DELETE",credentials:"same-origin"});if(!c.ok)throw new Error(`Serverfehler (${c.status})`);C(l,"Quelle entfernt","success"),await z()}catch(c){C(l,c.message||"Quelle konnte nicht entfernt werden","error")}}d&&(d.addEventListener("submit",E),k()),q&&q.addEventListener("click",()=>{W()}),T&&T.addEventListener("click",()=>{Y()}),e&&(e.addEventListener("submit",L),D()),s&&(s.addEventListener("click",r=>{const c=r.target.closest("[data-worker-command]");if(!c)return;const t=c.closest("[data-worker-card]");if(!t)return;const o=t.dataset.workerName,$=c.dataset.workerCommand;he(o,$,c)}),ee()),g&&g.addEventListener("click",()=>{ee()}),v&&(v.textContent=se(I.updatedAt)),i&&(te(),i.addEventListener("submit",r=>{r.preventDefault(),a={query:i.elements.query?i.elements.query.value.trim():"",type:i.elements.type&&i.elements.type.value||"all",status:i.elements.status&&i.elements.status.value||"all"},z()})),x&&x.addEventListener("click",()=>{a={query:"",type:"all",status:"all"},i&&(i.reset(),te()),z()}),m&&m.addEventListener("submit",be),S&&S.addEventListener("click",()=>{z()}),b&&(b.addEventListener("click",r=>{const c=r.target.closest("[data-action]");if(!c)return;const t=Number.parseInt(c.dataset.id,10);Number.isNaN(t)||(c.dataset.action==="toggle"?we(t):c.dataset.action==="delete"&&_e(t))}),z())}const fe=25,xe=20,qe=120;function X(e){const n=Date.now()-e.getTime();if(Number.isNaN(n))return"";const u=60*1e3,s=60*u,v=24*s;return n<u?"gerade eben":n<s?`${Math.round(n/u)} Min.`:n<v?`${Math.round(n/s)} Std.`:`${Math.round(n/v)} Tg.`}function Ie(e){if(!e)return null;const n=Date.now();if(e.endsWith("h")&&Number.isFinite(Number.parseInt(e,10))){const u=Number.parseInt(e,10);return new Date(n-u*60*60*1e3).toISOString()}if(e.endsWith("d")&&Number.isFinite(Number.parseInt(e,10))){const u=Number.parseInt(e,10);return new Date(n-u*24*60*60*1e3).toISOString()}return null}function Te(e){const n=new FormData(e),u=new URLSearchParams,s=n.get("range"),v=Ie(typeof s=="string"?s:"");v&&u.set("from",v);for(const[g,m]of n.entries())!m||g==="range"||u.set(g,m);return u.set("page","1"),u.set("size",String(fe)),u}function pe(e,n){e&&(e.textContent=`${n} ${n===1?"Eintrag":"Einträge"}`)}function B(e,n,u){e&&(e.dataset.state=n,e.textContent=u)}function De(e){const n=document.createElement("li");n.className="feed-item",n.dataset.itemId=String(e.id||"");const u=e.fetched_at?new Date(e.fetched_at):null,s=document.createElement("div");s.className="feed-item__meta";const v=document.createElement("span");if(v.className="feed-item__source",v.textContent=e.source||"Quelle unbekannt",s.appendChild(v),e.lang){const l=document.createElement("span");l.className="feed-item__lang",l.textContent=e.lang,s.appendChild(l)}if(u){const l=document.createElement("span");l.className="feed-item__time",l.dataset.fetchedAt=u.toISOString(),l.textContent=X(u),l.title=u.toLocaleString(),s.appendChild(l)}n.appendChild(s);const g=document.createElement("h3");g.className="feed-item__title";const m=document.createElement("a");if(m.href=e.url||"#",m.target="_blank",m.rel="noopener noreferrer",m.textContent=e.title||e.url||"Unbenanntes Item",g.appendChild(m),n.appendChild(g),e.published_at){const l=document.createElement("div");l.className="feed-item__time";const b=new Date(e.published_at);l.dataset.publishedAt=b.toISOString(),l.textContent=`Publiziert ${X(b)}`,l.title=b.toLocaleString(),n.appendChild(l)}if(e.gematria&&typeof e.gematria=="object"){const l=Object.entries(e.gematria);if(l.length){l.sort((w,i)=>w[0].localeCompare(i[0]));const b=document.createElement("ul");b.className="feed-item__gematria";for(const[w,i]of l){const x=document.createElement("li");x.textContent=`${w}: ${i}`,b.appendChild(x)}n.appendChild(b)}}return n}function oe(e){e.querySelectorAll(".feed-item__time[data-fetched-at]").forEach(s=>{const v=s.dataset.fetchedAt;if(!v)return;const g=new Date(v);s.textContent=X(g)}),e.querySelectorAll(".feed-item__time[data-published-at]").forEach(s=>{const v=s.dataset.publishedAt;if(!v)return;const g=new Date(v);s.textContent=`Publiziert ${X(g)}`})}function Me(){const e=document.querySelector("[data-stream-feed]"),n=document.querySelector("[data-stream-list]"),u=document.querySelector("[data-stream-filter]"),s=document.querySelector("[data-stream-status]"),v=document.querySelector("[data-stream-counter]");if(!e||!n||!u||!s)return;const g=new Set;let m=null,l=null,b=null;function w(){m&&(m.close(),m=null)}function i(h,{replace:N=!1,prepend:q=!1}={}){if(!Array.isArray(h))return;if(N&&(g.clear(),n.innerHTML="",l=null),!h.length){n.setAttribute("aria-busy","false"),n.children.length||(n.innerHTML='<li class="empty-state">Keine Einträge gefunden.</li>');return}n.querySelector(".empty-state")&&(n.innerHTML="");const T=q?[...h].reverse():h;for(const _ of T){if(!_||typeof _.id>"u"||g.has(_.id))continue;const A=De(_);q?n.prepend(A):n.append(A),g.add(_.id)}for(;n.children.length>qe;){const _=n.lastElementChild;if(!_)break;const A=Number.parseInt(_.dataset.itemId||"",10);Number.isNaN(A)||g.delete(A),n.removeChild(_)}n.setAttribute("aria-busy","false"),pe(v,g.size)}async function x(h){const N=new URL("/api/items",window.location.origin);N.search=h.toString(),n.setAttribute("aria-busy","true");const q=await fetch(N.toString(),{headers:{Accept:"application/json"},cache:"no-store"});if(!q.ok){let A=`Request ${N.pathname} fehlgeschlagen (${q.status})`;try{const I=await q.json();I&&typeof I.error=="string"&&(A=I.error)}catch(I){console.warn("Could not parse error payload",I)}throw new Error(A)}const T=await q.json(),_=Array.isArray(T.items)?T.items:[];return i(_,{replace:!0}),l=_.reduce((A,I)=>I&&I.id>A?I.id:A,l||0),pe(v,g.size),T}function S(h){w();const N=new URLSearchParams(h);N.set("limit",String(xe)),l&&N.set("after_id",String(l));const q=`/stream/live?${N.toString()}`;m=new EventSource(q),m.onopen=()=>{B(s,"idle","Live-Verbindung aktiv.")},m.onerror=()=>{B(s,"loading","Verbindung unterbrochen, versuche erneut...")},m.onmessage=T=>{if(T.data)try{const _=JSON.parse(T.data),A=Array.isArray(_.items)?_.items:[];if(!A.length)return;i(A,{prepend:!0});const I=A.reduce((a,p)=>p&&p.id>a?p.id:a,0),j=typeof _.cursor=="number"?_.cursor:0;l=Math.max(l||0,I,j)}catch(_){console.error("stream payload parse failed",_)}}}async function d(){try{w(),b&&(clearInterval(b),b=null),B(s,"loading","Aktualisiere Live-Feed...");const h=Te(u);h.set("size",String(fe));const N=await x(h);(Array.isArray(N.items)?N.items.length:0)?B(s,"idle","Live-Daten synchronisiert."):B(s,"idle","Keine Items im Zeitraum gefunden."),S(h),b=window.setInterval(()=>oe(n),6e4),oe(n)}catch(h){console.error("stream load failed",h),B(s,"error",h.message||"Live-Feed konnte nicht geladen werden.")}}u.addEventListener("submit",h=>{h.preventDefault(),d()}),u.addEventListener("reset",()=>{window.setTimeout(()=>{d()},0)}),d(),window.addEventListener("beforeunload",()=>{w(),b&&clearInterval(b)}),e.addEventListener("mouseleave",()=>oe(n))}const je=document.body.dataset.page||"",Fe={"ui.graph":Ee,"ui.patterns":Ae,"ui.heatmap":Le,"ui.overview":Ne,"ui.admin":Ce,"ui.stream":Me};function Oe(){const e=document.querySelector("button[data-theme-toggle]");if(!e)return;const n=window.matchMedia("(prefers-color-scheme: dark)"),u="the-watcher-theme";function s(g){document.documentElement.setAttribute("data-theme",g),e.setAttribute("aria-pressed",g==="dark"?"true":"false"),e.querySelector("span[data-role='label']").textContent=g==="dark"?"Dark":"Light"}function v(){const g=localStorage.getItem(u);return g==="light"||g==="dark"?g:n.matches?"dark":"light"}s(v()),e.addEventListener("click",()=>{const g=v()==="dark"?"light":"dark";localStorage.setItem(u,g),s(g)}),n.addEventListener("change",()=>{localStorage.getItem(u)||s(n.matches?"dark":"light")})}requestAnimationFrame(()=>{Oe();const e=Fe[je];e&&e()});
