function xe(){const e=window.cytoscape;if(!e){console.warn("Cytoscape not available � skipping graph init");return}const t=document.getElementById("graph-filters"),u=document.getElementById("graph"),l=document.querySelector("#graph-summary .status-message"),g=document.querySelector("#graph-summary .graph-stats"),k=document.getElementById("graph-refresh"),p=document.getElementById("graph-reload"),s=document.getElementById("graph-export-png"),E=document.getElementById("graph-export-json");if(!t||!u||!l||!g)return;let v=h(u),d=null,j=null,N=!1;function h(_){return e({container:_,wheelSensitivity:.2,maxZoom:3,minZoom:.2,style:[{selector:"node",style:{label:"data(label)","text-valign":"center","text-halign":"center","font-size":"12px","text-wrap":"wrap","text-max-width":"120px",color:"#0f172a","background-color":"#2563eb",width:"mapData(value, 0, 50, 24, 96)",height:"mapData(value, 0, 50, 24, 96)","border-width":2,"border-color":"#1e293b"}},{selector:"node[kind = 'tag']",style:{"background-color":"#22c55e","border-color":"#166534"}},{selector:"node[kind = 'alert']",style:{"background-color":"#f97316","border-color":"#c2410c"}},{selector:"node:selected",style:{"border-width":4,"border-color":"#0ea5e9","shadow-blur":16,"shadow-color":"#38bdf8","shadow-opacity":.6}},{selector:"edge",style:{width:"mapData(weight, 0, 20, 1, 6)","line-color":"#94a3b8","curve-style":"bezier","target-arrow-shape":"triangle","target-arrow-color":"#94a3b8",opacity:.8}},{selector:"edge[kind = 'source_tag']",style:{"line-color":"#38bdf8","target-arrow-color":"#38bdf8"}},{selector:"edge[kind = 'source_alert']",style:{"line-color":"#facc15","target-arrow-color":"#facc15"}}]})}function y(){const _=new FormData(t),f=[];t.querySelectorAll("input[name='role']").forEach(I=>{I.checked&&f.push(I.value)});const x=Math.max(1,Math.min(Number(_.get("limit"))||50,200));return{window:_.get("window")||"24h",limit:x,roles:f,refresh:Number(_.get("refresh"))||0}}function T(_){const f=new URLSearchParams;return _.window&&f.set("window",_.window),f.set("limit",String(_.limit)),_.roles.forEach(x=>f.append("role",x)),f.toString()}function F(_,f){l.dataset.state=_,l.textContent=f}function O(_){const f=new Date,x={nodes:_.nodes.length,edges:_.edges.length,sources:_.nodes.filter(I=>I.kind==="source").length,tags:_.nodes.filter(I=>I.kind==="tag").length,alerts:_.nodes.filter(I=>I.kind==="alert").length};g.innerHTML=`
      <div><strong>Knoten:</strong> ${x.nodes}</div>
      <div><strong>Kanten:</strong> ${x.edges}</div>
      <div><strong>Quellen:</strong> ${x.sources}</div>
      <div><strong>Tags:</strong> ${x.tags}</div>
      <div><strong>Alerts:</strong> ${x.alerts}</div>
      <div><small>Stand: ${f.toLocaleTimeString()}</small></div>
    `}async function $(){if(N)return;const _=y();F("loading","Lade Graph..."),N=!0;try{const f=T(_),x=await fetch(`/api/graph?${f}`,{cache:"no-store",headers:{Accept:"application/json"}});if(!x.ok)throw new Error(`Server antwortete mit ${x.status}`);const I=await x.json();j=I,D(I),O(I),F("idle","Aktualisiert.")}catch(f){console.error("Graph fetch failed",f),F("error",f&&f.message?f.message:"Unbekannter Fehler")}finally{N=!1}}function D(_){const f=[];_.nodes.forEach(I=>{f.push({data:{id:I.id,label:I.label,kind:I.kind,value:I.value,meta:I.meta||{}}})}),_.edges.forEach(I=>{f.push({data:{id:`${I.source}->${I.target}:${I.kind}`,source:I.source,target:I.target,weight:I.weight,kind:I.kind,meta:I.meta||{}}})}),v.elements().remove(),v.add(f),v.layout({name:"cose",animate:!1,padding:30,fit:!0,randomize:f.length>150}).run()}function P(_){d&&(clearInterval(d),d=null),_>0&&(d=setInterval(()=>{document.hidden||$()},_*1e3))}function U(){const _=y();P(_.refresh)}function c(_,f){const x=document.createElement("a");x.href=f,x.download=_,document.body.appendChild(x),x.click(),document.body.removeChild(x)}function w(){if(!v)return;const _=v.png({scale:2,bg:"#ffffff"});c(`graph-${Date.now()}.png`,_)}function H(){if(!j){F("error","Keine Daten zum Exportieren verfuegbar.");return}const _=new Blob([JSON.stringify(j,null,2)],{type:"application/json"}),f=URL.createObjectURL(_);c(`graph-${Date.now()}.json`,f),setTimeout(()=>URL.revokeObjectURL(f),1e3)}function A(){t.addEventListener("change",_=>{const f=_.target;(f.matches("input[name='role']")||f.matches("select[name='window']")||f.matches("input[name='limit']"))&&$(),f===k&&U()}),p==null||p.addEventListener("click",()=>{$()}),s==null||s.addEventListener("click",()=>{w()}),E==null||E.addEventListener("click",()=>{H()}),v.on("tap","node",_=>{const f=_.target.data(),x=`${f.label} (${f.kind}) - Wert ${f.value}`;F("info",x)}),document.addEventListener("visibilitychange",()=>{document.hidden?d&&(clearInterval(d),d=null):(U(),$())})}A(),U(),$()}function qe(){const e=document.getElementById("patterns-filters"),t=document.getElementById("patterns-list"),u=document.querySelector("#patterns-container .status-message"),l=document.getElementById("patterns-reload");if(!e||!t||!u||!l)return;function g(v,d){u.dataset.state=v,u.textContent=d}function k(){const v=new FormData(e),d=v.get("window")||"24h",j=Math.max(1,Math.min(Number(v.get("limit"))||10,50));return{window:d,limit:j}}function p(v){const d=new URLSearchParams;return d.set("window",v.window),d.set("limit",String(v.limit)),d.toString()}function s(v){if(t.innerHTML="",!v.length){const d=document.createElement("p");d.className="empty-state",d.textContent="Keine Muster gefunden.",t.appendChild(d);return}v.forEach(d=>{var $,D,P;const j=document.createElement("article");j.className="pattern-card";const N=document.createElement("h2");N.textContent=d.label||"Unbenanntes Muster",j.appendChild(N);const h=document.createElement("p");h.className="pattern-meta";const y=new Date(d.created_at),T=typeof d.anomaly_score=="number"?d.anomaly_score.toFixed(3):"-",F=(($=d.meta)==null?void 0:$.size)??((D=d.item_ids)==null?void 0:D.length)??0;h.textContent=`Anomalie-Score: ${T} � Gr��e: ${F} � ${y.toLocaleString()}`,j.appendChild(h);const O=document.createElement("ul");if(O.className="pattern-terms",(d.top_terms||[]).forEach(U=>{const c=document.createElement("li");c.textContent=U,O.appendChild(c)}),j.appendChild(O),(P=d.item_ids)!=null&&P.length){const U=document.createElement("p");U.className="pattern-items",U.textContent=`Beobachtete Items: ${d.item_ids.join(", ")}`,j.appendChild(U)}t.appendChild(j)})}async function E(){var d,j;const v=k();g("loading","Lade Muster...");try{const N=p(v),h=await fetch(`/api/patterns/latest?${N}`,{cache:"no-store",headers:{Accept:"application/json"}});if(!h.ok)throw new Error(`Server antwortete mit ${h.status}`);const y=await h.json();s(y.patterns||[]);const T=((d=y.meta)==null?void 0:d.count)??((j=y.patterns)==null?void 0:j.length)??0;g("idle",`Aktualisiert (${T}).`)}catch(N){console.error("Pattern fetch failed",N),g("error",N&&N.message?N.message:"Unbekannter Fehler")}}e.addEventListener("change",v=>{(v.target.matches("select[name='window']")||v.target.matches("input[name='limit']"))&&E()}),l.addEventListener("click",()=>{E()}),E()}function Te(){var P,U;const e=document.getElementById("heatmap-filters"),t=document.getElementById("heatmap-chart"),u=document.getElementById("timeline-chart"),l=document.querySelector("#heatmap-dashboard .status-message"),g=document.querySelector("#heatmap-meta .heatmap-stats"),k=document.getElementById("heatmap-reload");if(!e||!t||!u||!l||!g||!k)return;const p=(P=window.echarts)==null?void 0:P.init(t),s=(U=window.echarts)==null?void 0:U.init(u);if(!p||!s){console.warn("ECharts not available � skipping heatmap init");return}let E=null;function v(c,w){l.dataset.state=c,l.textContent=w}function d(){const c=new FormData(e),w=c.get("interval")||"24h",H=Math.max(0,Number(c.get("value_min"))||0),A=Number(c.get("refresh"))||0,_=(c.get("sources")||"").split(",").map(f=>f.trim()).filter(Boolean);return{interval:w,valueMin:H,refresh:A,sources:_}}function j(c){const w=new URLSearchParams;return w.set("interval",c.interval),w.set("value_min",String(c.valueMin)),c.sources.length&&w.set("sources",c.sources.join(",")),w}function N(c){const w=[["Buckets",c.bucket_count??"-"],["Bucket-Minuten",c.bucket_minutes??"-"],["Items",c.item_count??0],["Alerts",c.event_count??0]];c.source_totals&&Object.entries(c.source_totals).slice(0,8).forEach(([H,A])=>w.push([H,A])),g.innerHTML=w.map(([H,A])=>`<dt>${H}</dt><dd>${A}</dd>`).join("")}function h(c){const w=c.buckets||[],H=c.series?c.series.map(x=>x.source):[];if(!w.length||!H.length){p.clear(),p.setOption({title:{text:"Keine Daten im ausgew�hlten Zeitraum",left:"center",textStyle:{color:"#64748b"}}});return}const A=w.map(x=>new Date(x).toLocaleString()),_=[];let f=0;c.series.forEach((x,I)=>{x.counts.forEach((ne,oe)=>{_.push([oe,I,ne]),ne>f&&(f=ne)})}),p.setOption({tooltip:{position:"top",formatter:x=>{const I=x.data[2];return I?`${H[x.data[1]]}<br>${A[x.data[0]]}<br>Events: ${I}`:"Keine Ereignisse"}},grid:{left:90,right:20,top:20,bottom:60},xAxis:{type:"category",data:A,axisLabel:{rotate:-45,color:"#475569"}},yAxis:{type:"category",data:H,axisLabel:{color:"#475569"}},visualMap:{min:0,max:Math.max(1,f),calculable:!0,orient:"horizontal",left:"center",bottom:10},series:[{name:"Events",type:"heatmap",data:_,label:{show:!0,color:"#0f172a",formatter:x=>x.data[2]?String(x.data[2]):""},emphasis:{itemStyle:{shadowBlur:10,shadowColor:"rgba(0, 0, 0, 0.5)"}}}]})}function y(c){const w=(c.timeline||[]).map(A=>({value:[A.at,A.severity||0],alert:A.alert,severity:A.severity||0}));if(!w.length){s.clear(),s.setOption({title:{text:"Keine Alerts",left:"center",textStyle:{color:"#64748b"}}});return}const H=Math.max(...w.map(A=>A.severity),1);s.setOption({tooltip:{trigger:"item",formatter:A=>{const _=new Date(A.value[0]);return`${A.data.alert}<br>${_.toLocaleString()}<br>Severity: ${A.data.severity}`}},xAxis:{type:"time",axisLabel:{color:"#475569"}},yAxis:{type:"value",min:0,max:Math.max(H,1),axisLabel:{show:!1},splitLine:{show:!1}},series:[{type:"scatter",data:w,symbolSize:A=>10+(A[1]||0)*4,itemStyle:{color:"#f97316"}}]})}function T(c){var w;h(c),y(c),N(c.meta||{}),v("idle",`Aktualisiert (${((w=c.meta)==null?void 0:w.item_count)??0} Items)`)}async function F(){const c=d(),w=j(c);v("loading","Lade Daten...");const H=await fetch(`/api/analytics/heatmap?${w.toString()}`,{cache:"no-store",headers:{Accept:"application/json"}});if(!H.ok)throw new Error(`Server antwortete mit ${H.status}`);const A=await H.json();return T(A),c}function O(){E&&(E.close(),E=null)}function $(c){if(O(),!c.refresh)return;const w=j(c);w.set("refresh",String(c.refresh)),E=new EventSource(`/stream/analytics/heatmap?${w.toString()}`),E.onmessage=H=>{try{const A=JSON.parse(H.data);if(A.error){v("error",A.error);return}T(A)}catch(A){console.error("SSE parse failed",A)}},E.onerror=()=>{v("error","Stream unterbrochen"),O()}}function D(){F().then(c=>{$(c)}).catch(c=>{console.error("Heatmap fetch failed",c),v("error",c.message||"Unbekannter Fehler")})}e.addEventListener("change",c=>{(c.target.matches("select[name='interval']")||c.target.matches("input[name='value_min']")||c.target.matches("select[name='refresh']")||c.target.matches("input[name='sources']"))&&D()}),k.addEventListener("click",()=>{D()}),window.addEventListener("beforeunload",()=>{O()}),D()}function Ie(){const e=document.querySelector("[data-overview-status]"),t=document.querySelector("[data-overview]");if(!e||!t)return;const u=N=>t.querySelector(`[data-metric="${N}"]`),l=document.querySelector("[data-overview-alerts]"),g=document.querySelector("[data-overview-patterns]");function k(N,h){e.dataset.state=N,e.textContent=h}async function p(N){const h=await fetch(N,{cache:"no-store",headers:{Accept:"application/json"}});if(!h.ok)throw new Error(`Request ${N} fehlgeschlagen (${h.status})`);return h.json()}function s(N,h){const y=u(N);y&&(y.textContent=h)}function E(N){if(l){if(!N.length){l.innerHTML="<li>Keine Alerts im Zeitraum.</li>";return}l.innerHTML=N.slice(-5).reverse().map(h=>{const y=new Date(h.at).toLocaleString(),T=h.severity!=null?`<span class="badge">S${h.severity}</span>`:"";return`<li><div>${h.alert} ${T}</div><small>${y}</small></li>`}).join("")}}function v(N){if(g){if(!N.length){g.innerHTML="<li>Keine Muster gefunden.</li>";return}g.innerHTML=N.slice(0,5).map(h=>{const y=h.anomaly_score!=null?h.anomaly_score.toFixed(3):"-";return`<li><div>${h.label||"Muster"}</div><small>Score ${y}</small></li>`}).join("")}}async function d(){var N,h;try{k("loading","Aktualisiere �bersicht...");const[y,T,F]=await Promise.all([p("/api/graph?limit=100&window=24h"),p("/api/analytics/heatmap?interval=24h&value_min=0"),p("/api/patterns/latest?window=24h&limit=10")]),O=new Set((y.nodes||[]).filter(D=>D.kind==="source").map(D=>D.id)).size;s("sources",O||0),s("items",((N=T.meta)==null?void 0:N.item_count)??0),s("alerts",((h=T.meta)==null?void 0:h.event_count)??0);const $=(F.patterns||[])[0];s("pattern-score",$&&$.anomaly_score!=null?$.anomaly_score.toFixed(3):"-"),E(T.timeline||[]),v(F.patterns||[]),k("idle","Live-Daten synchronisiert.")}catch(y){console.error("overview load failed",y),k("error",y.message||"�bersicht konnte nicht geladen werden.")}}d();const j=setInterval(d,6e4);window.addEventListener("beforeunload",()=>clearInterval(j))}const _e="/api/admin/worker-settings",Se="/api/admin/gematria-settings",ke="/api/admin/workers",le="/api/admin/sources";function M(e,t,u="idle"){e&&(e.textContent=t,e.dataset.state=u,e.hidden=!t)}function ye(e){const t=Number.parseInt(e,10);return Number.isNaN(t)?void 0:t}function K(e){return e==null?"":String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function be(e){if(!e)return"Stand: –";const t=new Date(e);return Number.isNaN(t.getTime())?"Stand: –":`Stand: ${t.toLocaleString()}`}function ue(e){if(!e)return"–";const t=new Date(e);return Number.isNaN(t.getTime())?"–":t.toLocaleString()}function Ee(e,t){if(!Array.isArray(t)||t.length===0)return`<div class="worker-task-group"><h3>${e}</h3><p class="worker-task-empty">Keine Einträge.</p></div>`;const u=t.map(l=>{const g=K(l.name||"Unbekannte Aufgabe"),k=l.id?` <span class="worker-task-id">#${K(l.id)}</span>`:"",p=[];l.eta&&p.push(`ETA ${K(l.eta)}`),l.queue&&p.push(`Queue ${K(l.queue)}`),typeof l.runtime=="number"&&!Number.isNaN(l.runtime)&&p.push(`${l.runtime.toFixed(1)}s`);const s=p.length?`<div class="worker-task-meta">${p.join(" • ")}</div>`:"",E=[];l.args&&E.push(`<code>${K(l.args)}</code>`),l.kwargs&&l.kwargs!=="{}"&&E.push(`<code>${K(l.kwargs)}</code>`);const v=E.length?`<div class="worker-task-payload">${E.join(" ")}</div>`:"";return`<li><div class="worker-task-head">${g}${k}</div>${s}${v}</li>`}).join("");return`<div class="worker-task-group"><h3>${e}</h3><ul class="worker-task-list">${u}</ul></div>`}function De(){const e=document.querySelector("[data-worker-form]"),t=document.querySelector("[data-worker-status]"),u=document.querySelector("[data-worker-overview-status]"),l=document.querySelector("[data-workers-list]"),g=document.querySelector("[data-worker-updated]"),k=document.querySelector("[data-worker-refresh]"),p=document.querySelector("[data-source-form]"),s=document.querySelector("[data-source-status]"),E=document.querySelector("[data-sources-list]"),v=document.querySelector("[data-source-stats]"),d=document.querySelector("[data-source-filter-form]"),j=document.querySelector("[data-source-filter-reset]"),N=document.querySelector("[data-source-refresh]"),h=document.querySelector("[data-gematria-form]"),y=document.querySelector("[data-gematria-status]"),T=document.querySelector("[data-gematria-list]"),F=document.querySelector("[data-gematria-select-all]"),O=document.querySelector("[data-gematria-reset]");if(!e&&!p&&!E&&!l&&!d&&!v&&!h)return;let $=[],D=[],P={updatedAt:null,status:"idle",message:""},U={meta:{},filters:{}},c={query:"",type:"all",status:"all"},w={available:[],enabled:[],defaults:{enabled:[],ignore_pattern:""}};async function H(){if(e){M(t,"Lade Einstellungen…","loading");try{const i=await fetch(_e,{credentials:"same-origin"});if(!i.ok)throw new Error(`Serverfehler (${i.status})`);const m=await i.json();e.elements.scrape_enabled.checked=!!m.scrape_enabled,e.elements.default_interval_minutes.value=m.default_interval_minutes??15,e.elements.max_sources_per_cycle.value=m.max_sources_per_cycle??0,p&&p.elements.interval_minutes.value===""&&(p.elements.interval_minutes.placeholder=m.default_interval_minutes??""),M(t,"","idle")}catch(i){M(t,i.message||"Einstellungen konnten nicht geladen werden","error")}}}async function A(i){if(i.preventDefault(),!e)return;M(t,"Speichere…","loading");const m={scrape_enabled:e.elements.scrape_enabled.checked,default_interval_minutes:ye(e.elements.default_interval_minutes.value),max_sources_per_cycle:ye(e.elements.max_sources_per_cycle.value)};try{const a=await fetch(_e,{method:"PUT",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify(m)});if(!a.ok)throw new Error(`Serverfehler (${a.status})`);await a.json(),M(t,"Einstellungen gespeichert","success")}catch(a){M(t,a.message||"Speichern fehlgeschlagen","error")}}function _(i,m){if(!T)return;if(T.innerHTML="",!Array.isArray(i)||i.length===0){T.innerHTML='<p class="scheme-empty">Keine Ciphers verfügbar.</p>';return}const a=new Set(Array.isArray(m)?m:[]);i.forEach(r=>{const S=document.createElement("label");S.className="scheme-option",S.dataset.schemeKey=r.key;const G=document.createElement("input");G.type="checkbox",G.name="enabled_schemes",G.value=r.key,G.checked=a.has(r.key);const Q=document.createElement("div");Q.className="scheme-option__body";const z=document.createElement("span");z.className="scheme-option__title",z.textContent=r.label||r.key;const W=document.createElement("span");if(W.className="scheme-option__meta",W.textContent=r.key,Q.appendChild(z),Q.appendChild(W),r.description){const X=document.createElement("p");X.className="scheme-option__description",X.textContent=r.description,Q.appendChild(X)}S.appendChild(G),S.appendChild(Q),T.appendChild(S)})}function f(i){if(!h)return;const m=new Set(Array.isArray(i)?i:[]);h.querySelectorAll("input[name='enabled_schemes']").forEach(r=>{r.checked=m.has(r.value)})}async function x(){var i,m;if(h){M(y,"Lade Gematria…","loading");try{const a=await fetch(Se,{credentials:"same-origin"});if(!a.ok)throw new Error(`Serverfehler (${a.status})`);const r=await a.json();w={available:Array.isArray(r.available)?r.available:[],enabled:Array.isArray(r.enabled)?r.enabled:[],defaults:{enabled:Array.isArray((i=r==null?void 0:r.defaults)==null?void 0:i.enabled)?r.defaults.enabled:[],ignore_pattern:typeof((m=r==null?void 0:r.defaults)==null?void 0:m.ignore_pattern)=="string"?r.defaults.ignore_pattern:""}},_(w.available,w.enabled),h.elements.ignore_pattern&&(h.elements.ignore_pattern.value=r.ignore_pattern||"",h.elements.ignore_pattern.placeholder=w.defaults.ignore_pattern||"[^A-Z]"),M(y,"","idle")}catch(a){M(y,a.message||"Gematria-Einstellungen konnten nicht geladen werden","error")}}}async function I(i){if(i.preventDefault(),!h)return;M(y,"Speichere…","loading");const a={enabled:new FormData(h).getAll("enabled_schemes"),ignore_pattern:h.elements.ignore_pattern.value.trim()};try{const r=await fetch(Se,{method:"PUT",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)}),S=await r.json();if(!r.ok)throw new Error(S.error||`Serverfehler (${r.status})`);w.available=Array.isArray(S.available)?S.available:w.available,w.enabled=Array.isArray(S.enabled)?S.enabled:[],S.defaults&&(w.defaults={enabled:Array.isArray(S.defaults.enabled)?S.defaults.enabled:[],ignore_pattern:typeof S.defaults.ignore_pattern=="string"?S.defaults.ignore_pattern:w.defaults.ignore_pattern}),_(w.available,w.enabled),h.elements.ignore_pattern&&(h.elements.ignore_pattern.value=S.ignore_pattern||"",h.elements.ignore_pattern.placeholder=w.defaults.ignore_pattern||"[^A-Z]"),M(y,"Einstellungen gespeichert","success")}catch(r){M(y,r.message||"Speichern fehlgeschlagen","error")}}function ne(){const i=w.available.map(m=>m.key);f(i)}function oe(){f(w.defaults.enabled||[]),h&&h.elements.ignore_pattern&&(h.elements.ignore_pattern.value=w.defaults.ignore_pattern||"",h.elements.ignore_pattern.placeholder=w.defaults.ignore_pattern||"[^A-Z]")}async function ie(){if(l){M(u,"Lade Worker…","loading");try{const i=await fetch(ke,{credentials:"same-origin"});if(!i.ok)throw new Error(`Serverfehler (${i.status})`);const m=await i.json();D=Array.isArray(m.workers)?m.workers:[],P={updatedAt:m.updated_at||null,status:m.status||"ok",message:m.message||""},ce(),g&&(g.textContent=be(P.updatedAt));const a=P.status==="ok"?"idle":"error";M(u,P.message||"",a)}catch(i){M(u,i.message||"Worker konnten nicht geladen werden","error"),g&&(g.textContent=be(null)),D=[],ce()}}}function ce(){if(!l)return;if(!D.length){l.innerHTML='<p class="workers-empty">Keine Worker gefunden.</p>';return}const m=[...D].sort((a,r)=>{const S=String(a.name||a.id||""),G=String(r.name||r.id||"");return S.localeCompare(G,"de-DE")}).map(a=>{const r=a.name||a.id||"Unbekannter Worker",S=a.online?"Online":"Offline",G=a.online?"worker-status worker-status--online":"worker-status worker-status--offline",Q=Number.isFinite(a.active_processes)?a.active_processes:0,z=Number.isFinite(a.configured_processes)?a.configured_processes:null,W=z!==null?`${Q} / ${z}`:`${Q}`,X=Array.isArray(a.queues)&&a.queues.length?a.queues.map(Le=>K(Le)).join(", "):"–",J=Array.isArray(a.active_tasks)?a.active_tasks.length:0,ee=Array.isArray(a.reserved_tasks)?a.reserved_tasks.length:0,re=Array.isArray(a.scheduled_tasks)?a.scheduled_tasks.length:0,te=!!a.online,fe=!te||(z!==null?Q>=z:Q>0),ge=!te||Q<=0,Ce=!te,we=Number.isFinite(a.total_tasks)?a.total_tasks:null,de=[];a.pid&&de.push(`PID ${K(a.pid)}`),we!==null&&de.push(`${we} Aufgaben insgesamt`);const Ae=de.length?`<span>${de.join(" • ")}</span>`:"";return`
          <article class="worker-card" data-worker-card data-worker-name="${K(a.id||r)}">
            <header class="worker-card__header">
              <div>
                <h3>${K(r)}</h3>
                <p class="worker-card__meta">
                  <span class="${G}">${S}</span>
                  ${Ae}
                </p>
              </div>
              <div class="worker-card__actions">
                <button type="button" class="button" data-worker-command="start" ${fe?"disabled":""}>Starten</button>
                <button type="button" class="button" data-worker-command="restart" ${Ce?"disabled":""}>Neustarten</button>
                <button type="button" class="button" data-worker-command="stop" ${ge?"disabled":""}>Stoppen</button>
              </div>
            </header>
            <dl class="worker-card__stats">
              <div><dt>Status</dt><dd>${S}</dd></div>
              <div><dt>Prozesse</dt><dd>${K(W)}</dd></div>
              <div><dt>Queues</dt><dd>${X}</dd></div>
              <div><dt>Aktiv</dt><dd>${J}</dd></div>
              <div><dt>Reserviert</dt><dd>${ee}</dd></div>
              <div><dt>Geplant</dt><dd>${re}</dd></div>
            </dl>
            ${Ee("Aktive Tasks",a.active_tasks)}
            ${Ee("Geplante Tasks",a.scheduled_tasks)}
          </article>
        `}).join("");l.innerHTML=m}async function he(i,m,a){if(!(!i||!m)){a&&(a.disabled=!0),M(u,`Sende ${m}…`,"loading");try{const r=await fetch(`${ke}/${encodeURIComponent(i)}/control`,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:m})}),S=await r.json();if(!r.ok)throw new Error(S.error||`Serverfehler (${r.status})`);await ie(),M(u,S.message||"Befehl ausgeführt","success")}catch(r){M(u,r.message||"Befehl fehlgeschlagen","error")}finally{a&&(a.disabled=!1)}}}function b(){const i=new URLSearchParams;return c.query&&i.set("q",c.query),c.type&&c.type!=="all"&&i.set("type",c.type),c.status&&c.status!=="all"&&i.set("enabled",c.status==="active"?"true":"false"),i.toString()}function n(){d&&(d.elements.query&&(d.elements.query.value=c.query||""),d.elements.type&&(d.elements.type.value=c.type||"all"),d.elements.status&&(d.elements.status.value=c.status||"all"))}async function o(){if(E){M(s,"Lade Quellen…","loading");try{const i=b(),m=i?`${le}?${i}`:le,a=await fetch(m,{credentials:"same-origin"});if(!a.ok)throw new Error(`Serverfehler (${a.status})`);const r=await a.json();$=Array.isArray(r.sources)?r.sources:[],U={meta:r.meta||{},filters:r.filters||{}},r.filters&&(c={query:r.filters.query||"",type:Array.isArray(r.filters.types)&&r.filters.types.length?r.filters.types[0]:"all",status:r.filters.enabled===!0?"active":r.filters.enabled===!1?"inactive":"all"},n()),q(),L();const S=U.meta||{};S.filters_applied&&!$.length&&(S.total_sources_all||0)>0?M(s,`Keine Quellen für die aktuellen Filter gefunden (Gesamt: ${S.total_sources_all}).`,"idle"):M(s,"","idle")}catch(i){M(s,i.message||"Quellen konnten nicht geladen werden","error")}}}function q(){if(!E)return;const i=U.meta||{};if(!$.length){const a=i.total_sources_all||0,r=i.filters_applied&&a>0?"Keine Quellen passend zu den aktuellen Filtern.":"Noch keine Quellen hinterlegt.";E.innerHTML=`<p class="sources-empty">${r}</p>`;return}const m=$.map(a=>{const r=a.enabled?"Aktiv":"Deaktiviert",S=a.enabled?"source-status source-status--active":"source-status source-status--inactive",G=a.enabled?"Deaktivieren":"Aktivieren",Q=a.interval_minutes??0,z=Q>0?`${Q} min`:"Standard",W=a.stats||{},X=Number.isFinite(W.total_items)?W.total_items:0,J=W.latest_item||{},ee=J.title?K(J.title):"–",re=J.url?`<a href="${K(J.url)}" target="_blank" rel="noopener">${ee}</a>`:ee,te=[];J.published_at?te.push(`Publiziert ${K(ue(J.published_at))}`):J.fetched_at&&te.push(`Gefunden ${K(ue(J.fetched_at))}`);const fe=te.length?`<span class="source-latest__meta">${te.join(" • ")}</span>`:"",ge=ue(a.last_run_at);return`
          <tr data-source-id="${a.id}">
            <td>
              <div class="source-name">${K(a.name)}</div>
              <div class="source-meta">
                <span class="${S}">${r}</span>
                <span class="source-type">${K(a.type.toUpperCase())}</span>
              </div>
            </td>
            <td class="source-url"><a href="${K(a.endpoint)}" target="_blank" rel="noopener">${K(a.endpoint)}</a></td>
            <td>${z}</td>
            <td>${X}</td>
            <td class="source-latest">
              <span class="source-latest__title">${re}</span>
              ${fe}
            </td>
            <td>${ge}</td>
            <td class="actions">
              <button type="button" class="button" data-action="toggle" data-id="${a.id}">${G}</button>
              <button type="button" class="button" data-action="delete" data-id="${a.id}">Entfernen</button>
            </td>
          </tr>
        `}).join("");E.innerHTML=`
      <div class="table-wrapper">
        <table class="sources-table">
          <thead>
            <tr>
              <th>Quelle</th>
              <th>Feed</th>
              <th>Intervall</th>
              <th>Items</th>
              <th>Letzter Artikel</th>
              <th>Zuletzt ausgeführt</th>
              <th>Aktionen</th>
            </tr>
          </thead>
          <tbody>${m}</tbody>
        </table>
      </div>
    `}function L(){if(!v)return;const i=U.meta||{},m=Number.isFinite(i.total_sources)?i.total_sources:$.length,a=Number.isFinite(i.active_sources)?i.active_sources:$.filter(J=>J.enabled).length,r=Number.isFinite(i.inactive_sources)?i.inactive_sources:m-a,S=Number.isFinite(i.total_sources_all)?i.total_sources_all:m,G=Number.isFinite(i.total_items)?i.total_items:$.reduce((J,ee)=>{var re;return J+(((re=ee.stats)==null?void 0:re.total_items)??0)},0),Q=i.type_breakdown||{},z=i.last_run_at?ue(i.last_run_at):"–",W=Object.keys(Q).length?`<ul class="source-type-list">${Object.entries(Q).map(([J,ee])=>`<li><span>${K(String(J).toUpperCase())}</span><strong>${ee}</strong></li>`).join("")}</ul>`:'<p class="source-type-empty">Keine Typen gefunden.</p>',X=S>m?` • Gesamt: ${S}`:"";v.innerHTML=`
      <article class="stat-card">
        <h3>Gesamtquellen</h3>
        <p class="stat-card__value">${m}</p>
        <p class="stat-card__meta">Aktiv: ${a} • Inaktiv: ${r}${X}</p>
      </article>
      <article class="stat-card">
        <h3>Gesamt-Items</h3>
        <p class="stat-card__value">${G}</p>
        <p class="stat-card__meta">Letzter Lauf: ${z}</p>
      </article>
      <article class="stat-card stat-card--types">
        <h3>Quellen-Typen</h3>
        ${W}
      </article>
    `}async function B(i){if(i.preventDefault(),!p)return;M(s,"Speichere Quelle…","loading");const m={name:p.elements.name.value,type:p.elements.type.value,endpoint:p.elements.endpoint.value,enabled:p.elements.enabled.checked},a=ye(p.elements.interval_minutes.value);a!==void 0&&(m.interval_minutes=a);try{const r=await fetch(le,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify(m)});if(!r.ok)throw new Error(`Serverfehler (${r.status})`);await r.json(),p.reset(),M(s,"Quelle gespeichert","success"),await o()}catch(r){M(s,r.message||"Quelle konnte nicht gespeichert werden","error")}}async function Z(i){const m=$.find(a=>a.id===i);if(m){M(s,"Aktualisiere Quelle…","loading");try{const a=await fetch(`${le}/${i}`,{method:"PUT",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify({enabled:!m.enabled})});if(!a.ok)throw new Error(`Serverfehler (${a.status})`);await a.json(),M(s,"Quelle aktualisiert","success"),await o()}catch(a){M(s,a.message||"Aktualisierung fehlgeschlagen","error")}}}async function Y(i){M(s,"Lösche Quelle…","loading");try{const m=await fetch(`${le}/${i}`,{method:"DELETE",credentials:"same-origin"});if(!m.ok)throw new Error(`Serverfehler (${m.status})`);M(s,"Quelle entfernt","success"),await o()}catch(m){M(s,m.message||"Quelle konnte nicht entfernt werden","error")}}h&&(h.addEventListener("submit",I),x()),F&&F.addEventListener("click",()=>{ne()}),O&&O.addEventListener("click",()=>{oe()}),e&&(e.addEventListener("submit",A),H()),l&&(l.addEventListener("click",i=>{const m=i.target.closest("[data-worker-command]");if(!m)return;const a=m.closest("[data-worker-card]");if(!a)return;const r=a.dataset.workerName,S=m.dataset.workerCommand;he(r,S,m)}),ie()),k&&k.addEventListener("click",()=>{ie()}),g&&(g.textContent=be(P.updatedAt)),d&&(n(),d.addEventListener("submit",i=>{i.preventDefault(),c={query:d.elements.query?d.elements.query.value.trim():"",type:d.elements.type&&d.elements.type.value||"all",status:d.elements.status&&d.elements.status.value||"all"},o()})),j&&j.addEventListener("click",()=>{c={query:"",type:"all",status:"all"},d&&(d.reset(),n()),o()}),p&&p.addEventListener("submit",B),N&&N.addEventListener("click",()=>{o()}),E&&(E.addEventListener("click",i=>{const m=i.target.closest("[data-action]");if(!m)return;const a=Number.parseInt(m.dataset.id,10);Number.isNaN(a)||(m.dataset.action==="toggle"?Z(a):m.dataset.action==="delete"&&Y(a))}),o())}const je="/api/crawlers",Fe="/api/crawlers/stream",me="/api/crawlers/feeds",Me="/api/crawlers/feeds/bulk",Oe=e=>`/api/crawlers/${e}/control`,Pe=e=>`/api/crawlers/feeds/${e}/actions/health-check`;function R(e,t,u="idle"){e&&(e.textContent=t,e.dataset.state=u,e.hidden=!t)}function V(e){if(e==null)return"–";const t=Number(e);return Number.isNaN(t)?String(e):t.toLocaleString()}function ae(e){if(!e)return"–";const t=new Date(e);return Number.isNaN(t.getTime())?"–":t.toLocaleString()}function C(e,t={}){const u=document.createElement(e);return t.className&&(u.className=t.className),t.text&&(u.textContent=t.text),t.html&&(u.innerHTML=t.html),t.attrs&&Object.entries(t.attrs).forEach(([l,g])=>{g!=null&&u.setAttribute(l,String(g))}),u}function Re(){const e=document.querySelector("[data-crawler-overview-status]"),t=document.querySelector("[data-crawler-summary]"),u=document.querySelector("[data-crawler-window]"),l=document.querySelector("[data-crawler-refresh]"),g=document.querySelector("[data-worker-status]"),k=document.querySelector("[data-worker-refresh]"),p=document.querySelector("[data-workers-list]"),s=document.querySelector("[data-feed-status]"),E=document.querySelector("[data-feed-refresh]"),v=document.querySelector("[data-feed-list]"),d=document.querySelector("[data-feed-filter-form]"),j=document.querySelector("[data-feed-filter-reset]"),N=document.querySelector("[data-feed-create-form]"),h=document.querySelector("[data-feed-bulk-form]");if(!t||!p||!v)return;let y=null,T=null,F=Number(u?u.value:24)||24,O={query:"",type:"",enabled:"",tags:"",include_runs:!1};function $(){T&&(clearInterval(T),T=null)}function D(){y&&(y.close(),y=null)}function P(){$(),T=setInterval(()=>{A()},8e3)}function U(b){const n=b.sources||{},o=b.runs||{},q=b.discoveries||{},L=t.querySelectorAll(".stat-card");if(L.length>=4&&(L[0].querySelector(".stat-card__value").textContent=V(n.total),L[0].querySelector(".stat-card__meta").textContent=`Aktiv ${V(n.active)} • Degradiert ${V(n.degraded)}`,L[1].querySelector(".stat-card__value").textContent=V(o.total),L[1].querySelector(".stat-card__meta").textContent=`Fehler ${V(o.failed)} • Items ${V(o.items_processed)}`,L[2].querySelector(".stat-card__value").textContent=o.avg_duration_ms===null||o.avg_duration_ms===void 0?"–":`${Math.round(o.avg_duration_ms)} ms`,L[2].querySelector(".stat-card__meta").textContent=`Fenster ${o.window_hours||F} h`,L[3].querySelector(".stat-card__value").textContent=V(q.pending),L[3].querySelector(".stat-card__meta").textContent=`Veröffentlicht ${V(q.approved)}`),e){const B=b.updated_at?ae(b.updated_at):"–";R(e,`Stand: ${B}`,"success")}}function c(b){if(!p)return;p.innerHTML="";const n=b&&Array.isArray(b.workers)?b.workers:[];if(n.length===0){p.appendChild(C("p",{className:"workers-empty",text:"Keine Worker registriert."}));return}n.forEach(o=>{const q=C("article",{className:"worker-card",attrs:{"data-worker-card":"","data-worker-name":o.id||o.name||"scheduler"}}),L=C("header",{className:"worker-card__header"}),B=C("div",{className:"worker-card__title"}),Z=o.name||o.id||"Unbekannt",Y=o.status||(o.online?"online":"offline");B.appendChild(C("h3",{text:Z})),B.appendChild(C("p",{className:"worker-status",text:Y})),L.appendChild(B);const i=C("div",{className:"worker-card__actions"});[{label:"Start",action:"start"},{label:"Stop",action:"stop"},{label:"Restart",action:"restart"}].forEach(({label:a,action:r})=>{const S=C("button",{className:"button subtle",text:a,attrs:{type:"button","data-worker-command":r}});i.appendChild(S)}),L.appendChild(i),q.appendChild(L);const m=C("div",{className:"worker-meta"});if(m.appendChild(C("p",{text:`Queue: ${V(o.queued_jobs)}`})),m.appendChild(C("p",{text:`Aktive Jobs: ${V(o.active_jobs)}`})),o.max_workers!==void 0&&m.appendChild(C("p",{text:`Max Threads: ${V(o.max_workers)}`})),q.appendChild(m),Array.isArray(o.jobs)&&o.jobs.length>0){const a=C("div",{className:"worker-jobs"});o.jobs.forEach(r=>{const S=C("article",{className:"worker-job"});S.appendChild(C("h4",{text:r.name||"Job"}));const G=[r.interval_seconds?`Intervall: ${r.interval_seconds}s`:null,r.next_run_at?`Nächster Run: ${ae(r.next_run_at)}`:null,r.last_run_at?`Letzter Run: ${ae(r.last_run_at)}`:null,r.last_duration_seconds?`Dauer: ${r.last_duration_seconds.toFixed(2)}s`:null,r.total_runs!==void 0?`Runs: ${r.total_runs}`:null,r.running?"Status: läuft":r.enabled?"Status: bereit":"Status: deaktiviert"].filter(Boolean);S.appendChild(C("p",{className:"worker-job__meta",text:G.join(" • ")})),r.error&&S.appendChild(C("p",{className:"worker-job__error",text:r.error}));const Q=C("div",{className:"worker-job__actions"});[{label:"Aktivieren",action:"start"},{label:"Deaktivieren",action:"stop"},{label:"Triggern",action:"restart"}].forEach(({label:z,action:W})=>{const X=C("button",{className:"button mini",text:z,attrs:{type:"button","data-worker-command":W,"data-worker-job":r.name||""}});Q.appendChild(X)}),S.appendChild(Q),a.appendChild(S)}),q.appendChild(a)}p.appendChild(q)})}function w(b){if(v.innerHTML="",!Array.isArray(b)||b.length===0){v.appendChild(C("p",{className:"sources-empty",text:"Keine Quellen gefunden."}));return}b.forEach(n=>{const o=C("article",{className:"source-card",attrs:{"data-feed-id":n.id}}),q=C("header",{className:"source-card__header"}),L=C("div",{className:"source-card__title"});L.appendChild(C("input",{attrs:{type:"checkbox","data-feed-select":"",value:n.id}})),L.appendChild(C("h3",{text:n.name}));const B=C("span",{className:n.enabled?"badge badge--success":"badge badge--muted",text:n.enabled?"Aktiv":"Inaktiv"});L.appendChild(B),q.appendChild(L);const Z=C("div",{className:"source-card__actions"}),Y=C("button",{className:"button subtle",text:n.enabled?"Deaktivieren":"Aktivieren",attrs:{type:"button","data-action":"toggle","data-id":n.id,"data-enabled":n.enabled?"1":"0"}}),i=C("button",{className:"button subtle",text:"Health Check",attrs:{type:"button","data-action":"health","data-id":n.id}}),m=C("button",{className:"button subtle danger",text:"Löschen",attrs:{type:"button","data-action":"delete","data-id":n.id}});Z.appendChild(Y),Z.appendChild(i),Z.appendChild(m),q.appendChild(Z),o.appendChild(q);const a=C("div",{className:"source-card__meta"});a.appendChild(C("p",{text:`Typ: ${n.type.toUpperCase()} • Priorität: ${V(n.priority)}`})),a.appendChild(C("p",{text:n.endpoint}));const r=n.stats||{};a.appendChild(C("p",{text:`Items: ${V(r.total_items)} • Letzter Fetch: ${ae(r.last_fetched_at)} • Letzte Publikation: ${ae(r.last_published_at)}`}));const S=n.health||{};a.appendChild(C("p",{className:S.status==="degraded"?"source-health source-health--warning":"source-health",text:`Status: ${S.status||"unbekannt"} • Fehler: ${V(S.consecutive_failures)} • Letzter Check: ${ae(S.last_checked_at)}`})),S.last_error&&a.appendChild(C("p",{className:"source-error",text:S.last_error})),Array.isArray(n.tags)&&n.tags.length&&a.appendChild(C("p",{className:"source-tags",text:`Tags: ${n.tags.join(", ")}`})),n.notes&&a.appendChild(C("p",{className:"source-notes",text:`Notiz: ${n.notes}`})),o.appendChild(a);const G=C("form",{className:"feed-edit",attrs:{"data-feed-edit":n.id}});if(G.innerHTML=`
        <div class="form-row">
          <label class="form-control">
            <span>Priorität</span>
            <input type="number" name="priority" min="0" step="1" value="${n.priority??0}">
          </label>
          <label class="form-control">
            <span>Tags</span>
            <input type="text" name="tags" value="${(n.tags||[]).join(", ")}" placeholder="tag1, tag2">
          </label>
        </div>
        <label class="form-control">
          <span>Notizen</span>
          <textarea name="notes" rows="2">${n.notes||""}</textarea>
        </label>
        <div class="form-actions">
          <button type="submit" class="button mini">Speichern</button>
        </div>
      `,G.addEventListener("submit",Q=>{Q.preventDefault();const z=new FormData(G),W={priority:Number.parseInt(z.get("priority"),10),tags:(z.get("tags")||"").split(",").map(X=>X.trim()).filter(Boolean),notes:z.get("notes")};I(n.id,W)}),o.appendChild(G),Array.isArray(n.runs)&&n.runs.length){const Q=C("details",{className:"feed-runs"});Q.appendChild(C("summary",{text:`Letzte Runs (${n.runs.length})`}));const z=C("ul",{className:"feed-runs__list"});n.runs.forEach(W=>{z.appendChild(C("li",{text:`${ae(W.started_at)} • Status: ${W.status||"-"} • Items: ${V(W.items_fetched)}`}))}),Q.appendChild(z),o.appendChild(Q)}v.appendChild(o)})}function H(){if(!d)return{...O};const b=new FormData(d);return O={query:b.get("query")||"",type:b.get("type")||"",enabled:b.get("enabled")||"",tags:b.get("tags")||"",include_runs:b.get("include_runs")==="1"||b.get("include_runs")==="on"},{...O}}async function A({silent:b=!1}={}){b||R(e,"Lade Übersicht...","loading");try{const n=new URLSearchParams({window_hours:String(F)}),o=await fetch(`${je}?${n.toString()}`,{headers:{Accept:"application/json"},credentials:"same-origin"});if(!o.ok)throw new Error(`Serverfehler (${o.status})`);const q=await o.json();U(q),c(q.workers),R(e,`Stand: ${ae(q.updated_at)}`,"success")}catch(n){console.error("loadOverview failed",n),R(e,n.message||"Übersicht konnte nicht geladen werden","error")}}function _(){D(),$();const b=new URLSearchParams({window_hours:String(F),refresh:"5"});try{y=new EventSource(`${Fe}?${b.toString()}`,{withCredentials:!0}),y.onmessage=n=>{try{const o=JSON.parse(n.data);U(o),c(o.workers)}catch(o){console.error("SSE parse error",o)}},y.onerror=()=>{R(e,"Live-Stream getrennt – wechsle auf Polling","error"),D(),P()}}catch(n){console.warn("EventSource not supported",n),P()}}async function f({silent:b=!1}={}){var q;const n=H(),o=new URLSearchParams;n.query&&o.set("q",n.query),n.type&&o.set("type",n.type),n.enabled&&o.set("enabled",n.enabled),n.tags&&o.set("tags",n.tags),n.include_runs&&o.set("include_runs","1"),b||R(s,"Lade Quellen...","loading");try{const L=await fetch(`${me}?${o.toString()}`,{headers:{Accept:"application/json"},credentials:"same-origin"});if(!L.ok)throw new Error(`Serverfehler (${L.status})`);const B=await L.json();w(B.sources||[]),R(s,`Gefundene Quellen: ${V(((q=B.meta)==null?void 0:q.total_sources)??0)}`,"success")}catch(L){console.error("loadFeeds failed",L),R(s,L.message||"Quellen konnten nicht geladen werden","error")}}async function x(b){R(s,"Quelle wird erstellt...","loading");try{const n=Object.fromEntries(b.entries());n.priority!==void 0&&(n.priority=Number.parseInt(n.priority,10)),n.tags&&(n.tags=String(n.tags).split(",").map(q=>q.trim()).filter(Boolean)),n.enabled=b.get("enabled")!==null;const o=await fetch(me,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(n)});if(!o.ok){const q=await o.json().catch(()=>({}));throw new Error(q.error||`Serverfehler (${o.status})`)}R(s,"Quelle erstellt","success"),N.reset(),f({silent:!0})}catch(n){R(s,n.message||"Quelle konnte nicht erstellt werden","error")}}async function I(b,n){R(s,"Änderungen werden gespeichert...","loading");try{const o=await fetch(me+`/${b}`,{method:"PUT",credentials:"same-origin",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(n)});if(!o.ok){const q=await o.json().catch(()=>({}));throw new Error(q.error||`Serverfehler (${o.status})`)}R(s,"Quelle aktualisiert","success"),f({silent:!0})}catch(o){R(s,o.message||"Änderungen konnten nicht gespeichert werden","error")}}async function ne(b,n){return I(b,{enabled:!n})}async function oe(b){R(s,"Lösche Quelle...","loading");try{const n=await fetch(me+`/${b}`,{method:"DELETE",credentials:"same-origin",headers:{Accept:"application/json"}});if(!n.ok){const o=await n.json().catch(()=>({}));throw new Error(o.error||`Serverfehler (${n.status})`)}R(s,"Quelle gelöscht","success"),f({silent:!0})}catch(n){R(s,n.message||"Quelle konnte nicht gelöscht werden","error")}}async function ie(b){R(s,"Health Check wird angestoßen...","loading");try{const n=await fetch(Pe(b),{method:"POST",credentials:"same-origin",headers:{Accept:"application/json"}});if(!n.ok){const o=await n.json().catch(()=>({}));throw new Error(o.error||`Serverfehler (${n.status})`)}R(s,"Health Check gestartet","success"),f({silent:!0})}catch(n){R(s,n.message||"Health Check fehlgeschlagen","error")}}async function ce(b){const n=Array.from(v.querySelectorAll("[data-feed-select]:checked")).map(B=>Number.parseInt(B.value,10)).filter(B=>!Number.isNaN(B));if(n.length===0){R(s,"Bitte mindestens eine Quelle auswählen","error");return}const o=b.get("action");if(!o){R(s,"Bitte eine Aktion wählen","error");return}const q={ids:n,action:o},L=b.get("value");L&&o==="set_priority"?q.payload={priority:Number.parseInt(L,10)}:L&&o==="set_tags"?q.payload={tags:String(L).split(",").map(B=>B.trim()).filter(Boolean)}:o==="set_notes"&&(q.payload={notes:L||""}),R(s,"Bulk-Aktion wird ausgeführt...","loading");try{const B=await fetch(Me,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(q)});if(!B.ok){const Z=await B.json().catch(()=>({}));throw new Error(Z.error||`Serverfehler (${B.status})`)}R(s,"Bulk-Aktion erfolgreich","success"),h.reset(),f({silent:!0})}catch(B){R(s,B.message||"Bulk-Aktion fehlgeschlagen","error")}}async function he(b){const n=b.target.closest("[data-worker-command]");if(!n)return;const o=n.closest("[data-worker-card]");if(!o)return;const q=o.dataset.workerName,L=n.dataset.workerCommand,B=n.dataset.workerJob;if(!(!q||!L)){R(g,`Sende Befehl ${L}...`,"loading");try{const Z=B?{action:L,job:B}:{action:L},Y=await fetch(Oe(q),{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(Z)});if(!Y.ok){const i=await Y.json().catch(()=>({}));throw new Error(i.error||`Serverfehler (${Y.status})`)}R(g,"Befehl ausgeführt","success"),A({silent:!0})}catch(Z){R(g,Z.message||"Worker-Befehl fehlgeschlagen","error")}}}l&&l.addEventListener("click",()=>{A()}),u&&u.addEventListener("change",()=>{F=Be(u.value,24,{minimum:1,maximum:168}),_(),A({silent:!0})}),k&&k.addEventListener("click",()=>{A()}),p.addEventListener("click",he),E&&E.addEventListener("click",()=>f()),d&&d.addEventListener("submit",b=>{b.preventDefault(),f()}),j&&j.addEventListener("click",()=>{d&&d.reset(),O={query:"",type:"",enabled:"",tags:"",include_runs:!1},f()}),N&&N.addEventListener("submit",b=>{b.preventDefault();const n=new FormData(N);x(n)}),h&&h.addEventListener("submit",b=>{b.preventDefault();const n=new FormData(h);ce(n)}),v.addEventListener("click",b=>{const n=b.target.closest("[data-action]");if(!n)return;const o=Number.parseInt(n.dataset.id,10);if(Number.isNaN(o))return;const q=n.dataset.action;if(q==="toggle"){const L=n.dataset.enabled==="1";ne(o,L)}else q==="delete"?confirm("Quelle wirklich löschen?")&&oe(o):q==="health"&&ie(o)}),_(),A({silent:!0}),f()}function Be(e,t,{minimum:u=Number.MIN_SAFE_INTEGER,maximum:l=Number.MAX_SAFE_INTEGER}={}){const g=Number.parseInt(e,10);return Number.isNaN(g)?t:Math.min(Math.max(g,u),l)}const Ne=25,Qe=20,He=120;function pe(e){const t=Date.now()-e.getTime();if(Number.isNaN(t))return"";const u=60*1e3,l=60*u,g=24*l;return t<u?"gerade eben":t<l?`${Math.round(t/u)} Min.`:t<g?`${Math.round(t/l)} Std.`:`${Math.round(t/g)} Tg.`}function Ue(e){if(!e)return null;const t=Date.now();if(e.endsWith("h")&&Number.isFinite(Number.parseInt(e,10))){const u=Number.parseInt(e,10);return new Date(t-u*60*60*1e3).toISOString()}if(e.endsWith("d")&&Number.isFinite(Number.parseInt(e,10))){const u=Number.parseInt(e,10);return new Date(t-u*24*60*60*1e3).toISOString()}return null}function Ge(e){const t=new FormData(e),u=new URLSearchParams,l=t.get("range"),g=Ue(typeof l=="string"?l:"");g&&u.set("from",g);for(const[k,p]of t.entries())!p||k==="range"||u.set(k,p);return u.set("page","1"),u.set("size",String(Ne)),u}function $e(e,t){e&&(e.textContent=`${t} ${t===1?"Eintrag":"Einträge"}`)}function se(e,t,u){e&&(e.dataset.state=t,e.textContent=u)}function ze(e){const t=document.createElement("li");t.className="feed-item",t.dataset.itemId=String(e.id||"");const u=e.fetched_at?new Date(e.fetched_at):null,l=document.createElement("div");l.className="feed-item__meta";const g=document.createElement("span");if(g.className="feed-item__source",g.textContent=e.source||"Quelle unbekannt",l.appendChild(g),e.lang){const s=document.createElement("span");s.className="feed-item__lang",s.textContent=e.lang,l.appendChild(s)}if(u){const s=document.createElement("span");s.className="feed-item__time",s.dataset.fetchedAt=u.toISOString(),s.textContent=pe(u),s.title=u.toLocaleString(),l.appendChild(s)}t.appendChild(l);const k=document.createElement("h3");k.className="feed-item__title";const p=document.createElement("a");if(p.href=e.url||"#",p.target="_blank",p.rel="noopener noreferrer",p.textContent=e.title||e.url||"Unbenanntes Item",k.appendChild(p),t.appendChild(k),e.published_at){const s=document.createElement("div");s.className="feed-item__time";const E=new Date(e.published_at);s.dataset.publishedAt=E.toISOString(),s.textContent=`Publiziert ${pe(E)}`,s.title=E.toLocaleString(),t.appendChild(s)}if(e.gematria&&typeof e.gematria=="object"){const s=Object.entries(e.gematria);if(s.length){s.sort((v,d)=>v[0].localeCompare(d[0]));const E=document.createElement("ul");E.className="feed-item__gematria";for(const[v,d]of s){const j=document.createElement("li");j.textContent=`${v}: ${d}`,E.appendChild(j)}t.appendChild(E)}}return t}function ve(e){e.querySelectorAll(".feed-item__time[data-fetched-at]").forEach(l=>{const g=l.dataset.fetchedAt;if(!g)return;const k=new Date(g);l.textContent=pe(k)}),e.querySelectorAll(".feed-item__time[data-published-at]").forEach(l=>{const g=l.dataset.publishedAt;if(!g)return;const k=new Date(g);l.textContent=`Publiziert ${pe(k)}`})}function Ke(){const e=document.querySelector("[data-stream-feed]"),t=document.querySelector("[data-stream-list]"),u=document.querySelector("[data-stream-filter]"),l=document.querySelector("[data-stream-status]"),g=document.querySelector("[data-stream-counter]");if(!e||!t||!u||!l)return;const k=new Set;let p=null,s=null,E=null;function v(){p&&(p.close(),p=null)}function d(y,{replace:T=!1,prepend:F=!1}={}){if(!Array.isArray(y))return;if(T&&(k.clear(),t.innerHTML="",s=null),!y.length){t.setAttribute("aria-busy","false"),t.children.length||(t.innerHTML='<li class="empty-state">Keine Einträge gefunden.</li>');return}t.querySelector(".empty-state")&&(t.innerHTML="");const O=F?[...y].reverse():y;for(const $ of O){if(!$||typeof $.id>"u"||k.has($.id))continue;const D=ze($);F?t.prepend(D):t.append(D),k.add($.id)}for(;t.children.length>He;){const $=t.lastElementChild;if(!$)break;const D=Number.parseInt($.dataset.itemId||"",10);Number.isNaN(D)||k.delete(D),t.removeChild($)}t.setAttribute("aria-busy","false"),$e(g,k.size)}async function j(y){const T=new URL("/api/items",window.location.origin);T.search=y.toString(),t.setAttribute("aria-busy","true");const F=await fetch(T.toString(),{headers:{Accept:"application/json"},cache:"no-store"});if(!F.ok){let D=`Request ${T.pathname} fehlgeschlagen (${F.status})`;try{const P=await F.json();P&&typeof P.error=="string"&&(D=P.error)}catch(P){console.warn("Could not parse error payload",P)}throw new Error(D)}const O=await F.json(),$=Array.isArray(O.items)?O.items:[];return d($,{replace:!0}),s=$.reduce((D,P)=>P&&P.id>D?P.id:D,s||0),$e(g,k.size),O}function N(y){v();const T=new URLSearchParams(y);T.set("limit",String(Qe)),s&&T.set("after_id",String(s));const F=`/stream/live?${T.toString()}`;p=new EventSource(F),p.onopen=()=>{se(l,"idle","Live-Verbindung aktiv.")},p.onerror=()=>{se(l,"loading","Verbindung unterbrochen, versuche erneut...")},p.onmessage=O=>{if(O.data)try{const $=JSON.parse(O.data),D=Array.isArray($.items)?$.items:[];if(!D.length)return;d(D,{prepend:!0});const P=D.reduce((c,w)=>w&&w.id>c?w.id:c,0),U=typeof $.cursor=="number"?$.cursor:0;s=Math.max(s||0,P,U)}catch($){console.error("stream payload parse failed",$)}}}async function h(){try{v(),E&&(clearInterval(E),E=null),se(l,"loading","Aktualisiere Live-Feed...");const y=Ge(u);y.set("size",String(Ne));const T=await j(y);(Array.isArray(T.items)?T.items.length:0)?se(l,"idle","Live-Daten synchronisiert."):se(l,"idle","Keine Items im Zeitraum gefunden."),N(y),E=window.setInterval(()=>ve(t),6e4),ve(t)}catch(y){console.error("stream load failed",y),se(l,"error",y.message||"Live-Feed konnte nicht geladen werden.")}}u.addEventListener("submit",y=>{y.preventDefault(),h()}),u.addEventListener("reset",()=>{window.setTimeout(()=>{h()},0)}),h(),window.addEventListener("beforeunload",()=>{v(),E&&clearInterval(E)}),e.addEventListener("mouseleave",()=>ve(t))}const We=document.body.dataset.page||"",Je={"ui.graph":xe,"ui.patterns":qe,"ui.heatmap":Te,"ui.overview":Ie,"ui.admin":De,"ui.crawlers":Re,"ui.stream":Ke};function Ve(){const e=document.querySelector("button[data-theme-toggle]");if(!e)return;const t=window.matchMedia("(prefers-color-scheme: dark)"),u="the-watcher-theme";function l(k){document.documentElement.setAttribute("data-theme",k),e.setAttribute("aria-pressed",k==="dark"?"true":"false"),e.querySelector("span[data-role='label']").textContent=k==="dark"?"Dark":"Light"}function g(){const k=localStorage.getItem(u);return k==="light"||k==="dark"?k:t.matches?"dark":"light"}l(g()),e.addEventListener("click",()=>{const k=g()==="dark"?"light":"dark";localStorage.setItem(u,k),l(k)}),t.addEventListener("change",()=>{localStorage.getItem(u)||l(t.matches?"dark":"light")})}requestAnimationFrame(()=>{Ve();const e=Je[We];e&&e()});
