function q(){const o=window.cytoscape;if(!o){console.warn("Cytoscape not available � skipping graph init");return}const d=document.getElementById("graph-filters"),h=document.getElementById("graph"),f=document.querySelector("#graph-summary .status-message"),y=document.querySelector("#graph-summary .graph-stats"),w=document.getElementById("graph-refresh"),$=document.getElementById("graph-reload"),_=document.getElementById("graph-export-png"),b=document.getElementById("graph-export-json");if(!d||!h||!f||!y)return;let u=t(h),s=null,v=null,c=!1;function t(a){return o({container:a,wheelSensitivity:.2,maxZoom:3,minZoom:.2,style:[{selector:"node",style:{label:"data(label)","text-valign":"center","text-halign":"center","font-size":"12px","text-wrap":"wrap","text-max-width":"120px",color:"#0f172a","background-color":"#2563eb",width:"mapData(value, 0, 50, 24, 96)",height:"mapData(value, 0, 50, 24, 96)","border-width":2,"border-color":"#1e293b"}},{selector:"node[kind = 'tag']",style:{"background-color":"#22c55e","border-color":"#166534"}},{selector:"node[kind = 'alert']",style:{"background-color":"#f97316","border-color":"#c2410c"}},{selector:"node:selected",style:{"border-width":4,"border-color":"#0ea5e9","shadow-blur":16,"shadow-color":"#38bdf8","shadow-opacity":.6}},{selector:"edge",style:{width:"mapData(weight, 0, 20, 1, 6)","line-color":"#94a3b8","curve-style":"bezier","target-arrow-shape":"triangle","target-arrow-color":"#94a3b8",opacity:.8}},{selector:"edge[kind = 'source_tag']",style:{"line-color":"#38bdf8","target-arrow-color":"#38bdf8"}},{selector:"edge[kind = 'source_alert']",style:{"line-color":"#facc15","target-arrow-color":"#facc15"}}]})}function e(){const a=new FormData(d),r=[];d.querySelectorAll("input[name='role']").forEach(m=>{m.checked&&r.push(m.value)});const l=Math.max(1,Math.min(Number(a.get("limit"))||50,200));return{window:a.get("window")||"24h",limit:l,roles:r,refresh:Number(a.get("refresh"))||0}}function i(a){const r=new URLSearchParams;return a.window&&r.set("window",a.window),r.set("limit",String(a.limit)),a.roles.forEach(l=>r.append("role",l)),r.toString()}function S(a,r){f.dataset.state=a,f.textContent=r}function x(a){const r=new Date,l={nodes:a.nodes.length,edges:a.edges.length,sources:a.nodes.filter(m=>m.kind==="source").length,tags:a.nodes.filter(m=>m.kind==="tag").length,alerts:a.nodes.filter(m=>m.kind==="alert").length};y.innerHTML=`
      <div><strong>Knoten:</strong> ${l.nodes}</div>
      <div><strong>Kanten:</strong> ${l.edges}</div>
      <div><strong>Quellen:</strong> ${l.sources}</div>
      <div><strong>Tags:</strong> ${l.tags}</div>
      <div><strong>Alerts:</strong> ${l.alerts}</div>
      <div><small>Stand: ${r.toLocaleTimeString()}</small></div>
    `}async function L(){if(c)return;const a=e();S("loading","Lade Graph..."),c=!0;try{const r=i(a),l=await fetch(`/api/graph?${r}`,{cache:"no-store",headers:{Accept:"application/json"}});if(!l.ok)throw new Error(`Server antwortete mit ${l.status}`);const m=await l.json();v=m,C(m),x(m),S("idle","Aktualisiert.")}catch(r){console.error("Graph fetch failed",r),S("error",r&&r.message?r.message:"Unbekannter Fehler")}finally{c=!1}}function C(a){const r=[];a.nodes.forEach(m=>{r.push({data:{id:m.id,label:m.label,kind:m.kind,value:m.value,meta:m.meta||{}}})}),a.edges.forEach(m=>{r.push({data:{id:`${m.source}->${m.target}:${m.kind}`,source:m.source,target:m.target,weight:m.weight,kind:m.kind,meta:m.meta||{}}})}),u.elements().remove(),u.add(r),u.layout({name:"cose",animate:!1,padding:30,fit:!0,randomize:r.length>150}).run()}function N(a){s&&(clearInterval(s),s=null),a>0&&(s=setInterval(()=>{document.hidden||L()},a*1e3))}function D(){const a=e();N(a.refresh)}function n(a,r){const l=document.createElement("a");l.href=r,l.download=a,document.body.appendChild(l),l.click(),document.body.removeChild(l)}function g(){if(!u)return;const a=u.png({scale:2,bg:"#ffffff"});n(`graph-${Date.now()}.png`,a)}function k(){if(!v){S("error","Keine Daten zum Exportieren verfuegbar.");return}const a=new Blob([JSON.stringify(v,null,2)],{type:"application/json"}),r=URL.createObjectURL(a);n(`graph-${Date.now()}.json`,r),setTimeout(()=>URL.revokeObjectURL(r),1e3)}function p(){d.addEventListener("change",a=>{const r=a.target;(r.matches("input[name='role']")||r.matches("select[name='window']")||r.matches("input[name='limit']"))&&L(),r===w&&D()}),$==null||$.addEventListener("click",()=>{L()}),_==null||_.addEventListener("click",()=>{g()}),b==null||b.addEventListener("click",()=>{k()}),u.on("tap","node",a=>{const r=a.target.data(),l=`${r.label} (${r.kind}) - Wert ${r.value}`;S("info",l)}),document.addEventListener("visibilitychange",()=>{document.hidden?s&&(clearInterval(s),s=null):(D(),L())})}p(),D(),L()}function O(){const o=document.getElementById("patterns-filters"),d=document.getElementById("patterns-list"),h=document.querySelector("#patterns-container .status-message"),f=document.getElementById("patterns-reload");if(!o||!d||!h||!f)return;function y(u,s){h.dataset.state=u,h.textContent=s}function w(){const u=new FormData(o),s=u.get("window")||"24h",v=Math.max(1,Math.min(Number(u.get("limit"))||10,50));return{window:s,limit:v}}function $(u){const s=new URLSearchParams;return s.set("window",u.window),s.set("limit",String(u.limit)),s.toString()}function _(u){if(d.innerHTML="",!u.length){const s=document.createElement("p");s.className="empty-state",s.textContent="Keine Muster gefunden.",d.appendChild(s);return}u.forEach(s=>{var L,C,N;const v=document.createElement("article");v.className="pattern-card";const c=document.createElement("h2");c.textContent=s.label||"Unbenanntes Muster",v.appendChild(c);const t=document.createElement("p");t.className="pattern-meta";const e=new Date(s.created_at),i=typeof s.anomaly_score=="number"?s.anomaly_score.toFixed(3):"-",S=((L=s.meta)==null?void 0:L.size)??((C=s.item_ids)==null?void 0:C.length)??0;t.textContent=`Anomalie-Score: ${i} � Gr��e: ${S} � ${e.toLocaleString()}`,v.appendChild(t);const x=document.createElement("ul");if(x.className="pattern-terms",(s.top_terms||[]).forEach(D=>{const n=document.createElement("li");n.textContent=D,x.appendChild(n)}),v.appendChild(x),(N=s.item_ids)!=null&&N.length){const D=document.createElement("p");D.className="pattern-items",D.textContent=`Beobachtete Items: ${s.item_ids.join(", ")}`,v.appendChild(D)}d.appendChild(v)})}async function b(){var s,v;const u=w();y("loading","Lade Muster...");try{const c=$(u),t=await fetch(`/api/patterns/latest?${c}`,{cache:"no-store",headers:{Accept:"application/json"}});if(!t.ok)throw new Error(`Server antwortete mit ${t.status}`);const e=await t.json();_(e.patterns||[]);const i=((s=e.meta)==null?void 0:s.count)??((v=e.patterns)==null?void 0:v.length)??0;y("idle",`Aktualisiert (${i}).`)}catch(c){console.error("Pattern fetch failed",c),y("error",c&&c.message?c.message:"Unbekannter Fehler")}}o.addEventListener("change",u=>{(u.target.matches("select[name='window']")||u.target.matches("input[name='limit']"))&&b()}),f.addEventListener("click",()=>{b()}),b()}function B(){var N,D;const o=document.getElementById("heatmap-filters"),d=document.getElementById("heatmap-chart"),h=document.getElementById("timeline-chart"),f=document.querySelector("#heatmap-dashboard .status-message"),y=document.querySelector("#heatmap-meta .heatmap-stats"),w=document.getElementById("heatmap-reload");if(!o||!d||!h||!f||!y||!w)return;const $=(N=window.echarts)==null?void 0:N.init(d),_=(D=window.echarts)==null?void 0:D.init(h);if(!$||!_){console.warn("ECharts not available � skipping heatmap init");return}let b=null;function u(n,g){f.dataset.state=n,f.textContent=g}function s(){const n=new FormData(o),g=n.get("interval")||"24h",k=Math.max(0,Number(n.get("value_min"))||0),p=Number(n.get("refresh"))||0,a=(n.get("sources")||"").split(",").map(r=>r.trim()).filter(Boolean);return{interval:g,valueMin:k,refresh:p,sources:a}}function v(n){const g=new URLSearchParams;return g.set("interval",n.interval),g.set("value_min",String(n.valueMin)),n.sources.length&&g.set("sources",n.sources.join(",")),g}function c(n){const g=[["Buckets",n.bucket_count??"-"],["Bucket-Minuten",n.bucket_minutes??"-"],["Items",n.item_count??0],["Alerts",n.event_count??0]];n.source_totals&&Object.entries(n.source_totals).slice(0,8).forEach(([k,p])=>g.push([k,p])),y.innerHTML=g.map(([k,p])=>`<dt>${k}</dt><dd>${p}</dd>`).join("")}function t(n){const g=n.buckets||[],k=n.series?n.series.map(l=>l.source):[];if(!g.length||!k.length){$.clear(),$.setOption({title:{text:"Keine Daten im ausgew�hlten Zeitraum",left:"center",textStyle:{color:"#64748b"}}});return}const p=g.map(l=>new Date(l).toLocaleString()),a=[];let r=0;n.series.forEach((l,m)=>{l.counts.forEach((I,T)=>{a.push([T,m,I]),I>r&&(r=I)})}),$.setOption({tooltip:{position:"top",formatter:l=>{const m=l.data[2];return m?`${k[l.data[1]]}<br>${p[l.data[0]]}<br>Events: ${m}`:"Keine Ereignisse"}},grid:{left:90,right:20,top:20,bottom:60},xAxis:{type:"category",data:p,axisLabel:{rotate:-45,color:"#475569"}},yAxis:{type:"category",data:k,axisLabel:{color:"#475569"}},visualMap:{min:0,max:Math.max(1,r),calculable:!0,orient:"horizontal",left:"center",bottom:10},series:[{name:"Events",type:"heatmap",data:a,label:{show:!0,color:"#0f172a",formatter:l=>l.data[2]?String(l.data[2]):""},emphasis:{itemStyle:{shadowBlur:10,shadowColor:"rgba(0, 0, 0, 0.5)"}}}]})}function e(n){const g=(n.timeline||[]).map(p=>({value:[p.at,p.severity||0],alert:p.alert,severity:p.severity||0}));if(!g.length){_.clear(),_.setOption({title:{text:"Keine Alerts",left:"center",textStyle:{color:"#64748b"}}});return}const k=Math.max(...g.map(p=>p.severity),1);_.setOption({tooltip:{trigger:"item",formatter:p=>{const a=new Date(p.value[0]);return`${p.data.alert}<br>${a.toLocaleString()}<br>Severity: ${p.data.severity}`}},xAxis:{type:"time",axisLabel:{color:"#475569"}},yAxis:{type:"value",min:0,max:Math.max(k,1),axisLabel:{show:!1},splitLine:{show:!1}},series:[{type:"scatter",data:g,symbolSize:p=>10+(p[1]||0)*4,itemStyle:{color:"#f97316"}}]})}function i(n){var g;t(n),e(n),c(n.meta||{}),u("idle",`Aktualisiert (${((g=n.meta)==null?void 0:g.item_count)??0} Items)`)}async function S(){const n=s(),g=v(n);u("loading","Lade Daten...");const k=await fetch(`/api/analytics/heatmap?${g.toString()}`,{cache:"no-store",headers:{Accept:"application/json"}});if(!k.ok)throw new Error(`Server antwortete mit ${k.status}`);const p=await k.json();return i(p),n}function x(){b&&(b.close(),b=null)}function L(n){if(x(),!n.refresh)return;const g=v(n);g.set("refresh",String(n.refresh)),b=new EventSource(`/stream/analytics/heatmap?${g.toString()}`),b.onmessage=k=>{try{const p=JSON.parse(k.data);if(p.error){u("error",p.error);return}i(p)}catch(p){console.error("SSE parse failed",p)}},b.onerror=()=>{u("error","Stream unterbrochen"),x()}}function C(){S().then(n=>{L(n)}).catch(n=>{console.error("Heatmap fetch failed",n),u("error",n.message||"Unbekannter Fehler")})}o.addEventListener("change",n=>{(n.target.matches("select[name='interval']")||n.target.matches("input[name='value_min']")||n.target.matches("select[name='refresh']")||n.target.matches("input[name='sources']"))&&C()}),w.addEventListener("click",()=>{C()}),window.addEventListener("beforeunload",()=>{x()}),C()}function F(){const o=document.querySelector("[data-overview-status]"),d=document.querySelector("[data-overview]");if(!o||!d)return;const h=c=>d.querySelector(`[data-metric="${c}"]`),f=document.querySelector("[data-overview-alerts]"),y=document.querySelector("[data-overview-patterns]");function w(c,t){o.dataset.state=c,o.textContent=t}async function $(c){const t=await fetch(c,{cache:"no-store",headers:{Accept:"application/json"}});if(!t.ok)throw new Error(`Request ${c} fehlgeschlagen (${t.status})`);return t.json()}function _(c,t){const e=h(c);e&&(e.textContent=t)}function b(c){if(f){if(!c.length){f.innerHTML="<li>Keine Alerts im Zeitraum.</li>";return}f.innerHTML=c.slice(-5).reverse().map(t=>{const e=new Date(t.at).toLocaleString(),i=t.severity!=null?`<span class="badge">S${t.severity}</span>`:"";return`<li><div>${t.alert} ${i}</div><small>${e}</small></li>`}).join("")}}function u(c){if(y){if(!c.length){y.innerHTML="<li>Keine Muster gefunden.</li>";return}y.innerHTML=c.slice(0,5).map(t=>{const e=t.anomaly_score!=null?t.anomaly_score.toFixed(3):"-";return`<li><div>${t.label||"Muster"}</div><small>Score ${e}</small></li>`}).join("")}}async function s(){var c,t;try{w("loading","Aktualisiere �bersicht...");const[e,i,S]=await Promise.all([$("/api/graph?limit=100&window=24h"),$("/api/analytics/heatmap?interval=24h&value_min=0"),$("/api/patterns/latest?window=24h&limit=10")]),x=new Set((e.nodes||[]).filter(C=>C.kind==="source").map(C=>C.id)).size;_("sources",x||0),_("items",((c=i.meta)==null?void 0:c.item_count)??0),_("alerts",((t=i.meta)==null?void 0:t.event_count)??0);const L=(S.patterns||[])[0];_("pattern-score",L&&L.anomaly_score!=null?L.anomaly_score.toFixed(3):"-"),b(i.timeline||[]),u(S.patterns||[]),w("idle","Live-Daten synchronisiert.")}catch(e){console.error("overview load failed",e),w("error",e.message||"�bersicht konnte nicht geladen werden.")}}s();const v=setInterval(s,6e4);window.addEventListener("beforeunload",()=>clearInterval(v))}const j="/api/admin/worker-settings",A="/api/admin/sources";function E(o,d,h="idle"){o&&(o.textContent=d,o.dataset.state=h,o.hidden=!d)}function M(o){const d=Number.parseInt(o,10);return Number.isNaN(d)?void 0:d}function P(){const o=document.querySelector("[data-worker-form]"),d=document.querySelector("[data-worker-status]"),h=document.querySelector("[data-source-form]"),f=document.querySelector("[data-source-status]"),y=document.querySelector("[data-sources-list]");if(!o&&!h&&!y)return;let w=[];async function $(){if(o){E(d,"Lade Einstellungen…","loading");try{const t=await fetch(j,{credentials:"same-origin"});if(!t.ok)throw new Error(`Serverfehler (${t.status})`);const e=await t.json();o.elements.scrape_enabled.checked=!!e.scrape_enabled,o.elements.default_interval_minutes.value=e.default_interval_minutes??15,o.elements.max_sources_per_cycle.value=e.max_sources_per_cycle??0,h&&h.elements.interval_minutes.value===""&&(h.elements.interval_minutes.placeholder=e.default_interval_minutes??""),E(d,"","idle")}catch(t){E(d,t.message||"Einstellungen konnten nicht geladen werden","error")}}}async function _(t){if(t.preventDefault(),!o)return;E(d,"Speichere…","loading");const e={scrape_enabled:o.elements.scrape_enabled.checked,default_interval_minutes:M(o.elements.default_interval_minutes.value),max_sources_per_cycle:M(o.elements.max_sources_per_cycle.value)};try{const i=await fetch(j,{method:"PUT",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!i.ok)throw new Error(`Serverfehler (${i.status})`);await i.json(),E(d,"Einstellungen gespeichert","success")}catch(i){E(d,i.message||"Speichern fehlgeschlagen","error")}}async function b(){if(y){E(f,"Lade Quellen…","loading");try{const t=await fetch(A,{credentials:"same-origin"});if(!t.ok)throw new Error(`Serverfehler (${t.status})`);const e=await t.json();w=Array.isArray(e)?e:[],u(),E(f,"","idle")}catch(t){E(f,t.message||"Quellen konnten nicht geladen werden","error")}}}function u(){if(!y)return;if(!w.length){y.innerHTML='<p class="sources-empty">Noch keine Quellen hinterlegt.</p>';return}const t=w.map(e=>{const i=e.enabled?"Aktiv":"Deaktiviert",S=e.enabled?"Deaktivieren":"Aktivieren",x=e.interval_minutes??0,L=e.last_run_at?new Date(e.last_run_at).toLocaleString():"–";return`
          <tr data-source-id="${e.id}">
            <td>${e.name}</td>
            <td>${e.type.toUpperCase()}</td>
            <td><a href="${e.endpoint}" target="_blank" rel="noopener">${e.endpoint}</a></td>
            <td>${x} min</td>
            <td>${i}</td>
            <td>${L}</td>
            <td class="actions">
              <button type="button" class="button" data-action="toggle" data-id="${e.id}">${S}</button>
              <button type="button" class="button" data-action="delete" data-id="${e.id}">Entfernen</button>
            </td>
          </tr>
        `}).join("");y.innerHTML=`
      <div class="table-wrapper">
        <table class="sources-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Typ</th>
              <th>Feed</th>
              <th>Intervall</th>
              <th>Status</th>
              <th>Letzter Lauf</th>
              <th>Aktionen</th>
            </tr>
          </thead>
          <tbody>${t}</tbody>
        </table>
      </div>
    `}async function s(t){if(t.preventDefault(),!h)return;E(f,"Speichere Quelle…","loading");const e={name:h.elements.name.value,type:h.elements.type.value,endpoint:h.elements.endpoint.value,enabled:h.elements.enabled.checked},i=M(h.elements.interval_minutes.value);i!==void 0&&(e.interval_minutes=i);try{const S=await fetch(A,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!S.ok)throw new Error(`Serverfehler (${S.status})`);await S.json(),h.reset(),E(f,"Quelle gespeichert","success"),await b()}catch(S){E(f,S.message||"Quelle konnte nicht gespeichert werden","error")}}async function v(t){const e=w.find(i=>i.id===t);if(e){E(f,"Aktualisiere Quelle…","loading");try{const i=await fetch(`${A}/${t}`,{method:"PUT",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify({enabled:!e.enabled})});if(!i.ok)throw new Error(`Serverfehler (${i.status})`);await i.json(),E(f,"Quelle aktualisiert","success"),await b()}catch(i){E(f,i.message||"Aktualisierung fehlgeschlagen","error")}}}async function c(t){E(f,"Lösche Quelle…","loading");try{const e=await fetch(`${A}/${t}`,{method:"DELETE",credentials:"same-origin"});if(!e.ok)throw new Error(`Serverfehler (${e.status})`);E(f,"Quelle entfernt","success"),await b()}catch(e){E(f,e.message||"Quelle konnte nicht entfernt werden","error")}}o&&(o.addEventListener("submit",_),$()),h&&h.addEventListener("submit",s),y&&(y.addEventListener("click",t=>{const e=t.target.closest("[data-action]");if(!e)return;const i=Number.parseInt(e.dataset.id,10);Number.isNaN(i)||(e.dataset.action==="toggle"?v(i):e.dataset.action==="delete"&&c(i))}),b())}const U=document.body.dataset.page||"",Q={"ui.graph":q,"ui.patterns":O,"ui.heatmap":B,"ui.overview":F,"ui.admin":P};function R(){const o=document.querySelector("button[data-theme-toggle]");if(!o)return;const d=window.matchMedia("(prefers-color-scheme: dark)"),h="the-watcher-theme";function f(w){document.documentElement.setAttribute("data-theme",w),o.setAttribute("aria-pressed",w==="dark"?"true":"false"),o.querySelector("span[data-role='label']").textContent=w==="dark"?"Dark":"Light"}function y(){const w=localStorage.getItem(h);return w==="light"||w==="dark"?w:d.matches?"dark":"light"}f(y()),o.addEventListener("click",()=>{const w=y()==="dark"?"light":"dark";localStorage.setItem(h,w),f(w)}),d.addEventListener("change",()=>{localStorage.getItem(h)||f(d.matches?"dark":"light")})}requestAnimationFrame(()=>{R();const o=Q[U];o&&o()});
