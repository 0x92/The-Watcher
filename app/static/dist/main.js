function ne(){const t=window.cytoscape;if(!t){console.warn("Cytoscape not available � skipping graph init");return}const r=document.getElementById("graph-filters"),c=document.getElementById("graph"),s=document.querySelector("#graph-summary .status-message"),p=document.querySelector("#graph-summary .graph-stats"),h=document.getElementById("graph-refresh"),l=document.getElementById("graph-reload"),o=document.getElementById("graph-export-png"),g=document.getElementById("graph-export-json");if(!r||!c||!s||!p)return;let f=b(c),u=null,E=null,v=!1;function b(i){return t({container:i,wheelSensitivity:.2,maxZoom:3,minZoom:.2,style:[{selector:"node",style:{label:"data(label)","text-valign":"center","text-halign":"center","font-size":"12px","text-wrap":"wrap","text-max-width":"120px",color:"#0f172a","background-color":"#2563eb",width:"mapData(value, 0, 50, 24, 96)",height:"mapData(value, 0, 50, 24, 96)","border-width":2,"border-color":"#1e293b"}},{selector:"node[kind = 'tag']",style:{"background-color":"#22c55e","border-color":"#166534"}},{selector:"node[kind = 'alert']",style:{"background-color":"#f97316","border-color":"#c2410c"}},{selector:"node:selected",style:{"border-width":4,"border-color":"#0ea5e9","shadow-blur":16,"shadow-color":"#38bdf8","shadow-opacity":.6}},{selector:"edge",style:{width:"mapData(weight, 0, 20, 1, 6)","line-color":"#94a3b8","curve-style":"bezier","target-arrow-shape":"triangle","target-arrow-color":"#94a3b8",opacity:.8}},{selector:"edge[kind = 'source_tag']",style:{"line-color":"#38bdf8","target-arrow-color":"#38bdf8"}},{selector:"edge[kind = 'source_alert']",style:{"line-color":"#facc15","target-arrow-color":"#facc15"}}]})}function y(){const i=new FormData(r),m=[];r.querySelectorAll("input[name='role']").forEach(S=>{S.checked&&m.push(S.value)});const w=Math.max(1,Math.min(Number(i.get("limit"))||50,200));return{window:i.get("window")||"24h",limit:w,roles:m,refresh:Number(i.get("refresh"))||0}}function $(i){const m=new URLSearchParams;return i.window&&m.set("window",i.window),m.set("limit",String(i.limit)),i.roles.forEach(w=>m.append("role",w)),m.toString()}function L(i,m){s.dataset.state=i,s.textContent=m}function A(i){const m=new Date,w={nodes:i.nodes.length,edges:i.edges.length,sources:i.nodes.filter(S=>S.kind==="source").length,tags:i.nodes.filter(S=>S.kind==="tag").length,alerts:i.nodes.filter(S=>S.kind==="alert").length};p.innerHTML=`
      <div><strong>Knoten:</strong> ${w.nodes}</div>
      <div><strong>Kanten:</strong> ${w.edges}</div>
      <div><strong>Quellen:</strong> ${w.sources}</div>
      <div><strong>Tags:</strong> ${w.tags}</div>
      <div><strong>Alerts:</strong> ${w.alerts}</div>
      <div><small>Stand: ${m.toLocaleTimeString()}</small></div>
    `}async function k(){if(v)return;const i=y();L("loading","Lade Graph..."),v=!0;try{const m=$(i),w=await fetch(`/api/graph?${m}`,{cache:"no-store",headers:{Accept:"application/json"}});if(!w.ok)throw new Error(`Server antwortete mit ${w.status}`);const S=await w.json();E=S,_(S),A(S),L("idle","Aktualisiert.")}catch(m){console.error("Graph fetch failed",m),L("error",m&&m.message?m.message:"Unbekannter Fehler")}finally{v=!1}}function _(i){const m=[];i.nodes.forEach(S=>{m.push({data:{id:S.id,label:S.label,kind:S.kind,value:S.value,meta:S.meta||{}}})}),i.edges.forEach(S=>{m.push({data:{id:`${S.source}->${S.target}:${S.kind}`,source:S.source,target:S.target,weight:S.weight,kind:S.kind,meta:S.meta||{}}})}),f.elements().remove(),f.add(m),f.layout({name:"cose",animate:!1,padding:30,fit:!0,randomize:m.length>150}).run()}function N(i){u&&(clearInterval(u),u=null),i>0&&(u=setInterval(()=>{document.hidden||k()},i*1e3))}function x(){const i=y();N(i.refresh)}function e(i,m){const w=document.createElement("a");w.href=m,w.download=i,document.body.appendChild(w),w.click(),document.body.removeChild(w)}function n(){if(!f)return;const i=f.png({scale:2,bg:"#ffffff"});e(`graph-${Date.now()}.png`,i)}function a(){if(!E){L("error","Keine Daten zum Exportieren verfuegbar.");return}const i=new Blob([JSON.stringify(E,null,2)],{type:"application/json"}),m=URL.createObjectURL(i);e(`graph-${Date.now()}.json`,m),setTimeout(()=>URL.revokeObjectURL(m),1e3)}function d(){r.addEventListener("change",i=>{const m=i.target;(m.matches("input[name='role']")||m.matches("select[name='window']")||m.matches("input[name='limit']"))&&k(),m===h&&x()}),l==null||l.addEventListener("click",()=>{k()}),o==null||o.addEventListener("click",()=>{n()}),g==null||g.addEventListener("click",()=>{a()}),f.on("tap","node",i=>{const m=i.target.data(),w=`${m.label} (${m.kind}) - Wert ${m.value}`;L("info",w)}),document.addEventListener("visibilitychange",()=>{document.hidden?u&&(clearInterval(u),u=null):(x(),k())})}d(),x(),k()}function re(){const t=document.getElementById("patterns-filters"),r=document.getElementById("patterns-list"),c=document.querySelector("#patterns-container .status-message"),s=document.getElementById("patterns-reload");if(!t||!r||!c||!s)return;function p(f,u){c.dataset.state=f,c.textContent=u}function h(){const f=new FormData(t),u=f.get("window")||"24h",E=Math.max(1,Math.min(Number(f.get("limit"))||10,50));return{window:u,limit:E}}function l(f){const u=new URLSearchParams;return u.set("window",f.window),u.set("limit",String(f.limit)),u.toString()}function o(f){if(r.innerHTML="",!f.length){const u=document.createElement("p");u.className="empty-state",u.textContent="Keine Muster gefunden.",r.appendChild(u);return}f.forEach(u=>{var k,_,N;const E=document.createElement("article");E.className="pattern-card";const v=document.createElement("h2");v.textContent=u.label||"Unbenanntes Muster",E.appendChild(v);const b=document.createElement("p");b.className="pattern-meta";const y=new Date(u.created_at),$=typeof u.anomaly_score=="number"?u.anomaly_score.toFixed(3):"-",L=((k=u.meta)==null?void 0:k.size)??((_=u.item_ids)==null?void 0:_.length)??0;b.textContent=`Anomalie-Score: ${$} � Gr��e: ${L} � ${y.toLocaleString()}`,E.appendChild(b);const A=document.createElement("ul");if(A.className="pattern-terms",(u.top_terms||[]).forEach(x=>{const e=document.createElement("li");e.textContent=x,A.appendChild(e)}),E.appendChild(A),(N=u.item_ids)!=null&&N.length){const x=document.createElement("p");x.className="pattern-items",x.textContent=`Beobachtete Items: ${u.item_ids.join(", ")}`,E.appendChild(x)}r.appendChild(E)})}async function g(){var u,E;const f=h();p("loading","Lade Muster...");try{const v=l(f),b=await fetch(`/api/patterns/latest?${v}`,{cache:"no-store",headers:{Accept:"application/json"}});if(!b.ok)throw new Error(`Server antwortete mit ${b.status}`);const y=await b.json();o(y.patterns||[]);const $=((u=y.meta)==null?void 0:u.count)??((E=y.patterns)==null?void 0:E.length)??0;p("idle",`Aktualisiert (${$}).`)}catch(v){console.error("Pattern fetch failed",v),p("error",v&&v.message?v.message:"Unbekannter Fehler")}}t.addEventListener("change",f=>{(f.target.matches("select[name='window']")||f.target.matches("input[name='limit']"))&&g()}),s.addEventListener("click",()=>{g()}),g()}function ae(){var N,x;const t=document.getElementById("heatmap-filters"),r=document.getElementById("heatmap-chart"),c=document.getElementById("timeline-chart"),s=document.querySelector("#heatmap-dashboard .status-message"),p=document.querySelector("#heatmap-meta .heatmap-stats"),h=document.getElementById("heatmap-reload");if(!t||!r||!c||!s||!p||!h)return;const l=(N=window.echarts)==null?void 0:N.init(r),o=(x=window.echarts)==null?void 0:x.init(c);if(!l||!o){console.warn("ECharts not available � skipping heatmap init");return}let g=null;function f(e,n){s.dataset.state=e,s.textContent=n}function u(){const e=new FormData(t),n=e.get("interval")||"24h",a=Math.max(0,Number(e.get("value_min"))||0),d=Number(e.get("refresh"))||0,i=(e.get("sources")||"").split(",").map(m=>m.trim()).filter(Boolean);return{interval:n,valueMin:a,refresh:d,sources:i}}function E(e){const n=new URLSearchParams;return n.set("interval",e.interval),n.set("value_min",String(e.valueMin)),e.sources.length&&n.set("sources",e.sources.join(",")),n}function v(e){const n=[["Buckets",e.bucket_count??"-"],["Bucket-Minuten",e.bucket_minutes??"-"],["Items",e.item_count??0],["Alerts",e.event_count??0]];e.source_totals&&Object.entries(e.source_totals).slice(0,8).forEach(([a,d])=>n.push([a,d])),p.innerHTML=n.map(([a,d])=>`<dt>${a}</dt><dd>${d}</dd>`).join("")}function b(e){const n=e.buckets||[],a=e.series?e.series.map(w=>w.source):[];if(!n.length||!a.length){l.clear(),l.setOption({title:{text:"Keine Daten im ausgew�hlten Zeitraum",left:"center",textStyle:{color:"#64748b"}}});return}const d=n.map(w=>new Date(w).toLocaleString()),i=[];let m=0;e.series.forEach((w,S)=>{w.counts.forEach((T,O)=>{i.push([O,S,T]),T>m&&(m=T)})}),l.setOption({tooltip:{position:"top",formatter:w=>{const S=w.data[2];return S?`${a[w.data[1]]}<br>${d[w.data[0]]}<br>Events: ${S}`:"Keine Ereignisse"}},grid:{left:90,right:20,top:20,bottom:60},xAxis:{type:"category",data:d,axisLabel:{rotate:-45,color:"#475569"}},yAxis:{type:"category",data:a,axisLabel:{color:"#475569"}},visualMap:{min:0,max:Math.max(1,m),calculable:!0,orient:"horizontal",left:"center",bottom:10},series:[{name:"Events",type:"heatmap",data:i,label:{show:!0,color:"#0f172a",formatter:w=>w.data[2]?String(w.data[2]):""},emphasis:{itemStyle:{shadowBlur:10,shadowColor:"rgba(0, 0, 0, 0.5)"}}}]})}function y(e){const n=(e.timeline||[]).map(d=>({value:[d.at,d.severity||0],alert:d.alert,severity:d.severity||0}));if(!n.length){o.clear(),o.setOption({title:{text:"Keine Alerts",left:"center",textStyle:{color:"#64748b"}}});return}const a=Math.max(...n.map(d=>d.severity),1);o.setOption({tooltip:{trigger:"item",formatter:d=>{const i=new Date(d.value[0]);return`${d.data.alert}<br>${i.toLocaleString()}<br>Severity: ${d.data.severity}`}},xAxis:{type:"time",axisLabel:{color:"#475569"}},yAxis:{type:"value",min:0,max:Math.max(a,1),axisLabel:{show:!1},splitLine:{show:!1}},series:[{type:"scatter",data:n,symbolSize:d=>10+(d[1]||0)*4,itemStyle:{color:"#f97316"}}]})}function $(e){var n;b(e),y(e),v(e.meta||{}),f("idle",`Aktualisiert (${((n=e.meta)==null?void 0:n.item_count)??0} Items)`)}async function L(){const e=u(),n=E(e);f("loading","Lade Daten...");const a=await fetch(`/api/analytics/heatmap?${n.toString()}`,{cache:"no-store",headers:{Accept:"application/json"}});if(!a.ok)throw new Error(`Server antwortete mit ${a.status}`);const d=await a.json();return $(d),e}function A(){g&&(g.close(),g=null)}function k(e){if(A(),!e.refresh)return;const n=E(e);n.set("refresh",String(e.refresh)),g=new EventSource(`/stream/analytics/heatmap?${n.toString()}`),g.onmessage=a=>{try{const d=JSON.parse(a.data);if(d.error){f("error",d.error);return}$(d)}catch(d){console.error("SSE parse failed",d)}},g.onerror=()=>{f("error","Stream unterbrochen"),A()}}function _(){L().then(e=>{k(e)}).catch(e=>{console.error("Heatmap fetch failed",e),f("error",e.message||"Unbekannter Fehler")})}t.addEventListener("change",e=>{(e.target.matches("select[name='interval']")||e.target.matches("input[name='value_min']")||e.target.matches("select[name='refresh']")||e.target.matches("input[name='sources']"))&&_()}),h.addEventListener("click",()=>{_()}),window.addEventListener("beforeunload",()=>{A()}),_()}function se(){const t=document.querySelector("[data-overview-status]"),r=document.querySelector("[data-overview]");if(!t||!r)return;const c=v=>r.querySelector(`[data-metric="${v}"]`),s=document.querySelector("[data-overview-alerts]"),p=document.querySelector("[data-overview-patterns]");function h(v,b){t.dataset.state=v,t.textContent=b}async function l(v){const b=await fetch(v,{cache:"no-store",headers:{Accept:"application/json"}});if(!b.ok)throw new Error(`Request ${v} fehlgeschlagen (${b.status})`);return b.json()}function o(v,b){const y=c(v);y&&(y.textContent=b)}function g(v){if(s){if(!v.length){s.innerHTML="<li>Keine Alerts im Zeitraum.</li>";return}s.innerHTML=v.slice(-5).reverse().map(b=>{const y=new Date(b.at).toLocaleString(),$=b.severity!=null?`<span class="badge">S${b.severity}</span>`:"";return`<li><div>${b.alert} ${$}</div><small>${y}</small></li>`}).join("")}}function f(v){if(p){if(!v.length){p.innerHTML="<li>Keine Muster gefunden.</li>";return}p.innerHTML=v.slice(0,5).map(b=>{const y=b.anomaly_score!=null?b.anomaly_score.toFixed(3):"-";return`<li><div>${b.label||"Muster"}</div><small>Score ${y}</small></li>`}).join("")}}async function u(){var v,b;try{h("loading","Aktualisiere �bersicht...");const[y,$,L]=await Promise.all([l("/api/graph?limit=100&window=24h"),l("/api/analytics/heatmap?interval=24h&value_min=0"),l("/api/patterns/latest?window=24h&limit=10")]),A=new Set((y.nodes||[]).filter(_=>_.kind==="source").map(_=>_.id)).size;o("sources",A||0),o("items",((v=$.meta)==null?void 0:v.item_count)??0),o("alerts",((b=$.meta)==null?void 0:b.event_count)??0);const k=(L.patterns||[])[0];o("pattern-score",k&&k.anomaly_score!=null?k.anomaly_score.toFixed(3):"-"),g($.timeline||[]),f(L.patterns||[]),h("idle","Live-Daten synchronisiert.")}catch(y){console.error("overview load failed",y),h("error",y.message||"�bersicht konnte nicht geladen werden.")}}u();const E=setInterval(u,6e4);window.addEventListener("beforeunload",()=>clearInterval(E))}const H="/api/admin/worker-settings",z="/api/admin/workers",j="/api/admin/sources";function C(t,r,c="idle"){t&&(t.textContent=r,t.dataset.state=c,t.hidden=!r)}function R(t){const r=Number.parseInt(t,10);return Number.isNaN(r)?void 0:r}function I(t){return t==null?"":String(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function F(t){if(!t)return"Stand: –";const r=new Date(t);return Number.isNaN(r.getTime())?"Stand: –":`Stand: ${r.toLocaleString()}`}function Q(t,r){if(!Array.isArray(r)||r.length===0)return`<div class="worker-task-group"><h3>${t}</h3><p class="worker-task-empty">Keine Einträge.</p></div>`;const c=r.map(s=>{const p=I(s.name||"Unbekannte Aufgabe"),h=s.id?` <span class="worker-task-id">#${I(s.id)}</span>`:"",l=[];s.eta&&l.push(`ETA ${I(s.eta)}`),s.queue&&l.push(`Queue ${I(s.queue)}`),typeof s.runtime=="number"&&!Number.isNaN(s.runtime)&&l.push(`${s.runtime.toFixed(1)}s`);const o=l.length?`<div class="worker-task-meta">${l.join(" • ")}</div>`:"",g=[];s.args&&g.push(`<code>${I(s.args)}</code>`),s.kwargs&&s.kwargs!=="{}"&&g.push(`<code>${I(s.kwargs)}</code>`);const f=g.length?`<div class="worker-task-payload">${g.join(" ")}</div>`:"";return`<li><div class="worker-task-head">${p}${h}</div>${o}${f}</li>`}).join("");return`<div class="worker-task-group"><h3>${t}</h3><ul class="worker-task-list">${c}</ul></div>`}function oe(){const t=document.querySelector("[data-worker-form]"),r=document.querySelector("[data-worker-status]"),c=document.querySelector("[data-worker-overview-status]"),s=document.querySelector("[data-workers-list]"),p=document.querySelector("[data-worker-updated]"),h=document.querySelector("[data-worker-refresh]"),l=document.querySelector("[data-source-form]"),o=document.querySelector("[data-source-status]"),g=document.querySelector("[data-sources-list]");if(!t&&!l&&!g&&!s)return;let f=[],u=[],E={updatedAt:null,status:"idle",message:""};async function v(){if(t){C(r,"Lade Einstellungen…","loading");try{const e=await fetch(H,{credentials:"same-origin"});if(!e.ok)throw new Error(`Serverfehler (${e.status})`);const n=await e.json();t.elements.scrape_enabled.checked=!!n.scrape_enabled,t.elements.default_interval_minutes.value=n.default_interval_minutes??15,t.elements.max_sources_per_cycle.value=n.max_sources_per_cycle??0,l&&l.elements.interval_minutes.value===""&&(l.elements.interval_minutes.placeholder=n.default_interval_minutes??""),C(r,"","idle")}catch(e){C(r,e.message||"Einstellungen konnten nicht geladen werden","error")}}}async function b(e){if(e.preventDefault(),!t)return;C(r,"Speichere…","loading");const n={scrape_enabled:t.elements.scrape_enabled.checked,default_interval_minutes:R(t.elements.default_interval_minutes.value),max_sources_per_cycle:R(t.elements.max_sources_per_cycle.value)};try{const a=await fetch(H,{method:"PUT",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!a.ok)throw new Error(`Serverfehler (${a.status})`);await a.json(),C(r,"Einstellungen gespeichert","success")}catch(a){C(r,a.message||"Speichern fehlgeschlagen","error")}}async function y(){if(s){C(c,"Lade Worker…","loading");try{const e=await fetch(z,{credentials:"same-origin"});if(!e.ok)throw new Error(`Serverfehler (${e.status})`);const n=await e.json();u=Array.isArray(n.workers)?n.workers:[],E={updatedAt:n.updated_at||null,status:n.status||"ok",message:n.message||""},$(),p&&(p.textContent=F(E.updatedAt));const a=E.status==="ok"?"idle":"error";C(c,E.message||"",a)}catch(e){C(c,e.message||"Worker konnten nicht geladen werden","error"),p&&(p.textContent=F(null)),u=[],$()}}}function $(){if(!s)return;if(!u.length){s.innerHTML='<p class="workers-empty">Keine Worker gefunden.</p>';return}const n=[...u].sort((a,d)=>{const i=String(a.name||a.id||""),m=String(d.name||d.id||"");return i.localeCompare(m,"de-DE")}).map(a=>{const d=a.name||a.id||"Unbekannter Worker",i=a.online?"Online":"Offline",m=a.online?"worker-status worker-status--online":"worker-status worker-status--offline",w=Number.isFinite(a.active_processes)?a.active_processes:0,S=Number.isFinite(a.configured_processes)?a.configured_processes:null,T=S!==null?`${w} / ${S}`:`${w}`,O=Array.isArray(a.queues)&&a.queues.length?a.queues.map(te=>I(te)).join(", "):"–",G=Array.isArray(a.active_tasks)?a.active_tasks.length:0,J=Array.isArray(a.reserved_tasks)?a.reserved_tasks.length:0,Z=Array.isArray(a.scheduled_tasks)?a.scheduled_tasks.length:0,P=!!a.online,V=!P||(S!==null?w>=S:w>0),X=!P||w<=0,Y=!P,B=Number.isFinite(a.total_tasks)?a.total_tasks:null,M=[];a.pid&&M.push(`PID ${I(a.pid)}`),B!==null&&M.push(`${B} Aufgaben insgesamt`);const ee=M.length?`<span>${M.join(" • ")}</span>`:"";return`
          <article class="worker-card" data-worker-card data-worker-name="${I(a.id||d)}">
            <header class="worker-card__header">
              <div>
                <h3>${I(d)}</h3>
                <p class="worker-card__meta">
                  <span class="${m}">${i}</span>
                  ${ee}
                </p>
              </div>
              <div class="worker-card__actions">
                <button type="button" class="button" data-worker-command="start" ${V?"disabled":""}>Starten</button>
                <button type="button" class="button" data-worker-command="restart" ${Y?"disabled":""}>Neustarten</button>
                <button type="button" class="button" data-worker-command="stop" ${X?"disabled":""}>Stoppen</button>
              </div>
            </header>
            <dl class="worker-card__stats">
              <div><dt>Status</dt><dd>${i}</dd></div>
              <div><dt>Prozesse</dt><dd>${I(T)}</dd></div>
              <div><dt>Queues</dt><dd>${O}</dd></div>
              <div><dt>Aktiv</dt><dd>${G}</dd></div>
              <div><dt>Reserviert</dt><dd>${J}</dd></div>
              <div><dt>Geplant</dt><dd>${Z}</dd></div>
            </dl>
            ${Q("Aktive Tasks",a.active_tasks)}
            ${Q("Geplante Tasks",a.scheduled_tasks)}
          </article>
        `}).join("");s.innerHTML=n}async function L(e,n,a){if(!(!e||!n)){a&&(a.disabled=!0),C(c,`Sende ${n}…`,"loading");try{const d=await fetch(`${z}/${encodeURIComponent(e)}/control`,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:n})}),i=await d.json();if(!d.ok)throw new Error(i.error||`Serverfehler (${d.status})`);await y(),C(c,i.message||"Befehl ausgeführt","success")}catch(d){C(c,d.message||"Befehl fehlgeschlagen","error")}finally{a&&(a.disabled=!1)}}}async function A(){if(g){C(o,"Lade Quellen…","loading");try{const e=await fetch(j,{credentials:"same-origin"});if(!e.ok)throw new Error(`Serverfehler (${e.status})`);const n=await e.json();f=Array.isArray(n)?n:[],k(),C(o,"","idle")}catch(e){C(o,e.message||"Quellen konnten nicht geladen werden","error")}}}function k(){if(!g)return;if(!f.length){g.innerHTML='<p class="sources-empty">Noch keine Quellen hinterlegt.</p>';return}const e=f.map(n=>{const a=n.enabled?"Aktiv":"Deaktiviert",d=n.enabled?"Deaktivieren":"Aktivieren",i=n.interval_minutes??0,m=n.last_run_at?new Date(n.last_run_at).toLocaleString():"–";return`
          <tr data-source-id="${n.id}">
            <td>${I(n.name)}</td>
            <td>${I(n.type.toUpperCase())}</td>
            <td><a href="${I(n.endpoint)}" target="_blank" rel="noopener">${I(n.endpoint)}</a></td>
            <td>${i} min</td>
            <td>${a}</td>
            <td>${m}</td>
            <td class="actions">
              <button type="button" class="button" data-action="toggle" data-id="${n.id}">${d}</button>
              <button type="button" class="button" data-action="delete" data-id="${n.id}">Entfernen</button>
            </td>
          </tr>
        `}).join("");g.innerHTML=`
      <div class="table-wrapper">
        <table class="sources-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Typ</th>
              <th>Feed</th>
              <th>Intervall</th>
              <th>Status</th>
              <th>Letzter Lauf</th>
              <th>Aktionen</th>
            </tr>
          </thead>
          <tbody>${e}</tbody>
        </table>
      </div>
    `}async function _(e){if(e.preventDefault(),!l)return;C(o,"Speichere Quelle…","loading");const n={name:l.elements.name.value,type:l.elements.type.value,endpoint:l.elements.endpoint.value,enabled:l.elements.enabled.checked},a=R(l.elements.interval_minutes.value);a!==void 0&&(n.interval_minutes=a);try{const d=await fetch(j,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!d.ok)throw new Error(`Serverfehler (${d.status})`);await d.json(),l.reset(),C(o,"Quelle gespeichert","success"),await A()}catch(d){C(o,d.message||"Quelle konnte nicht gespeichert werden","error")}}async function N(e){const n=f.find(a=>a.id===e);if(n){C(o,"Aktualisiere Quelle…","loading");try{const a=await fetch(`${j}/${e}`,{method:"PUT",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify({enabled:!n.enabled})});if(!a.ok)throw new Error(`Serverfehler (${a.status})`);await a.json(),C(o,"Quelle aktualisiert","success"),await A()}catch(a){C(o,a.message||"Aktualisierung fehlgeschlagen","error")}}}async function x(e){C(o,"Lösche Quelle…","loading");try{const n=await fetch(`${j}/${e}`,{method:"DELETE",credentials:"same-origin"});if(!n.ok)throw new Error(`Serverfehler (${n.status})`);C(o,"Quelle entfernt","success"),await A()}catch(n){C(o,n.message||"Quelle konnte nicht entfernt werden","error")}}t&&(t.addEventListener("submit",b),v()),s&&(s.addEventListener("click",e=>{const n=e.target.closest("[data-worker-command]");if(!n)return;const a=n.closest("[data-worker-card]");if(!a)return;const d=a.dataset.workerName,i=n.dataset.workerCommand;L(d,i,n)}),y()),h&&h.addEventListener("click",()=>{y()}),p&&(p.textContent=F(E.updatedAt)),l&&l.addEventListener("submit",_),g&&(g.addEventListener("click",e=>{const n=e.target.closest("[data-action]");if(!n)return;const a=Number.parseInt(n.dataset.id,10);Number.isNaN(a)||(n.dataset.action==="toggle"?N(a):n.dataset.action==="delete"&&x(a))}),A())}const W=25,ie=20,ce=120;function q(t){const r=Date.now()-t.getTime();if(Number.isNaN(r))return"";const c=60*1e3,s=60*c,p=24*s;return r<c?"gerade eben":r<s?`${Math.round(r/c)} Min.`:r<p?`${Math.round(r/s)} Std.`:`${Math.round(r/p)} Tg.`}function le(t){if(!t)return null;const r=Date.now();if(t.endsWith("h")&&Number.isFinite(Number.parseInt(t,10))){const c=Number.parseInt(t,10);return new Date(r-c*60*60*1e3).toISOString()}if(t.endsWith("d")&&Number.isFinite(Number.parseInt(t,10))){const c=Number.parseInt(t,10);return new Date(r-c*24*60*60*1e3).toISOString()}return null}function de(t){const r=new FormData(t),c=new URLSearchParams,s=r.get("range"),p=le(typeof s=="string"?s:"");p&&c.set("from",p);for(const[h,l]of r.entries())!l||h==="range"||c.set(h,l);return c.set("page","1"),c.set("size",String(W)),c}function K(t,r){t&&(t.textContent=`${r} ${r===1?"Eintrag":"Einträge"}`)}function D(t,r,c){t&&(t.dataset.state=r,t.textContent=c)}function ue(t){const r=document.createElement("li");r.className="feed-item",r.dataset.itemId=String(t.id||"");const c=t.fetched_at?new Date(t.fetched_at):null,s=document.createElement("div");s.className="feed-item__meta";const p=document.createElement("span");if(p.className="feed-item__source",p.textContent=t.source||"Quelle unbekannt",s.appendChild(p),t.lang){const o=document.createElement("span");o.className="feed-item__lang",o.textContent=t.lang,s.appendChild(o)}if(c){const o=document.createElement("span");o.className="feed-item__time",o.dataset.fetchedAt=c.toISOString(),o.textContent=q(c),o.title=c.toLocaleString(),s.appendChild(o)}r.appendChild(s);const h=document.createElement("h3");h.className="feed-item__title";const l=document.createElement("a");if(l.href=t.url||"#",l.target="_blank",l.rel="noopener noreferrer",l.textContent=t.title||t.url||"Unbenanntes Item",h.appendChild(l),r.appendChild(h),t.published_at){const o=document.createElement("div");o.className="feed-item__time";const g=new Date(t.published_at);o.dataset.publishedAt=g.toISOString(),o.textContent=`Publiziert ${q(g)}`,o.title=g.toLocaleString(),r.appendChild(o)}if(t.gematria&&typeof t.gematria=="object"){const o=Object.entries(t.gematria);if(o.length){o.sort((f,u)=>f[0].localeCompare(u[0]));const g=document.createElement("ul");g.className="feed-item__gematria";for(const[f,u]of o){const E=document.createElement("li");E.textContent=`${f}: ${u}`,g.appendChild(E)}r.appendChild(g)}}return r}function U(t){t.querySelectorAll(".feed-item__time[data-fetched-at]").forEach(s=>{const p=s.dataset.fetchedAt;if(!p)return;const h=new Date(p);s.textContent=q(h)}),t.querySelectorAll(".feed-item__time[data-published-at]").forEach(s=>{const p=s.dataset.publishedAt;if(!p)return;const h=new Date(p);s.textContent=`Publiziert ${q(h)}`})}function me(){const t=document.querySelector("[data-stream-feed]"),r=document.querySelector("[data-stream-list]"),c=document.querySelector("[data-stream-filter]"),s=document.querySelector("[data-stream-status]"),p=document.querySelector("[data-stream-counter]");if(!t||!r||!c||!s)return;const h=new Set;let l=null,o=null,g=null;function f(){l&&(l.close(),l=null)}function u(y,{replace:$=!1,prepend:L=!1}={}){if(!Array.isArray(y))return;if($&&(h.clear(),r.innerHTML="",o=null),!y.length){r.setAttribute("aria-busy","false"),r.children.length||(r.innerHTML='<li class="empty-state">Keine Einträge gefunden.</li>');return}r.querySelector(".empty-state")&&(r.innerHTML="");const A=L?[...y].reverse():y;for(const k of A){if(!k||typeof k.id>"u"||h.has(k.id))continue;const _=ue(k);L?r.prepend(_):r.append(_),h.add(k.id)}for(;r.children.length>ce;){const k=r.lastElementChild;if(!k)break;const _=Number.parseInt(k.dataset.itemId||"",10);Number.isNaN(_)||h.delete(_),r.removeChild(k)}r.setAttribute("aria-busy","false"),K(p,h.size)}async function E(y){const $=new URL("/api/items",window.location.origin);$.search=y.toString(),r.setAttribute("aria-busy","true");const L=await fetch($.toString(),{headers:{Accept:"application/json"},cache:"no-store"});if(!L.ok){let _=`Request ${$.pathname} fehlgeschlagen (${L.status})`;try{const N=await L.json();N&&typeof N.error=="string"&&(_=N.error)}catch(N){console.warn("Could not parse error payload",N)}throw new Error(_)}const A=await L.json(),k=Array.isArray(A.items)?A.items:[];return u(k,{replace:!0}),o=k.reduce((_,N)=>N&&N.id>_?N.id:_,o||0),K(p,h.size),A}function v(y){f();const $=new URLSearchParams(y);$.set("limit",String(ie)),o&&$.set("after_id",String(o));const L=`/stream/live?${$.toString()}`;l=new EventSource(L),l.onopen=()=>{D(s,"idle","Live-Verbindung aktiv.")},l.onerror=()=>{D(s,"loading","Verbindung unterbrochen, versuche erneut...")},l.onmessage=A=>{if(A.data)try{const k=JSON.parse(A.data),_=Array.isArray(k.items)?k.items:[];if(!_.length)return;u(_,{prepend:!0});const N=_.reduce((e,n)=>n&&n.id>e?n.id:e,0),x=typeof k.cursor=="number"?k.cursor:0;o=Math.max(o||0,N,x)}catch(k){console.error("stream payload parse failed",k)}}}async function b(){try{f(),g&&(clearInterval(g),g=null),D(s,"loading","Aktualisiere Live-Feed...");const y=de(c);y.set("size",String(W));const $=await E(y);(Array.isArray($.items)?$.items.length:0)?D(s,"idle","Live-Daten synchronisiert."):D(s,"idle","Keine Items im Zeitraum gefunden."),v(y),g=window.setInterval(()=>U(r),6e4),U(r)}catch(y){console.error("stream load failed",y),D(s,"error",y.message||"Live-Feed konnte nicht geladen werden.")}}c.addEventListener("submit",y=>{y.preventDefault(),b()}),c.addEventListener("reset",()=>{window.setTimeout(()=>{b()},0)}),b(),window.addEventListener("beforeunload",()=>{f(),g&&clearInterval(g)}),t.addEventListener("mouseleave",()=>U(r))}const he=document.body.dataset.page||"",fe={"ui.graph":ne,"ui.patterns":re,"ui.heatmap":ae,"ui.overview":se,"ui.admin":oe,"ui.stream":me};function pe(){const t=document.querySelector("button[data-theme-toggle]");if(!t)return;const r=window.matchMedia("(prefers-color-scheme: dark)"),c="the-watcher-theme";function s(h){document.documentElement.setAttribute("data-theme",h),t.setAttribute("aria-pressed",h==="dark"?"true":"false"),t.querySelector("span[data-role='label']").textContent=h==="dark"?"Dark":"Light"}function p(){const h=localStorage.getItem(c);return h==="light"||h==="dark"?h:r.matches?"dark":"light"}s(p()),t.addEventListener("click",()=>{const h=p()==="dark"?"light":"dark";localStorage.setItem(c,h),s(h)}),r.addEventListener("change",()=>{localStorage.getItem(c)||s(r.matches?"dark":"light")})}requestAnimationFrame(()=>{pe();const t=fe[he];t&&t()});
