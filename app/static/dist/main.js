function A(){const u=window.cytoscape;if(!u){console.warn("Cytoscape not available � skipping graph init");return}const g=document.getElementById("graph-filters"),b=document.getElementById("graph"),w=document.querySelector("#graph-summary .status-message"),y=document.querySelector("#graph-summary .graph-stats"),m=document.getElementById("graph-refresh"),S=document.getElementById("graph-reload"),E=document.getElementById("graph-export-png"),v=document.getElementById("graph-export-json");if(!g||!b||!w||!y)return;let l=i(b),a=null,p=null,o=!1;function i(t){return u({container:t,wheelSensitivity:.2,maxZoom:3,minZoom:.2,style:[{selector:"node",style:{label:"data(label)","text-valign":"center","text-halign":"center","font-size":"12px","text-wrap":"wrap","text-max-width":"120px",color:"#0f172a","background-color":"#2563eb",width:"mapData(value, 0, 50, 24, 96)",height:"mapData(value, 0, 50, 24, 96)","border-width":2,"border-color":"#1e293b"}},{selector:"node[kind = 'tag']",style:{"background-color":"#22c55e","border-color":"#166534"}},{selector:"node[kind = 'alert']",style:{"background-color":"#f97316","border-color":"#c2410c"}},{selector:"node:selected",style:{"border-width":4,"border-color":"#0ea5e9","shadow-blur":16,"shadow-color":"#38bdf8","shadow-opacity":.6}},{selector:"edge",style:{width:"mapData(weight, 0, 20, 1, 6)","line-color":"#94a3b8","curve-style":"bezier","target-arrow-shape":"triangle","target-arrow-color":"#94a3b8",opacity:.8}},{selector:"edge[kind = 'source_tag']",style:{"line-color":"#38bdf8","target-arrow-color":"#38bdf8"}},{selector:"edge[kind = 'source_alert']",style:{"line-color":"#facc15","target-arrow-color":"#facc15"}}]})}function h(){const t=new FormData(g),n=[];g.querySelectorAll("input[name='role']").forEach(s=>{s.checked&&n.push(s.value)});const r=Math.max(1,Math.min(Number(t.get("limit"))||50,200));return{window:t.get("window")||"24h",limit:r,roles:n,refresh:Number(t.get("refresh"))||0}}function k(t){const n=new URLSearchParams;return t.window&&n.set("window",t.window),n.set("limit",String(t.limit)),t.roles.forEach(r=>n.append("role",r)),n.toString()}function L(t,n){w.dataset.state=t,w.textContent=n}function _(t){const n=new Date,r={nodes:t.nodes.length,edges:t.edges.length,sources:t.nodes.filter(s=>s.kind==="source").length,tags:t.nodes.filter(s=>s.kind==="tag").length,alerts:t.nodes.filter(s=>s.kind==="alert").length};y.innerHTML=`
      <div><strong>Knoten:</strong> ${r.nodes}</div>
      <div><strong>Kanten:</strong> ${r.edges}</div>
      <div><strong>Quellen:</strong> ${r.sources}</div>
      <div><strong>Tags:</strong> ${r.tags}</div>
      <div><strong>Alerts:</strong> ${r.alerts}</div>
      <div><small>Stand: ${n.toLocaleTimeString()}</small></div>
    `}async function x(){if(o)return;const t=h();L("loading","Lade Graph..."),o=!0;try{const n=k(t),r=await fetch(`/api/graph?${n}`,{cache:"no-store",headers:{Accept:"application/json"}});if(!r.ok)throw new Error(`Server antwortete mit ${r.status}`);const s=await r.json();p=s,$(s),_(s),L("idle","Aktualisiert.")}catch(n){console.error("Graph fetch failed",n),L("error",n&&n.message?n.message:"Unbekannter Fehler")}finally{o=!1}}function $(t){const n=[];t.nodes.forEach(s=>{n.push({data:{id:s.id,label:s.label,kind:s.kind,value:s.value,meta:s.meta||{}}})}),t.edges.forEach(s=>{n.push({data:{id:`${s.source}->${s.target}:${s.kind}`,source:s.source,target:s.target,weight:s.weight,kind:s.kind,meta:s.meta||{}}})}),l.elements().remove(),l.add(n),l.layout({name:"cose",animate:!1,padding:30,fit:!0,randomize:n.length>150}).run()}function M(t){a&&(clearInterval(a),a=null),t>0&&(a=setInterval(()=>{document.hidden||x()},t*1e3))}function C(){const t=h();M(t.refresh)}function e(t,n){const r=document.createElement("a");r.href=n,r.download=t,document.body.appendChild(r),r.click(),document.body.removeChild(r)}function d(){if(!l)return;const t=l.png({scale:2,bg:"#ffffff"});e(`graph-${Date.now()}.png`,t)}function f(){if(!p){L("error","Keine Daten zum Exportieren verfuegbar.");return}const t=new Blob([JSON.stringify(p,null,2)],{type:"application/json"}),n=URL.createObjectURL(t);e(`graph-${Date.now()}.json`,n),setTimeout(()=>URL.revokeObjectURL(n),1e3)}function c(){g.addEventListener("change",t=>{const n=t.target;(n.matches("input[name='role']")||n.matches("select[name='window']")||n.matches("input[name='limit']"))&&x(),n===m&&C()}),S==null||S.addEventListener("click",()=>{x()}),E==null||E.addEventListener("click",()=>{d()}),v==null||v.addEventListener("click",()=>{f()}),l.on("tap","node",t=>{const n=t.target.data(),r=`${n.label} (${n.kind}) - Wert ${n.value}`;L("info",r)}),document.addEventListener("visibilitychange",()=>{document.hidden?a&&(clearInterval(a),a=null):(C(),x())})}c(),C(),x()}function j(){const u=document.getElementById("patterns-filters"),g=document.getElementById("patterns-list"),b=document.querySelector("#patterns-container .status-message"),w=document.getElementById("patterns-reload");if(!u||!g||!b||!w)return;function y(l,a){b.dataset.state=l,b.textContent=a}function m(){const l=new FormData(u),a=l.get("window")||"24h",p=Math.max(1,Math.min(Number(l.get("limit"))||10,50));return{window:a,limit:p}}function S(l){const a=new URLSearchParams;return a.set("window",l.window),a.set("limit",String(l.limit)),a.toString()}function E(l){if(g.innerHTML="",!l.length){const a=document.createElement("p");a.className="empty-state",a.textContent="Keine Muster gefunden.",g.appendChild(a);return}l.forEach(a=>{var x,$,M;const p=document.createElement("article");p.className="pattern-card";const o=document.createElement("h2");o.textContent=a.label||"Unbenanntes Muster",p.appendChild(o);const i=document.createElement("p");i.className="pattern-meta";const h=new Date(a.created_at),k=typeof a.anomaly_score=="number"?a.anomaly_score.toFixed(3):"-",L=((x=a.meta)==null?void 0:x.size)??(($=a.item_ids)==null?void 0:$.length)??0;i.textContent=`Anomalie-Score: ${k} � Gr��e: ${L} � ${h.toLocaleString()}`,p.appendChild(i);const _=document.createElement("ul");if(_.className="pattern-terms",(a.top_terms||[]).forEach(C=>{const e=document.createElement("li");e.textContent=C,_.appendChild(e)}),p.appendChild(_),(M=a.item_ids)!=null&&M.length){const C=document.createElement("p");C.className="pattern-items",C.textContent=`Beobachtete Items: ${a.item_ids.join(", ")}`,p.appendChild(C)}g.appendChild(p)})}async function v(){var a,p;const l=m();y("loading","Lade Muster...");try{const o=S(l),i=await fetch(`/api/patterns/latest?${o}`,{cache:"no-store",headers:{Accept:"application/json"}});if(!i.ok)throw new Error(`Server antwortete mit ${i.status}`);const h=await i.json();E(h.patterns||[]);const k=((a=h.meta)==null?void 0:a.count)??((p=h.patterns)==null?void 0:p.length)??0;y("idle",`Aktualisiert (${k}).`)}catch(o){console.error("Pattern fetch failed",o),y("error",o&&o.message?o.message:"Unbekannter Fehler")}}u.addEventListener("change",l=>{(l.target.matches("select[name='window']")||l.target.matches("input[name='limit']"))&&v()}),w.addEventListener("click",()=>{v()}),v()}function B(){var M,C;const u=document.getElementById("heatmap-filters"),g=document.getElementById("heatmap-chart"),b=document.getElementById("timeline-chart"),w=document.querySelector("#heatmap-dashboard .status-message"),y=document.querySelector("#heatmap-meta .heatmap-stats"),m=document.getElementById("heatmap-reload");if(!u||!g||!b||!w||!y||!m)return;const S=(M=window.echarts)==null?void 0:M.init(g),E=(C=window.echarts)==null?void 0:C.init(b);if(!S||!E){console.warn("ECharts not available � skipping heatmap init");return}let v=null;function l(e,d){w.dataset.state=e,w.textContent=d}function a(){const e=new FormData(u),d=e.get("interval")||"24h",f=Math.max(0,Number(e.get("value_min"))||0),c=Number(e.get("refresh"))||0,t=(e.get("sources")||"").split(",").map(n=>n.trim()).filter(Boolean);return{interval:d,valueMin:f,refresh:c,sources:t}}function p(e){const d=new URLSearchParams;return d.set("interval",e.interval),d.set("value_min",String(e.valueMin)),e.sources.length&&d.set("sources",e.sources.join(",")),d}function o(e){const d=[["Buckets",e.bucket_count??"-"],["Bucket-Minuten",e.bucket_minutes??"-"],["Items",e.item_count??0],["Alerts",e.event_count??0]];e.source_totals&&Object.entries(e.source_totals).slice(0,8).forEach(([f,c])=>d.push([f,c])),y.innerHTML=d.map(([f,c])=>`<dt>${f}</dt><dd>${c}</dd>`).join("")}function i(e){const d=e.buckets||[],f=e.series?e.series.map(r=>r.source):[];if(!d.length||!f.length){S.clear(),S.setOption({title:{text:"Keine Daten im ausgew�hlten Zeitraum",left:"center",textStyle:{color:"#64748b"}}});return}const c=d.map(r=>new Date(r).toLocaleString()),t=[];let n=0;e.series.forEach((r,s)=>{r.counts.forEach((D,I)=>{t.push([I,s,D]),D>n&&(n=D)})}),S.setOption({tooltip:{position:"top",formatter:r=>{const s=r.data[2];return s?`${f[r.data[1]]}<br>${c[r.data[0]]}<br>Events: ${s}`:"Keine Ereignisse"}},grid:{left:90,right:20,top:20,bottom:60},xAxis:{type:"category",data:c,axisLabel:{rotate:-45,color:"#475569"}},yAxis:{type:"category",data:f,axisLabel:{color:"#475569"}},visualMap:{min:0,max:Math.max(1,n),calculable:!0,orient:"horizontal",left:"center",bottom:10},series:[{name:"Events",type:"heatmap",data:t,label:{show:!0,color:"#0f172a",formatter:r=>r.data[2]?String(r.data[2]):""},emphasis:{itemStyle:{shadowBlur:10,shadowColor:"rgba(0, 0, 0, 0.5)"}}}]})}function h(e){const d=(e.timeline||[]).map(c=>({value:[c.at,c.severity||0],alert:c.alert,severity:c.severity||0}));if(!d.length){E.clear(),E.setOption({title:{text:"Keine Alerts",left:"center",textStyle:{color:"#64748b"}}});return}const f=Math.max(...d.map(c=>c.severity),1);E.setOption({tooltip:{trigger:"item",formatter:c=>{const t=new Date(c.value[0]);return`${c.data.alert}<br>${t.toLocaleString()}<br>Severity: ${c.data.severity}`}},xAxis:{type:"time",axisLabel:{color:"#475569"}},yAxis:{type:"value",min:0,max:Math.max(f,1),axisLabel:{show:!1},splitLine:{show:!1}},series:[{type:"scatter",data:d,symbolSize:c=>10+(c[1]||0)*4,itemStyle:{color:"#f97316"}}]})}function k(e){var d;i(e),h(e),o(e.meta||{}),l("idle",`Aktualisiert (${((d=e.meta)==null?void 0:d.item_count)??0} Items)`)}async function L(){const e=a(),d=p(e);l("loading","Lade Daten...");const f=await fetch(`/api/analytics/heatmap?${d.toString()}`,{cache:"no-store",headers:{Accept:"application/json"}});if(!f.ok)throw new Error(`Server antwortete mit ${f.status}`);const c=await f.json();return k(c),e}function _(){v&&(v.close(),v=null)}function x(e){if(_(),!e.refresh)return;const d=p(e);d.set("refresh",String(e.refresh)),v=new EventSource(`/stream/analytics/heatmap?${d.toString()}`),v.onmessage=f=>{try{const c=JSON.parse(f.data);if(c.error){l("error",c.error);return}k(c)}catch(c){console.error("SSE parse failed",c)}},v.onerror=()=>{l("error","Stream unterbrochen"),_()}}function $(){L().then(e=>{x(e)}).catch(e=>{console.error("Heatmap fetch failed",e),l("error",e.message||"Unbekannter Fehler")})}u.addEventListener("change",e=>{(e.target.matches("select[name='interval']")||e.target.matches("input[name='value_min']")||e.target.matches("select[name='refresh']")||e.target.matches("input[name='sources']"))&&$()}),m.addEventListener("click",()=>{$()}),window.addEventListener("beforeunload",()=>{_()}),$()}function q(){const u=document.querySelector("[data-overview-status]"),g=document.querySelector("[data-overview]");if(!u||!g)return;const b=o=>g.querySelector(`[data-metric="${o}"]`),w=document.querySelector("[data-overview-alerts]"),y=document.querySelector("[data-overview-patterns]");function m(o,i){u.dataset.state=o,u.textContent=i}async function S(o){const i=await fetch(o,{cache:"no-store",headers:{Accept:"application/json"}});if(!i.ok)throw new Error(`Request ${o} fehlgeschlagen (${i.status})`);return i.json()}function E(o,i){const h=b(o);h&&(h.textContent=i)}function v(o){if(w){if(!o.length){w.innerHTML="<li>Keine Alerts im Zeitraum.</li>";return}w.innerHTML=o.slice(-5).reverse().map(i=>{const h=new Date(i.at).toLocaleString(),k=i.severity!=null?`<span class="badge">S${i.severity}</span>`:"";return`<li><div>${i.alert} ${k}</div><small>${h}</small></li>`}).join("")}}function l(o){if(y){if(!o.length){y.innerHTML="<li>Keine Muster gefunden.</li>";return}y.innerHTML=o.slice(0,5).map(i=>{const h=i.anomaly_score!=null?i.anomaly_score.toFixed(3):"-";return`<li><div>${i.label||"Muster"}</div><small>Score ${h}</small></li>`}).join("")}}async function a(){var o,i;try{m("loading","Aktualisiere �bersicht...");const[h,k,L]=await Promise.all([S("/api/graph?limit=100&window=24h"),S("/api/analytics/heatmap?interval=24h&value_min=0"),S("/api/patterns/latest?window=24h&limit=10")]),_=new Set((h.nodes||[]).filter($=>$.kind==="source").map($=>$.id)).size;E("sources",_||0),E("items",((o=k.meta)==null?void 0:o.item_count)??0),E("alerts",((i=k.meta)==null?void 0:i.event_count)??0);const x=(L.patterns||[])[0];E("pattern-score",x&&x.anomaly_score!=null?x.anomaly_score.toFixed(3):"-"),v(k.timeline||[]),l(L.patterns||[]),m("idle","Live-Daten synchronisiert.")}catch(h){console.error("overview load failed",h),m("error",h.message||"�bersicht konnte nicht geladen werden.")}}a();const p=setInterval(a,6e4);window.addEventListener("beforeunload",()=>clearInterval(p))}const T=document.body.dataset.page||"",F={"ui.graph":A,"ui.patterns":j,"ui.heatmap":B,"ui.overview":q};function N(){const u=document.querySelector("button[data-theme-toggle]");if(!u)return;const g=window.matchMedia("(prefers-color-scheme: dark)"),b="the-watcher-theme";function w(m){document.documentElement.setAttribute("data-theme",m),u.setAttribute("aria-pressed",m==="dark"?"true":"false"),u.querySelector("span[data-role='label']").textContent=m==="dark"?"Dark":"Light"}function y(){const m=localStorage.getItem(b);return m==="light"||m==="dark"?m:g.matches?"dark":"light"}w(y()),u.addEventListener("click",()=>{const m=y()==="dark"?"light":"dark";localStorage.setItem(b,m),w(m)}),g.addEventListener("change",()=>{localStorage.getItem(b)||w(g.matches?"dark":"light")})}requestAnimationFrame(()=>{N();const u=F[T];u&&u()});
