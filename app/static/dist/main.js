function B(){const n=window.cytoscape;if(!n){console.warn("Cytoscape not available � skipping graph init");return}const r=document.getElementById("graph-filters"),y=document.getElementById("graph"),$=document.querySelector("#graph-summary .status-message"),w=document.querySelector("#graph-summary .graph-stats"),g=document.getElementById("graph-refresh"),x=document.getElementById("graph-reload"),k=document.getElementById("graph-export-png"),S=document.getElementById("graph-export-json");if(!r||!y||!$||!w)return;let f=h(y),i=null,L=null,l=!1;function h(a){return n({container:a,wheelSensitivity:.2,maxZoom:3,minZoom:.2,style:[{selector:"node",style:{label:"data(label)","text-valign":"center","text-halign":"center","font-size":"12px","text-wrap":"wrap","text-max-width":"120px",color:"#0f172a","background-color":"#2563eb",width:"mapData(value, 0, 50, 24, 96)",height:"mapData(value, 0, 50, 24, 96)","border-width":2,"border-color":"#1e293b"}},{selector:"node[kind = 'tag']",style:{"background-color":"#22c55e","border-color":"#166534"}},{selector:"node[kind = 'alert']",style:{"background-color":"#f97316","border-color":"#c2410c"}},{selector:"node:selected",style:{"border-width":4,"border-color":"#0ea5e9","shadow-blur":16,"shadow-color":"#38bdf8","shadow-opacity":.6}},{selector:"edge",style:{width:"mapData(weight, 0, 20, 1, 6)","line-color":"#94a3b8","curve-style":"bezier","target-arrow-shape":"triangle","target-arrow-color":"#94a3b8",opacity:.8}},{selector:"edge[kind = 'source_tag']",style:{"line-color":"#38bdf8","target-arrow-color":"#38bdf8"}},{selector:"edge[kind = 'source_alert']",style:{"line-color":"#facc15","target-arrow-color":"#facc15"}}]})}function b(){const a=new FormData(r),s=[];r.querySelectorAll("input[name='role']").forEach(m=>{m.checked&&s.push(m.value)});const c=Math.max(1,Math.min(Number(a.get("limit"))||50,200));return{window:a.get("window")||"24h",limit:c,roles:s,refresh:Number(a.get("refresh"))||0}}function M(a){const s=new URLSearchParams;return a.window&&s.set("window",a.window),s.set("limit",String(a.limit)),a.roles.forEach(c=>s.append("role",c)),s.toString()}function A(a,s){$.dataset.state=a,$.textContent=s}function e(a){const s=new Date,c={nodes:a.nodes.length,edges:a.edges.length,sources:a.nodes.filter(m=>m.kind==="source").length,tags:a.nodes.filter(m=>m.kind==="tag").length,alerts:a.nodes.filter(m=>m.kind==="alert").length};w.innerHTML=`
      <div><strong>Knoten:</strong> ${c.nodes}</div>
      <div><strong>Kanten:</strong> ${c.edges}</div>
      <div><strong>Quellen:</strong> ${c.sources}</div>
      <div><strong>Tags:</strong> ${c.tags}</div>
      <div><strong>Alerts:</strong> ${c.alerts}</div>
      <div><small>Stand: ${s.toLocaleTimeString()}</small></div>
    `}async function p(){if(l)return;const a=b();A("loading","Lade Graph..."),l=!0;try{const s=M(a),c=await fetch(`/api/graph?${s}`,{cache:"no-store",headers:{Accept:"application/json"}});if(!c.ok)throw new Error(`Server antwortete mit ${c.status}`);const m=await c.json();L=m,o(m),e(m),A("idle","Aktualisiert.")}catch(s){console.error("Graph fetch failed",s),A("error",s&&s.message?s.message:"Unbekannter Fehler")}finally{l=!1}}function o(a){const s=[];a.nodes.forEach(m=>{s.push({data:{id:m.id,label:m.label,kind:m.kind,value:m.value,meta:m.meta||{}}})}),a.edges.forEach(m=>{s.push({data:{id:`${m.source}->${m.target}:${m.kind}`,source:m.source,target:m.target,weight:m.weight,kind:m.kind,meta:m.meta||{}}})}),f.elements().remove(),f.add(s),f.layout({name:"cose",animate:!1,padding:30,fit:!0,randomize:s.length>150}).run()}function v(a){i&&(clearInterval(i),i=null),a>0&&(i=setInterval(()=>{document.hidden||p()},a*1e3))}function _(){const a=b();v(a.refresh)}function t(a,s){const c=document.createElement("a");c.href=s,c.download=a,document.body.appendChild(c),c.click(),document.body.removeChild(c)}function u(){if(!f)return;const a=f.png({scale:2,bg:"#ffffff"});t(`graph-${Date.now()}.png`,a)}function E(){if(!L){A("error","Keine Daten zum Exportieren verfuegbar.");return}const a=new Blob([JSON.stringify(L,null,2)],{type:"application/json"}),s=URL.createObjectURL(a);t(`graph-${Date.now()}.json`,s),setTimeout(()=>URL.revokeObjectURL(s),1e3)}function d(){r.addEventListener("change",a=>{const s=a.target;(s.matches("input[name='role']")||s.matches("select[name='window']")||s.matches("input[name='limit']"))&&p(),s===g&&_()}),x==null||x.addEventListener("click",()=>{p()}),k==null||k.addEventListener("click",()=>{u()}),S==null||S.addEventListener("click",()=>{E()}),f.on("tap","node",a=>{const s=a.target.data(),c=`${s.label} (${s.kind}) - Wert ${s.value}`;A("info",c)}),document.addEventListener("visibilitychange",()=>{document.hidden?i&&(clearInterval(i),i=null):(_(),p())})}d(),_(),p()}function T(){const n=document.getElementById("patterns-filters"),r=document.getElementById("patterns-list"),y=document.querySelector("#patterns-container .status-message"),$=document.getElementById("patterns-reload");if(!n||!r||!y||!$)return;function w(f,i){y.dataset.state=f,y.textContent=i}function g(){const f=new FormData(n),i=f.get("window")||"24h",L=Math.max(1,Math.min(Number(f.get("limit"))||10,50));return{window:i,limit:L}}function x(f){const i=new URLSearchParams;return i.set("window",f.window),i.set("limit",String(f.limit)),i.toString()}function k(f){if(r.innerHTML="",!f.length){const i=document.createElement("p");i.className="empty-state",i.textContent="Keine Muster gefunden.",r.appendChild(i);return}f.forEach(i=>{var p,o,v;const L=document.createElement("article");L.className="pattern-card";const l=document.createElement("h2");l.textContent=i.label||"Unbenanntes Muster",L.appendChild(l);const h=document.createElement("p");h.className="pattern-meta";const b=new Date(i.created_at),M=typeof i.anomaly_score=="number"?i.anomaly_score.toFixed(3):"-",A=((p=i.meta)==null?void 0:p.size)??((o=i.item_ids)==null?void 0:o.length)??0;h.textContent=`Anomalie-Score: ${M} � Gr��e: ${A} � ${b.toLocaleString()}`,L.appendChild(h);const e=document.createElement("ul");if(e.className="pattern-terms",(i.top_terms||[]).forEach(_=>{const t=document.createElement("li");t.textContent=_,e.appendChild(t)}),L.appendChild(e),(v=i.item_ids)!=null&&v.length){const _=document.createElement("p");_.className="pattern-items",_.textContent=`Beobachtete Items: ${i.item_ids.join(", ")}`,L.appendChild(_)}r.appendChild(L)})}async function S(){var i,L;const f=g();w("loading","Lade Muster...");try{const l=x(f),h=await fetch(`/api/patterns/latest?${l}`,{cache:"no-store",headers:{Accept:"application/json"}});if(!h.ok)throw new Error(`Server antwortete mit ${h.status}`);const b=await h.json();k(b.patterns||[]);const M=((i=b.meta)==null?void 0:i.count)??((L=b.patterns)==null?void 0:L.length)??0;w("idle",`Aktualisiert (${M}).`)}catch(l){console.error("Pattern fetch failed",l),w("error",l&&l.message?l.message:"Unbekannter Fehler")}}n.addEventListener("change",f=>{(f.target.matches("select[name='window']")||f.target.matches("input[name='limit']"))&&S()}),$.addEventListener("click",()=>{S()}),S()}function q(){var v,_;const n=document.getElementById("heatmap-filters"),r=document.getElementById("heatmap-chart"),y=document.getElementById("timeline-chart"),$=document.querySelector("#heatmap-dashboard .status-message"),w=document.querySelector("#heatmap-meta .heatmap-stats"),g=document.getElementById("heatmap-reload");if(!n||!r||!y||!$||!w||!g)return;const x=(v=window.echarts)==null?void 0:v.init(r),k=(_=window.echarts)==null?void 0:_.init(y);if(!x||!k){console.warn("ECharts not available � skipping heatmap init");return}let S=null;function f(t,u){$.dataset.state=t,$.textContent=u}function i(){const t=new FormData(n),u=t.get("interval")||"24h",E=Math.max(0,Number(t.get("value_min"))||0),d=Number(t.get("refresh"))||0,a=(t.get("sources")||"").split(",").map(s=>s.trim()).filter(Boolean);return{interval:u,valueMin:E,refresh:d,sources:a}}function L(t){const u=new URLSearchParams;return u.set("interval",t.interval),u.set("value_min",String(t.valueMin)),t.sources.length&&u.set("sources",t.sources.join(",")),u}function l(t){const u=[["Buckets",t.bucket_count??"-"],["Bucket-Minuten",t.bucket_minutes??"-"],["Items",t.item_count??0],["Alerts",t.event_count??0]];t.source_totals&&Object.entries(t.source_totals).slice(0,8).forEach(([E,d])=>u.push([E,d])),w.innerHTML=u.map(([E,d])=>`<dt>${E}</dt><dd>${d}</dd>`).join("")}function h(t){const u=t.buckets||[],E=t.series?t.series.map(c=>c.source):[];if(!u.length||!E.length){x.clear(),x.setOption({title:{text:"Keine Daten im ausgew�hlten Zeitraum",left:"center",textStyle:{color:"#64748b"}}});return}const d=u.map(c=>new Date(c).toLocaleString()),a=[];let s=0;t.series.forEach((c,m)=>{c.counts.forEach((D,I)=>{a.push([I,m,D]),D>s&&(s=D)})}),x.setOption({tooltip:{position:"top",formatter:c=>{const m=c.data[2];return m?`${E[c.data[1]]}<br>${d[c.data[0]]}<br>Events: ${m}`:"Keine Ereignisse"}},grid:{left:90,right:20,top:20,bottom:60},xAxis:{type:"category",data:d,axisLabel:{rotate:-45,color:"#475569"}},yAxis:{type:"category",data:E,axisLabel:{color:"#475569"}},visualMap:{min:0,max:Math.max(1,s),calculable:!0,orient:"horizontal",left:"center",bottom:10},series:[{name:"Events",type:"heatmap",data:a,label:{show:!0,color:"#0f172a",formatter:c=>c.data[2]?String(c.data[2]):""},emphasis:{itemStyle:{shadowBlur:10,shadowColor:"rgba(0, 0, 0, 0.5)"}}}]})}function b(t){const u=(t.timeline||[]).map(d=>({value:[d.at,d.severity||0],alert:d.alert,severity:d.severity||0}));if(!u.length){k.clear(),k.setOption({title:{text:"Keine Alerts",left:"center",textStyle:{color:"#64748b"}}});return}const E=Math.max(...u.map(d=>d.severity),1);k.setOption({tooltip:{trigger:"item",formatter:d=>{const a=new Date(d.value[0]);return`${d.data.alert}<br>${a.toLocaleString()}<br>Severity: ${d.data.severity}`}},xAxis:{type:"time",axisLabel:{color:"#475569"}},yAxis:{type:"value",min:0,max:Math.max(E,1),axisLabel:{show:!1},splitLine:{show:!1}},series:[{type:"scatter",data:u,symbolSize:d=>10+(d[1]||0)*4,itemStyle:{color:"#f97316"}}]})}function M(t){var u;h(t),b(t),l(t.meta||{}),f("idle",`Aktualisiert (${((u=t.meta)==null?void 0:u.item_count)??0} Items)`)}async function A(){const t=i(),u=L(t);f("loading","Lade Daten...");const E=await fetch(`/api/analytics/heatmap?${u.toString()}`,{cache:"no-store",headers:{Accept:"application/json"}});if(!E.ok)throw new Error(`Server antwortete mit ${E.status}`);const d=await E.json();return M(d),t}function e(){S&&(S.close(),S=null)}function p(t){if(e(),!t.refresh)return;const u=L(t);u.set("refresh",String(t.refresh)),S=new EventSource(`/stream/analytics/heatmap?${u.toString()}`),S.onmessage=E=>{try{const d=JSON.parse(E.data);if(d.error){f("error",d.error);return}M(d)}catch(d){console.error("SSE parse failed",d)}},S.onerror=()=>{f("error","Stream unterbrochen"),e()}}function o(){A().then(t=>{p(t)}).catch(t=>{console.error("Heatmap fetch failed",t),f("error",t.message||"Unbekannter Fehler")})}n.addEventListener("change",t=>{(t.target.matches("select[name='interval']")||t.target.matches("input[name='value_min']")||t.target.matches("select[name='refresh']")||t.target.matches("input[name='sources']"))&&o()}),g.addEventListener("click",()=>{o()}),window.addEventListener("beforeunload",()=>{e()}),o()}function F(){const n=document.querySelector("[data-overview-status]"),r=document.querySelector("[data-overview]");if(!n||!r)return;const y=l=>r.querySelector(`[data-metric="${l}"]`),$=document.querySelector("[data-overview-alerts]"),w=document.querySelector("[data-overview-patterns]");function g(l,h){n.dataset.state=l,n.textContent=h}async function x(l){const h=await fetch(l,{cache:"no-store",headers:{Accept:"application/json"}});if(!h.ok)throw new Error(`Request ${l} fehlgeschlagen (${h.status})`);return h.json()}function k(l,h){const b=y(l);b&&(b.textContent=h)}function S(l){if($){if(!l.length){$.innerHTML="<li>Keine Alerts im Zeitraum.</li>";return}$.innerHTML=l.slice(-5).reverse().map(h=>{const b=new Date(h.at).toLocaleString(),M=h.severity!=null?`<span class="badge">S${h.severity}</span>`:"";return`<li><div>${h.alert} ${M}</div><small>${b}</small></li>`}).join("")}}function f(l){if(w){if(!l.length){w.innerHTML="<li>Keine Muster gefunden.</li>";return}w.innerHTML=l.slice(0,5).map(h=>{const b=h.anomaly_score!=null?h.anomaly_score.toFixed(3):"-";return`<li><div>${h.label||"Muster"}</div><small>Score ${b}</small></li>`}).join("")}}async function i(){var l,h;try{g("loading","Aktualisiere �bersicht...");const[b,M,A]=await Promise.all([x("/api/graph?limit=100&window=24h"),x("/api/analytics/heatmap?interval=24h&value_min=0"),x("/api/patterns/latest?window=24h&limit=10")]),e=new Set((b.nodes||[]).filter(o=>o.kind==="source").map(o=>o.id)).size;k("sources",e||0),k("items",((l=M.meta)==null?void 0:l.item_count)??0),k("alerts",((h=M.meta)==null?void 0:h.event_count)??0);const p=(A.patterns||[])[0];k("pattern-score",p&&p.anomaly_score!=null?p.anomaly_score.toFixed(3):"-"),S(M.timeline||[]),f(A.patterns||[]),g("idle","Live-Daten synchronisiert.")}catch(b){console.error("overview load failed",b),g("error",b.message||"�bersicht konnte nicht geladen werden.")}}i();const L=setInterval(i,6e4);window.addEventListener("beforeunload",()=>clearInterval(L))}const P={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"};function N(n){return n==null?"":String(n).replace(/[&<>"']/g,r=>P[r]||r)}function C(n){if(!n)return"-";const r=new Date(n);return Number.isNaN(r.getTime())?n:r.toLocaleString()}function j(n){const r=new URLSearchParams;return r.set("limit",String(n.limit)),n.sources.length&&r.set("sources",n.sources.join(",")),n.since&&r.set("since",n.since),r}function O(n){const r=Number(n);return Number.isNaN(r)||r<=0?50:Math.max(1,Math.min(r,200))}function H(n){const r=Number(n);return Number.isNaN(r)||r<0?0:Math.min(r,300)}function R(n){if(!n)return"";const r=N(n.label||"Tag");if(n.weight==null)return r;const y=Number(n.weight);return Number.isNaN(y)?r:`${r} (${y.toFixed(2)})`}function U(n){if(!n)return"";const r=Object.entries(n);if(!r.length)return"";const y=r.map(([w,g])=>[w,Number(g)]).filter(([,w])=>!Number.isNaN(w)).sort((w,g)=>g[1]-w[1]).slice(0,4);return y.length?`<div class="feed-gematria">${y.map(([w,g])=>`<span>${N(w)}: <strong>${g}</strong></span>`).join("")}</div>`:""}function z(){const n=document.getElementById("stream-filters"),r=document.querySelector("[data-stream-status]"),y=document.querySelector("[data-stream-list]"),$=document.querySelector("[data-stream-meta]"),w=document.getElementById("stream-reload"),g=document.querySelector("[data-stream-region]");if(!n||!r||!y||!$||!w)return;let x=null;function k(e){g&&g.setAttribute("aria-busy",e?"true":"false")}function S(e,p){r.dataset.state=e,r.textContent=p}function f(){const e=new FormData(n),p=(e.get("sources")||"").split(",").map(u=>u.trim()).filter(Boolean),o=O(e.get("limit")),v=H(e.get("refresh")),_=e.get("since"),t=_?String(_):"";return{sources:p,limit:o,refresh:v,since:t}}function i(e={}){const p=e.count??0,o=e.latest_fetched_at?C(e.latest_fetched_at):"-",v=e.since?C(e.since):"",_=Array.isArray(e.sources)&&e.sources.length?e.sources.join(", "):"-",t=[["Items",p],["Aktualisiert",o],["Quellen",_]];v&&t.push(["Seit",v]),$.innerHTML=t.map(([u,E])=>`<dt>${N(u)}</dt><dd>${N(E)}</dd>`).join("")}function L(e=[]){if(!Array.isArray(e)||!e.length){y.innerHTML='<li class="empty-state">Keine Items gefunden.</li>';return}const p=e.map(o=>{const v=N(o.title||"Ohne Titel"),_=o.source?`<span class="feed-item-source">${N(o.source)}</span>`:"",t=o.url?`<a href="${N(o.url)}" target="_blank" rel="noopener">${v}</a>`:`<span>${v}</span>`,u=o.published_at?C(o.published_at):"-",E=o.fetched_at?C(o.fetched_at):"-",d=o.lang?`Sprache: ${N(o.lang)}`:"",a=o.author?`Autor: ${N(o.author)}`:"",s=Array.isArray(o.tags)?o.tags.map(I=>`<li>${R(I)}</li>`).join(""):"",c=s?`<ul class="feed-tags">${s}</ul>`:"",m=U(o.gematria),D=[`Eingelesen: ${E}`,`Publiziert: ${u}`];return d&&D.push(d),a&&D.push(a),`
          <li class="feed-item">
            <div class="feed-item-header">
              <h2 class="feed-item-title">${t}</h2>
              ${_}
            </div>
            <div class="feed-item-meta">${D.map(N).join(" · ")}</div>
            ${m}
            ${c}
          </li>
        `}).join("");y.innerHTML=p}function l(e){var v;const p=(e==null?void 0:e.items)||[];L(p),i((e==null?void 0:e.meta)||{});const o=((v=e==null?void 0:e.meta)==null?void 0:v.count)??p.length;S("idle",`Live-Daten aktualisiert (${o} Items)`),k(!1)}async function h(){const e=f(),p=j(e);S("loading","Lade Items..."),k(!0);const o=await fetch(`/api/items?${p.toString()}`,{cache:"no-store",headers:{Accept:"application/json"}});if(!o.ok)throw new Error(`Server antwortete mit ${o.status}`);const v=await o.json();return l(v),e}function b(){x&&(x.close(),x=null)}function M(e){if(b(),!e.refresh)return;const p=j(e);p.set("refresh",String(e.refresh)),x=new EventSource(`/stream/items?${p.toString()}`),x.onmessage=o=>{try{const v=JSON.parse(o.data);if(v.error){S("error",v.error),k(!1);return}l(v)}catch(v){console.error("Stream parse failed",v),S("error","Stream-Daten konnten nicht verarbeitet werden."),k(!1)}},x.onerror=()=>{S("error","Stream unterbrochen"),k(!1),b()}}function A(){h().then(e=>{M(e)}).catch(e=>{console.error("Stream fetch failed",e),S("error",e.message||"Unbekannter Fehler"),k(!1),b()})}n.addEventListener("change",e=>{(e.target.matches("input[name='sources']")||e.target.matches("select[name='limit']")||e.target.matches("select[name='refresh']")||e.target.matches("input[name='since']"))&&A()}),w.addEventListener("click",()=>{A()}),window.addEventListener("beforeunload",()=>{b()}),A()}const K=document.body.dataset.page||"",G={"ui.graph":B,"ui.patterns":T,"ui.heatmap":q,"ui.overview":F,"ui.stream":z};function Q(){const n=document.querySelector("button[data-theme-toggle]");if(!n)return;const r=window.matchMedia("(prefers-color-scheme: dark)"),y="the-watcher-theme";function $(g){document.documentElement.setAttribute("data-theme",g),n.setAttribute("aria-pressed",g==="dark"?"true":"false"),n.querySelector("span[data-role='label']").textContent=g==="dark"?"Dark":"Light"}function w(){const g=localStorage.getItem(y);return g==="light"||g==="dark"?g:r.matches?"dark":"light"}$(w()),n.addEventListener("click",()=>{const g=w()==="dark"?"light":"dark";localStorage.setItem(y,g),$(g)}),r.addEventListener("change",()=>{localStorage.getItem(y)||$(r.matches?"dark":"light")})}requestAnimationFrame(()=>{Q();const n=G[K];n&&n()});
