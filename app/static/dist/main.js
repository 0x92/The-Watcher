function B(){const e=window.cytoscape;if(!e){console.warn("Cytoscape not available � skipping graph init");return}const n=document.getElementById("graph-filters"),a=document.getElementById("graph"),o=document.querySelector("#graph-summary .status-message"),m=document.querySelector("#graph-summary .graph-stats"),c=document.getElementById("graph-refresh"),w=document.getElementById("graph-reload"),d=document.getElementById("graph-export-png"),g=document.getElementById("graph-export-json");if(!n||!a||!o||!m)return;let f=r(a),l=null,L=null,p=!1;function r(u){return e({container:u,wheelSensitivity:.2,maxZoom:3,minZoom:.2,style:[{selector:"node",style:{label:"data(label)","text-valign":"center","text-halign":"center","font-size":"12px","text-wrap":"wrap","text-max-width":"120px",color:"#0f172a","background-color":"#2563eb",width:"mapData(value, 0, 50, 24, 96)",height:"mapData(value, 0, 50, 24, 96)","border-width":2,"border-color":"#1e293b"}},{selector:"node[kind = 'tag']",style:{"background-color":"#22c55e","border-color":"#166534"}},{selector:"node[kind = 'alert']",style:{"background-color":"#f97316","border-color":"#c2410c"}},{selector:"node:selected",style:{"border-width":4,"border-color":"#0ea5e9","shadow-blur":16,"shadow-color":"#38bdf8","shadow-opacity":.6}},{selector:"edge",style:{width:"mapData(weight, 0, 20, 1, 6)","line-color":"#94a3b8","curve-style":"bezier","target-arrow-shape":"triangle","target-arrow-color":"#94a3b8",opacity:.8}},{selector:"edge[kind = 'source_tag']",style:{"line-color":"#38bdf8","target-arrow-color":"#38bdf8"}},{selector:"edge[kind = 'source_alert']",style:{"line-color":"#facc15","target-arrow-color":"#facc15"}}]})}function t(){const u=new FormData(n),h=[];n.querySelectorAll("input[name='role']").forEach(S=>{S.checked&&h.push(S.value)});const b=Math.max(1,Math.min(Number(u.get("limit"))||50,200));return{window:u.get("window")||"24h",limit:b,roles:h,refresh:Number(u.get("refresh"))||0}}function i(u){const h=new URLSearchParams;return u.window&&h.set("window",u.window),h.set("limit",String(u.limit)),u.roles.forEach(b=>h.append("role",b)),h.toString()}function E(u,h){o.dataset.state=u,o.textContent=h}function $(u){const h=new Date,b={nodes:u.nodes.length,edges:u.edges.length,sources:u.nodes.filter(S=>S.kind==="source").length,tags:u.nodes.filter(S=>S.kind==="tag").length,alerts:u.nodes.filter(S=>S.kind==="alert").length};m.innerHTML=`
      <div><strong>Knoten:</strong> ${b.nodes}</div>
      <div><strong>Kanten:</strong> ${b.edges}</div>
      <div><strong>Quellen:</strong> ${b.sources}</div>
      <div><strong>Tags:</strong> ${b.tags}</div>
      <div><strong>Alerts:</strong> ${b.alerts}</div>
      <div><small>Stand: ${h.toLocaleTimeString()}</small></div>
    `}async function y(){if(p)return;const u=t();E("loading","Lade Graph..."),p=!0;try{const h=i(u),b=await fetch(`/api/graph?${h}`,{cache:"no-store",headers:{Accept:"application/json"}});if(!b.ok)throw new Error(`Server antwortete mit ${b.status}`);const S=await b.json();L=S,_(S),$(S),E("idle","Aktualisiert.")}catch(h){console.error("Graph fetch failed",h),E("error",h&&h.message?h.message:"Unbekannter Fehler")}finally{p=!1}}function _(u){const h=[];u.nodes.forEach(S=>{h.push({data:{id:S.id,label:S.label,kind:S.kind,value:S.value,meta:S.meta||{}}})}),u.edges.forEach(S=>{h.push({data:{id:`${S.source}->${S.target}:${S.kind}`,source:S.source,target:S.target,weight:S.weight,kind:S.kind,meta:S.meta||{}}})}),f.elements().remove(),f.add(h),f.layout({name:"cose",animate:!1,padding:30,fit:!0,randomize:h.length>150}).run()}function x(u){l&&(clearInterval(l),l=null),u>0&&(l=setInterval(()=>{document.hidden||y()},u*1e3))}function A(){const u=t();x(u.refresh)}function s(u,h){const b=document.createElement("a");b.href=h,b.download=u,document.body.appendChild(b),b.click(),document.body.removeChild(b)}function v(){if(!f)return;const u=f.png({scale:2,bg:"#ffffff"});s(`graph-${Date.now()}.png`,u)}function C(){if(!L){E("error","Keine Daten zum Exportieren verfuegbar.");return}const u=new Blob([JSON.stringify(L,null,2)],{type:"application/json"}),h=URL.createObjectURL(u);s(`graph-${Date.now()}.json`,h),setTimeout(()=>URL.revokeObjectURL(h),1e3)}function k(){n.addEventListener("change",u=>{const h=u.target;(h.matches("input[name='role']")||h.matches("select[name='window']")||h.matches("input[name='limit']"))&&y(),h===c&&A()}),w==null||w.addEventListener("click",()=>{y()}),d==null||d.addEventListener("click",()=>{v()}),g==null||g.addEventListener("click",()=>{C()}),f.on("tap","node",u=>{const h=u.target.data(),b=`${h.label} (${h.kind}) - Wert ${h.value}`;E("info",b)}),document.addEventListener("visibilitychange",()=>{document.hidden?l&&(clearInterval(l),l=null):(A(),y())})}k(),A(),y()}function U(){const e=document.getElementById("patterns-filters"),n=document.getElementById("patterns-list"),a=document.querySelector("#patterns-container .status-message"),o=document.getElementById("patterns-reload");if(!e||!n||!a||!o)return;function m(f,l){a.dataset.state=f,a.textContent=l}function c(){const f=new FormData(e),l=f.get("window")||"24h",L=Math.max(1,Math.min(Number(f.get("limit"))||10,50));return{window:l,limit:L}}function w(f){const l=new URLSearchParams;return l.set("window",f.window),l.set("limit",String(f.limit)),l.toString()}function d(f){if(n.innerHTML="",!f.length){const l=document.createElement("p");l.className="empty-state",l.textContent="Keine Muster gefunden.",n.appendChild(l);return}f.forEach(l=>{var y,_,x;const L=document.createElement("article");L.className="pattern-card";const p=document.createElement("h2");p.textContent=l.label||"Unbenanntes Muster",L.appendChild(p);const r=document.createElement("p");r.className="pattern-meta";const t=new Date(l.created_at),i=typeof l.anomaly_score=="number"?l.anomaly_score.toFixed(3):"-",E=((y=l.meta)==null?void 0:y.size)??((_=l.item_ids)==null?void 0:_.length)??0;r.textContent=`Anomalie-Score: ${i} � Gr��e: ${E} � ${t.toLocaleString()}`,L.appendChild(r);const $=document.createElement("ul");if($.className="pattern-terms",(l.top_terms||[]).forEach(A=>{const s=document.createElement("li");s.textContent=A,$.appendChild(s)}),L.appendChild($),(x=l.item_ids)!=null&&x.length){const A=document.createElement("p");A.className="pattern-items",A.textContent=`Beobachtete Items: ${l.item_ids.join(", ")}`,L.appendChild(A)}n.appendChild(L)})}async function g(){var l,L;const f=c();m("loading","Lade Muster...");try{const p=w(f),r=await fetch(`/api/patterns/latest?${p}`,{cache:"no-store",headers:{Accept:"application/json"}});if(!r.ok)throw new Error(`Server antwortete mit ${r.status}`);const t=await r.json();d(t.patterns||[]);const i=((l=t.meta)==null?void 0:l.count)??((L=t.patterns)==null?void 0:L.length)??0;m("idle",`Aktualisiert (${i}).`)}catch(p){console.error("Pattern fetch failed",p),m("error",p&&p.message?p.message:"Unbekannter Fehler")}}e.addEventListener("change",f=>{(f.target.matches("select[name='window']")||f.target.matches("input[name='limit']"))&&g()}),o.addEventListener("click",()=>{g()}),g()}function z(){var x,A;const e=document.getElementById("heatmap-filters"),n=document.getElementById("heatmap-chart"),a=document.getElementById("timeline-chart"),o=document.querySelector("#heatmap-dashboard .status-message"),m=document.querySelector("#heatmap-meta .heatmap-stats"),c=document.getElementById("heatmap-reload");if(!e||!n||!a||!o||!m||!c)return;const w=(x=window.echarts)==null?void 0:x.init(n),d=(A=window.echarts)==null?void 0:A.init(a);if(!w||!d){console.warn("ECharts not available � skipping heatmap init");return}let g=null;function f(s,v){o.dataset.state=s,o.textContent=v}function l(){const s=new FormData(e),v=s.get("interval")||"24h",C=Math.max(0,Number(s.get("value_min"))||0),k=Number(s.get("refresh"))||0,u=(s.get("sources")||"").split(",").map(h=>h.trim()).filter(Boolean);return{interval:v,valueMin:C,refresh:k,sources:u}}function L(s){const v=new URLSearchParams;return v.set("interval",s.interval),v.set("value_min",String(s.valueMin)),s.sources.length&&v.set("sources",s.sources.join(",")),v}function p(s){const v=[["Buckets",s.bucket_count??"-"],["Bucket-Minuten",s.bucket_minutes??"-"],["Items",s.item_count??0],["Alerts",s.event_count??0]];s.source_totals&&Object.entries(s.source_totals).slice(0,8).forEach(([C,k])=>v.push([C,k])),m.innerHTML=v.map(([C,k])=>`<dt>${C}</dt><dd>${k}</dd>`).join("")}function r(s){const v=s.buckets||[],C=s.series?s.series.map(b=>b.source):[];if(!v.length||!C.length){w.clear(),w.setOption({title:{text:"Keine Daten im ausgew�hlten Zeitraum",left:"center",textStyle:{color:"#64748b"}}});return}const k=v.map(b=>new Date(b).toLocaleString()),u=[];let h=0;s.series.forEach((b,S)=>{b.counts.forEach((T,F)=>{u.push([F,S,T]),T>h&&(h=T)})}),w.setOption({tooltip:{position:"top",formatter:b=>{const S=b.data[2];return S?`${C[b.data[1]]}<br>${k[b.data[0]]}<br>Events: ${S}`:"Keine Ereignisse"}},grid:{left:90,right:20,top:20,bottom:60},xAxis:{type:"category",data:k,axisLabel:{rotate:-45,color:"#475569"}},yAxis:{type:"category",data:C,axisLabel:{color:"#475569"}},visualMap:{min:0,max:Math.max(1,h),calculable:!0,orient:"horizontal",left:"center",bottom:10},series:[{name:"Events",type:"heatmap",data:u,label:{show:!0,color:"#0f172a",formatter:b=>b.data[2]?String(b.data[2]):""},emphasis:{itemStyle:{shadowBlur:10,shadowColor:"rgba(0, 0, 0, 0.5)"}}}]})}function t(s){const v=(s.timeline||[]).map(k=>({value:[k.at,k.severity||0],alert:k.alert,severity:k.severity||0}));if(!v.length){d.clear(),d.setOption({title:{text:"Keine Alerts",left:"center",textStyle:{color:"#64748b"}}});return}const C=Math.max(...v.map(k=>k.severity),1);d.setOption({tooltip:{trigger:"item",formatter:k=>{const u=new Date(k.value[0]);return`${k.data.alert}<br>${u.toLocaleString()}<br>Severity: ${k.data.severity}`}},xAxis:{type:"time",axisLabel:{color:"#475569"}},yAxis:{type:"value",min:0,max:Math.max(C,1),axisLabel:{show:!1},splitLine:{show:!1}},series:[{type:"scatter",data:v,symbolSize:k=>10+(k[1]||0)*4,itemStyle:{color:"#f97316"}}]})}function i(s){var v;r(s),t(s),p(s.meta||{}),f("idle",`Aktualisiert (${((v=s.meta)==null?void 0:v.item_count)??0} Items)`)}async function E(){const s=l(),v=L(s);f("loading","Lade Daten...");const C=await fetch(`/api/analytics/heatmap?${v.toString()}`,{cache:"no-store",headers:{Accept:"application/json"}});if(!C.ok)throw new Error(`Server antwortete mit ${C.status}`);const k=await C.json();return i(k),s}function $(){g&&(g.close(),g=null)}function y(s){if($(),!s.refresh)return;const v=L(s);v.set("refresh",String(s.refresh)),g=new EventSource(`/stream/analytics/heatmap?${v.toString()}`),g.onmessage=C=>{try{const k=JSON.parse(C.data);if(k.error){f("error",k.error);return}i(k)}catch(k){console.error("SSE parse failed",k)}},g.onerror=()=>{f("error","Stream unterbrochen"),$()}}function _(){E().then(s=>{y(s)}).catch(s=>{console.error("Heatmap fetch failed",s),f("error",s.message||"Unbekannter Fehler")})}e.addEventListener("change",s=>{(s.target.matches("select[name='interval']")||s.target.matches("input[name='value_min']")||s.target.matches("select[name='refresh']")||s.target.matches("input[name='sources']"))&&_()}),c.addEventListener("click",()=>{_()}),window.addEventListener("beforeunload",()=>{$()}),_()}function H(){const e=document.querySelector("[data-overview-status]"),n=document.querySelector("[data-overview]");if(!e||!n)return;const a=p=>n.querySelector(`[data-metric="${p}"]`),o=document.querySelector("[data-overview-alerts]"),m=document.querySelector("[data-overview-patterns]");function c(p,r){e.dataset.state=p,e.textContent=r}async function w(p){const r=await fetch(p,{cache:"no-store",headers:{Accept:"application/json"}});if(!r.ok)throw new Error(`Request ${p} fehlgeschlagen (${r.status})`);return r.json()}function d(p,r){const t=a(p);t&&(t.textContent=r)}function g(p){if(o){if(!p.length){o.innerHTML="<li>Keine Alerts im Zeitraum.</li>";return}o.innerHTML=p.slice(-5).reverse().map(r=>{const t=new Date(r.at).toLocaleString(),i=r.severity!=null?`<span class="badge">S${r.severity}</span>`:"";return`<li><div>${r.alert} ${i}</div><small>${t}</small></li>`}).join("")}}function f(p){if(m){if(!p.length){m.innerHTML="<li>Keine Muster gefunden.</li>";return}m.innerHTML=p.slice(0,5).map(r=>{const t=r.anomaly_score!=null?r.anomaly_score.toFixed(3):"-";return`<li><div>${r.label||"Muster"}</div><small>Score ${t}</small></li>`}).join("")}}async function l(){var p,r;try{c("loading","Aktualisiere �bersicht...");const[t,i,E]=await Promise.all([w("/api/graph?limit=100&window=24h"),w("/api/analytics/heatmap?interval=24h&value_min=0"),w("/api/patterns/latest?window=24h&limit=10")]),$=new Set((t.nodes||[]).filter(_=>_.kind==="source").map(_=>_.id)).size;d("sources",$||0),d("items",((p=i.meta)==null?void 0:p.item_count)??0),d("alerts",((r=i.meta)==null?void 0:r.event_count)??0);const y=(E.patterns||[])[0];d("pattern-score",y&&y.anomaly_score!=null?y.anomaly_score.toFixed(3):"-"),g(i.timeline||[]),f(E.patterns||[]),c("idle","Live-Daten synchronisiert.")}catch(t){console.error("overview load failed",t),c("error",t.message||"�bersicht konnte nicht geladen werden.")}}l();const L=setInterval(l,6e4);window.addEventListener("beforeunload",()=>clearInterval(L))}const O="/api/admin/worker-settings",D="/api/admin/sources";function N(e,n,a="idle"){e&&(e.textContent=n,e.dataset.state=a,e.hidden=!n)}function j(e){const n=Number.parseInt(e,10);return Number.isNaN(n)?void 0:n}function Q(){const e=document.querySelector("[data-worker-form]"),n=document.querySelector("[data-worker-status]"),a=document.querySelector("[data-source-form]"),o=document.querySelector("[data-source-status]"),m=document.querySelector("[data-sources-list]");if(!e&&!a&&!m)return;let c=[];async function w(){if(e){N(n,"Lade Einstellungen…","loading");try{const r=await fetch(O,{credentials:"same-origin"});if(!r.ok)throw new Error(`Serverfehler (${r.status})`);const t=await r.json();e.elements.scrape_enabled.checked=!!t.scrape_enabled,e.elements.default_interval_minutes.value=t.default_interval_minutes??15,e.elements.max_sources_per_cycle.value=t.max_sources_per_cycle??0,a&&a.elements.interval_minutes.value===""&&(a.elements.interval_minutes.placeholder=t.default_interval_minutes??""),N(n,"","idle")}catch(r){N(n,r.message||"Einstellungen konnten nicht geladen werden","error")}}}async function d(r){if(r.preventDefault(),!e)return;N(n,"Speichere…","loading");const t={scrape_enabled:e.elements.scrape_enabled.checked,default_interval_minutes:j(e.elements.default_interval_minutes.value),max_sources_per_cycle:j(e.elements.max_sources_per_cycle.value)};try{const i=await fetch(O,{method:"PUT",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!i.ok)throw new Error(`Serverfehler (${i.status})`);await i.json(),N(n,"Einstellungen gespeichert","success")}catch(i){N(n,i.message||"Speichern fehlgeschlagen","error")}}async function g(){if(m){N(o,"Lade Quellen…","loading");try{const r=await fetch(D,{credentials:"same-origin"});if(!r.ok)throw new Error(`Serverfehler (${r.status})`);const t=await r.json();c=Array.isArray(t)?t:[],f(),N(o,"","idle")}catch(r){N(o,r.message||"Quellen konnten nicht geladen werden","error")}}}function f(){if(!m)return;if(!c.length){m.innerHTML='<p class="sources-empty">Noch keine Quellen hinterlegt.</p>';return}const r=c.map(t=>{const i=t.enabled?"Aktiv":"Deaktiviert",E=t.enabled?"Deaktivieren":"Aktivieren",$=t.interval_minutes??0,y=t.last_run_at?new Date(t.last_run_at).toLocaleString():"–";return`
          <tr data-source-id="${t.id}">
            <td>${t.name}</td>
            <td>${t.type.toUpperCase()}</td>
            <td><a href="${t.endpoint}" target="_blank" rel="noopener">${t.endpoint}</a></td>
            <td>${$} min</td>
            <td>${i}</td>
            <td>${y}</td>
            <td class="actions">
              <button type="button" class="button" data-action="toggle" data-id="${t.id}">${E}</button>
              <button type="button" class="button" data-action="delete" data-id="${t.id}">Entfernen</button>
            </td>
          </tr>
        `}).join("");m.innerHTML=`
      <div class="table-wrapper">
        <table class="sources-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Typ</th>
              <th>Feed</th>
              <th>Intervall</th>
              <th>Status</th>
              <th>Letzter Lauf</th>
              <th>Aktionen</th>
            </tr>
          </thead>
          <tbody>${r}</tbody>
        </table>
      </div>
    `}async function l(r){if(r.preventDefault(),!a)return;N(o,"Speichere Quelle…","loading");const t={name:a.elements.name.value,type:a.elements.type.value,endpoint:a.elements.endpoint.value,enabled:a.elements.enabled.checked},i=j(a.elements.interval_minutes.value);i!==void 0&&(t.interval_minutes=i);try{const E=await fetch(D,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!E.ok)throw new Error(`Serverfehler (${E.status})`);await E.json(),a.reset(),N(o,"Quelle gespeichert","success"),await g()}catch(E){N(o,E.message||"Quelle konnte nicht gespeichert werden","error")}}async function L(r){const t=c.find(i=>i.id===r);if(t){N(o,"Aktualisiere Quelle…","loading");try{const i=await fetch(`${D}/${r}`,{method:"PUT",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify({enabled:!t.enabled})});if(!i.ok)throw new Error(`Serverfehler (${i.status})`);await i.json(),N(o,"Quelle aktualisiert","success"),await g()}catch(i){N(o,i.message||"Aktualisierung fehlgeschlagen","error")}}}async function p(r){N(o,"Lösche Quelle…","loading");try{const t=await fetch(`${D}/${r}`,{method:"DELETE",credentials:"same-origin"});if(!t.ok)throw new Error(`Serverfehler (${t.status})`);N(o,"Quelle entfernt","success"),await g()}catch(t){N(o,t.message||"Quelle konnte nicht entfernt werden","error")}}e&&(e.addEventListener("submit",d),w()),a&&a.addEventListener("submit",l),m&&(m.addEventListener("click",r=>{const t=r.target.closest("[data-action]");if(!t)return;const i=Number.parseInt(t.dataset.id,10);Number.isNaN(i)||(t.dataset.action==="toggle"?L(i):t.dataset.action==="delete"&&p(i))}),g())}const R=25,K=20,G=120;function M(e){const n=Date.now()-e.getTime();if(Number.isNaN(n))return"";const a=60*1e3,o=60*a,m=24*o;return n<a?"gerade eben":n<o?`${Math.round(n/a)} Min.`:n<m?`${Math.round(n/o)} Std.`:`${Math.round(n/m)} Tg.`}function J(e){if(!e)return null;const n=Date.now();if(e.endsWith("h")&&Number.isFinite(Number.parseInt(e,10))){const a=Number.parseInt(e,10);return new Date(n-a*60*60*1e3).toISOString()}if(e.endsWith("d")&&Number.isFinite(Number.parseInt(e,10))){const a=Number.parseInt(e,10);return new Date(n-a*24*60*60*1e3).toISOString()}return null}function Z(e){const n=new FormData(e),a=new URLSearchParams,o=n.get("range"),m=J(typeof o=="string"?o:"");m&&a.set("from",m);for(const[c,w]of n.entries())!w||c==="range"||a.set(c,w);return a.set("page","1"),a.set("size",String(R)),a}function P(e,n){e&&(e.textContent=`${n} ${n===1?"Eintrag":"Einträge"}`)}function I(e,n,a){e&&(e.dataset.state=n,e.textContent=a)}function V(e){const n=document.createElement("li");n.className="feed-item",n.dataset.itemId=String(e.id||"");const a=e.fetched_at?new Date(e.fetched_at):null,o=document.createElement("div");o.className="feed-item__meta";const m=document.createElement("span");if(m.className="feed-item__source",m.textContent=e.source||"Quelle unbekannt",o.appendChild(m),e.lang){const d=document.createElement("span");d.className="feed-item__lang",d.textContent=e.lang,o.appendChild(d)}if(a){const d=document.createElement("span");d.className="feed-item__time",d.dataset.fetchedAt=a.toISOString(),d.textContent=M(a),d.title=a.toLocaleString(),o.appendChild(d)}n.appendChild(o);const c=document.createElement("h3");c.className="feed-item__title";const w=document.createElement("a");if(w.href=e.url||"#",w.target="_blank",w.rel="noopener noreferrer",w.textContent=e.title||e.url||"Unbenanntes Item",c.appendChild(w),n.appendChild(c),e.published_at){const d=document.createElement("div");d.className="feed-item__time";const g=new Date(e.published_at);d.dataset.publishedAt=g.toISOString(),d.textContent=`Publiziert ${M(g)}`,d.title=g.toLocaleString(),n.appendChild(d)}if(e.gematria&&typeof e.gematria=="object"){const d=Object.entries(e.gematria);if(d.length){d.sort((f,l)=>f[0].localeCompare(l[0]));const g=document.createElement("ul");g.className="feed-item__gematria";for(const[f,l]of d){const L=document.createElement("li");L.textContent=`${f}: ${l}`,g.appendChild(L)}n.appendChild(g)}}return n}function q(e){e.querySelectorAll(".feed-item__time[data-fetched-at]").forEach(o=>{const m=o.dataset.fetchedAt;if(!m)return;const c=new Date(m);o.textContent=M(c)}),e.querySelectorAll(".feed-item__time[data-published-at]").forEach(o=>{const m=o.dataset.publishedAt;if(!m)return;const c=new Date(m);o.textContent=`Publiziert ${M(c)}`})}function W(){const e=document.querySelector("[data-stream-feed]"),n=document.querySelector("[data-stream-list]"),a=document.querySelector("[data-stream-filter]"),o=document.querySelector("[data-stream-status]"),m=document.querySelector("[data-stream-counter]");if(!e||!n||!a||!o)return;const c=new Set;let w=null,d=null,g=null;function f(){w&&(w.close(),w=null)}function l(t,{replace:i=!1,prepend:E=!1}={}){if(!Array.isArray(t))return;if(i&&(c.clear(),n.innerHTML="",d=null),!t.length){n.setAttribute("aria-busy","false"),n.children.length||(n.innerHTML='<li class="empty-state">Keine Einträge gefunden.</li>');return}n.querySelector(".empty-state")&&(n.innerHTML="");const $=E?[...t].reverse():t;for(const y of $){if(!y||typeof y.id>"u"||c.has(y.id))continue;const _=V(y);E?n.prepend(_):n.append(_),c.add(y.id)}for(;n.children.length>G;){const y=n.lastElementChild;if(!y)break;const _=Number.parseInt(y.dataset.itemId||"",10);Number.isNaN(_)||c.delete(_),n.removeChild(y)}n.setAttribute("aria-busy","false"),P(m,c.size)}async function L(t){const i=new URL("/api/items",window.location.origin);i.search=t.toString(),n.setAttribute("aria-busy","true");const E=await fetch(i.toString(),{headers:{Accept:"application/json"},cache:"no-store"});if(!E.ok){let _=`Request ${i.pathname} fehlgeschlagen (${E.status})`;try{const x=await E.json();x&&typeof x.error=="string"&&(_=x.error)}catch(x){console.warn("Could not parse error payload",x)}throw new Error(_)}const $=await E.json(),y=Array.isArray($.items)?$.items:[];return l(y,{replace:!0}),d=y.reduce((_,x)=>x&&x.id>_?x.id:_,d||0),P(m,c.size),$}function p(t){f();const i=new URLSearchParams(t);i.set("limit",String(K)),d&&i.set("after_id",String(d));const E=`/stream/live?${i.toString()}`;w=new EventSource(E),w.onopen=()=>{I(o,"idle","Live-Verbindung aktiv.")},w.onerror=()=>{I(o,"loading","Verbindung unterbrochen, versuche erneut...")},w.onmessage=$=>{if($.data)try{const y=JSON.parse($.data),_=Array.isArray(y.items)?y.items:[];if(!_.length)return;l(_,{prepend:!0});const x=_.reduce((s,v)=>v&&v.id>s?v.id:s,0),A=typeof y.cursor=="number"?y.cursor:0;d=Math.max(d||0,x,A)}catch(y){console.error("stream payload parse failed",y)}}}async function r(){try{f(),g&&(clearInterval(g),g=null),I(o,"loading","Aktualisiere Live-Feed...");const t=Z(a);t.set("size",String(R));const i=await L(t);(Array.isArray(i.items)?i.items.length:0)?I(o,"idle","Live-Daten synchronisiert."):I(o,"idle","Keine Items im Zeitraum gefunden."),p(t),g=window.setInterval(()=>q(n),6e4),q(n)}catch(t){console.error("stream load failed",t),I(o,"error",t.message||"Live-Feed konnte nicht geladen werden.")}}a.addEventListener("submit",t=>{t.preventDefault(),r()}),a.addEventListener("reset",()=>{window.setTimeout(()=>{r()},0)}),r(),window.addEventListener("beforeunload",()=>{f(),g&&clearInterval(g)}),e.addEventListener("mouseleave",()=>q(n))}const X=document.body.dataset.page||"",Y={"ui.graph":B,"ui.patterns":U,"ui.heatmap":z,"ui.overview":H,"ui.admin":Q,"ui.stream":W};function ee(){const e=document.querySelector("button[data-theme-toggle]");if(!e)return;const n=window.matchMedia("(prefers-color-scheme: dark)"),a="the-watcher-theme";function o(c){document.documentElement.setAttribute("data-theme",c),e.setAttribute("aria-pressed",c==="dark"?"true":"false"),e.querySelector("span[data-role='label']").textContent=c==="dark"?"Dark":"Light"}function m(){const c=localStorage.getItem(a);return c==="light"||c==="dark"?c:n.matches?"dark":"light"}o(m()),e.addEventListener("click",()=>{const c=m()==="dark"?"light":"dark";localStorage.setItem(a,c),o(c)}),n.addEventListener("change",()=>{localStorage.getItem(a)||o(n.matches?"dark":"light")})}requestAnimationFrame(()=>{ee();const e=Y[X];e&&e()});
